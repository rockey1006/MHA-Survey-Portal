<!-- app/views/dashboards/student.html.erb -->
<main class="main-content">
  <%= render "shared/role_switcher" %>
  
  <div class="dashboard-grid dashboard-grid-2">
    <div class="dashboard-column">
      <!-- To-Do Section -->
      <section class="c-card c-card--hover">
        <h2 class="section-title">
          <div class="section-icon"></div>
          To-do
        </h2>
        
        <div class="u-stack u-stack--md">
          <% if @pending_surveys.present? %>
            <% @pending_surveys.each do |entry| %>
              <% survey = entry[:survey] %>
              <% offering = @offerings_by_survey_id[survey.id] %>
              <div class="c-list-item">
                <div class="c-icon--survey" aria-hidden="true"></div>
                <div class="survey-title"><%= survey.title %></div>
                <% if survey.semester.present? %>
                  <div class="survey-meta" style="font-size: 0.85rem; color: #4b5563;">
                    Semester: <%= survey.semester %>
                  </div>
                <% end %>
                <% if (review_note = review_meetings_note(offering)).present? %>
                  <div class="survey-meta" style="font-size: 0.85rem; color: #4b5563;">
                    Review meetings: <%= review_note %>
                  </div>
                <% end %>
                <% progress = entry[:progress] || {} %>
                <div class="survey-meta">
                  Status: <%= entry[:status] %>
                  &bull;
                  <%= survey_availability_note(entry[:available_until]) %>
                  <% total_questions = progress[:total_questions].to_i %>
                  <% answered_total = progress[:answered_total].to_i %>
                  <% if total_questions.positive? %>
                    <span class="survey-progress">
                      &bull;
                      <%= answered_total %>/<%= total_questions %> answered
                      <% if progress[:total_required].to_i.positive? %>
                        <span class="survey-progress-detail">(required <%= progress[:answered_required].to_i %>/<%= progress[:total_required].to_i %>)</span>
                      <% end %>
                    </span>
                  <% end %>
                </div>
                <div class="survey-actions">
                  <div style="display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;">
                    <%= link_to 'Open', survey_path(survey), class: tailwind_button_classes(:primary) %>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="c-list-item c-list-item--empty">No pending surveys</div>
          <% end %>
        </div>
      </section>

      <!-- Completed Surveys Section -->
      <section class="c-card c-card--hover">
        <h2 class="section-title">
          <div class="section-icon"></div>
          Completed Surveys
        </h2>

        <div class="completed-list">
          <% if @completed_surveys.present? %>
            <% @completed_surveys.each do |entry| %>
              <% survey = entry[:survey] %>
              <% offering = @offerings_by_survey_id[survey.id] %>
              <% survey_response = entry[:survey_response] %>
              <% download_token = entry[:download_token] %>
              <% available_until = entry[:available_until] %>
              <% can_edit = available_until.blank? || available_until >= Time.current %>
              <div class="completed-item">
                <div class="c-icon--survey" aria-hidden="true"></div>
                <div class="survey-title"><%= survey.title %></div>
                <% if survey.semester.present? %>
                  <div class="survey-meta" style="font-size: 0.85rem; color: #4b5563;">
                    Semester: <%= survey.semester %>
                  </div>
                <% end %>
                <% if (review_note = review_meetings_note(offering)).present? %>
                  <div class="survey-meta" style="font-size: 0.85rem; color: #4b5563;">
                    Review meetings: <%= review_note %>
                  </div>
                <% end %>
                <% progress = entry[:progress] || {} %>
                <div class="survey-meta">
                  <% submitted_at = entry[:completed_at] %>
                  <% admin_updated_at = entry[:admin_updated_at] %>
                  <% if admin_updated_at.present? %>
                    Submitted on <%= submitted_at&.to_date || 'N/A' %>
                    &bull;
                    Admin updated on <%= admin_updated_at.to_date %>
                  <% else %>
                    Completed on <%= submitted_at&.to_date || 'N/A' %>
                  <% end %>
                  &bull;
                  <%= survey_availability_note(available_until) %>
                </div>

                <div class="survey-meta">
                  <% total_questions = progress[:total_questions].to_i %>
                  <% answered_total = progress[:answered_total].to_i %>
                  <% if total_questions.positive? %>
                    <span class="survey-progress">
                      <%= answered_total %>/<%= total_questions %> answered
                      <% if progress[:total_required].to_i.positive? %>
                        <span class="survey-progress-detail">(required <%= progress[:answered_required].to_i %>/<%= progress[:total_required].to_i %>)</span>
                      <% end %>
                    </span>
                  <% end %>
                </div>
                <div class="survey-actions">
                  <div style="display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;">
                    <%= link_to 'Review', survey_response_path(survey_response), class: tailwind_button_classes(:secondary) %>
                    <% if can_edit %>
                      <%= link_to 'Edit', survey_path(survey), class: tailwind_button_classes(:secondary) %>
                    <% else %>
                        <button type="button" class="<%= tailwind_button_classes(:secondary) %> opacity-50 cursor-not-allowed" disabled aria-disabled="true">Edit</button>
                    <% end %>
                    <%= link_to 'Download PDF', download_survey_response_path(survey_response, token: download_token), class: tailwind_button_classes(:primary), target: "_blank", rel: "noopener noreferrer" %>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="completed-item empty">No completed surveys</div>
          <% end %>
        </div>
      </section>
    </div>

    <!-- Notifications Section -->
    <section class="c-card c-card--hover">
      <h2 class="section-title">
        <div class="section-icon"></div>
        Notifications
      </h2>
      
      <div class="u-stack u-stack--md u-max-h-70vh u-scroll-y">
        <% if @dashboard_notifications.present? %>
          <% @dashboard_notifications.each do |notification| %>
            <div class="c-list-item c-media<%= notification.read? ? '' : ' is-unread' %>">
              <div class="flex h-10 w-10 items-center justify-center rounded-full c-icon-circle" aria-hidden="true">
                <span class="c-icon-button__icon">
                  <span class="sr-only">Notification</span>
                  <%= image_tag "notification-icon.png", alt: "", class: "notification-icon-img", aria: { hidden: true } %>
                </span>
              </div>
              <div class="c-media__content">
                <%= link_to notification.title, notification_path(notification), class: "c-media__title-link" %>

                <p class="c-help" style="margin-top: var(--spacing-xs);">
                  <%= truncate(notification.message, length: 120) %>
                </p>

                <time class="c-help" datetime="<%= notification.created_at.iso8601 %>">
                  <%= time_ago_in_words(notification.created_at) %> ago
                </time>

                <% if (target = notification.target_path_for(current_user)).present? %>
                  <div style="margin-top: var(--spacing-md);">
                    <%= link_to "Open related record", target, class: tailwind_button_classes(:subtle) %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          <div style="display: flex; justify-content: flex-end;">
            <%= link_to "View all notifications", notifications_path, class: tailwind_button_classes(:secondary) %>
          </div>
        <% else %>
          <div class="c-list-item c-media">
            <div class="flex h-10 w-10 items-center justify-center rounded-full c-icon-circle" aria-hidden="true">
              <span class="c-icon-button__icon">
                <span class="sr-only">Notification</span>
                <%= image_tag "notification-icon.png", alt: "", class: "notification-icon-img", aria: { hidden: true } %>
              </span>
            </div>
            <div class="c-media__content">
              <p class="c-help">You're all caught up! New notifications will appear here.</p>
            </div>
          </div>
        <% end %>
      </div>
    </section>

  </div>
  
  
</main>
