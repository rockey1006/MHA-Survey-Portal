<% survey ||= @survey %>
<% sections = survey.sections.map { |section| section }.sort_by { |section| section.position || 0 } %>
<% sections.each do |section| %>
  <% next unless section.respond_to?(:form_uid=) %>
  <% if section.form_uid.blank? %>
    <% section.form_uid = section.id.present? ? "section-#{section.id}" : "section-temp-#{SecureRandom.hex(6)}" %>
  <% end %>
<% end %>

<% categories = survey.categories.map { |category| category } %>
<% section_key_for = lambda do |category|
     key = category.respond_to?(:section_form_uid) ? category.section_form_uid.presence : nil
     key ||= category.survey_section_id.present? ? "section-#{category.survey_section_id}" : nil
     key || ""
   end %>
<% categories_by_section = categories.group_by { |category| section_key_for.call(category) } %>
<% unassigned_categories = categories_by_section[""] || [] %>

<div class="space-y-3 text-sm">
  <div class="rounded-lg border border-slate-200 bg-white p-3">
    <div class="flex items-center justify-between text-slate-700">
      <span>No section</span>
      <span class="rounded-full bg-slate-100 px-2 text-xs"><%= unassigned_categories.size %></span>
    </div>
    <% if unassigned_categories.any? %>
      <ul class="mt-2 space-y-1 text-xs text-slate-500">
        <% unassigned_categories.each do |category| %>
          <li class="rounded border border-slate-100 bg-slate-50 px-2 py-1">
            <div class="font-medium text-slate-700"><%= category.name.presence || "Untitled category" %></div>
            <% if category.questions.any? %>
              <ul class="ml-3 list-disc space-y-0.5 pl-4">
                <% category.questions.sort_by { |question| question.question_order || 0 }.each do |question| %>
                  <li><%= truncate(question.question_text.presence || "Untitled question", length: 60) %></li>
                <% end %>
              </ul>
            <% else %>
              <p class="text-slate-400">No questions</p>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="mt-2 text-xs text-slate-400">Drag categories here to leave them ungrouped.</p>
    <% end %>
  </div>

  <% sections.each do |section| %>
    <% form_uid = section.respond_to?(:form_uid) && section.form_uid.present? ? section.form_uid : (section.id.present? ? "section-#{section.id}" : "") %>
    <% section_categories = categories_by_section[form_uid] || [] %>
    <div class="rounded-lg border border-slate-200 bg-white p-3">
      <div class="flex items-center justify-between text-slate-700">
        <span><%= section.title.presence || "Untitled section" %></span>
        <span class="rounded-full bg-slate-100 px-2 text-xs"><%= section_categories.size %></span>
      </div>
      <% if section_categories.any? %>
        <ul class="mt-2 space-y-1 text-xs text-slate-500">
          <% section_categories.each do |category| %>
            <li class="rounded border border-slate-100 bg-slate-50 px-2 py-1">
              <div class="font-medium text-slate-700"><%= category.name.presence || "Untitled category" %></div>
              <% if category.questions.any? %>
                <ul class="ml-3 list-disc space-y-0.5 pl-4">
                  <% category.questions.sort_by { |question| question.question_order || 0 }.each do |question| %>
                    <li><%= truncate(question.question_text.presence || "Untitled question", length: 60) %></li>
                  <% end %>
                </ul>
              <% else %>
                <p class="text-slate-400">No questions</p>
              <% end %>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="mt-2 text-xs text-slate-400">No categories yet.</p>
      <% end %>
    </div>
  <% end %>
</div>
