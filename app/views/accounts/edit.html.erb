<% content_for :title, "Account Information" %>

<% role_label = if @user.respond_to?(:role_admin?) && @user.role_admin?
                  "Administrator"
                elsif @user.respond_to?(:role_advisor?) && @user.role_advisor?
                  "Advisor"
                elsif @user.respond_to?(:role_student?) && @user.role_student?
                  "Student"
                else
                  "User"
                end %>

<% full_name = @user.name.presence || @user.email %>
<% email = @user.email %>
<% member_since = @user.created_at ? @user.created_at.strftime("%b %-d, %Y") : "Recently" %>
<% updated_text = @user.updated_at ? time_ago_in_words(@user.updated_at) + " ago" : "Just now" %>
<% initials = full_name.to_s.split.first(2).map { |part| part.first&.upcase }.join.presence || email.to_s.first&.upcase %>
<% avatar_url = @user.avatar_url.presence if @user.respond_to?(:avatar_url) %>

<div class="py-6 sm:py-8">
  <div class="u-stack u-stack--lg">
    <section class="c-hero c-hero--maroon c-hero--compact">
      <div class="flex flex-col gap-10 lg:flex-row lg:items-start lg:justify-between">
        <div class="space-y-8">
          <div class="space-y-4">
            <p class="c-eyebrow c-eyebrow--inverse">Account settings</p>
            <h1 class="c-h1 c-h1--inverse"><%= full_name %></h1>
            <p class="c-lede c-lede--inverse max-w-2xl">Update your display name used across dashboards and exports.</p>
          </div>

          <div class="flex flex-wrap gap-3">
            <span class="c-pill c-pill--inverse">
              <span class="c-pill__dot c-pill__dot--inverse" aria-hidden="true"></span>
              Role Â· <%= role_label %>
            </span>
            <span class="c-pill c-pill--inverse">Member since <%= member_since %></span>
            <span class="c-pill c-pill--inverse">Updated <%= updated_text %></span>
          </div>
        </div>

        <div class="flex flex-col gap-8 sm:flex-row sm:items-start lg:flex-col lg:items-end">
          <div class="space-y-5">
            <div>
              <p class="c-eyebrow c-eyebrow--inverse">Primary email</p>
              <p class="c-value c-value--xl c-value--inverse"><%= email %></p>
            </div>
          </div>

          <div class="c-avatar-tile c-avatar-tile--inverse h-24 w-24 text-xl" <%= "role=\"img\" aria-label=\"#{avatar_aria_label(@user)}\"" unless avatar_url %>>
            <% if avatar_url %>
              <img src="<%= avatar_url %>" alt="<%= avatar_aria_label(@user) %>" loading="lazy">
            <% else %>
              <span aria-hidden="true"><%= initials %></span>
              <span class="sr-only"><%= avatar_aria_label(@user) %></span>
            <% end %>
          </div>
        </div>
      </div>
    </section>

    <div>
      <section class="c-card c-card--tight space-y-8">
        <header>
          <p class="c-eyebrow">Overview</p>
          <h2 class="c-h2">Account Information</h2>
        </header>

        <%= form_with model: @user, url: account_path, method: :patch, local: true, class: "u-stack u-stack--lg" do |form| %>
          <% if @user.errors.any? %>
            <div class="c-card c-card--tight border border-rose-200 bg-rose-50 text-rose-800 shadow-none">
              <h3 class="font-semibold text-rose-900">
                <%= pluralize(@user.errors.count, "error") %> need your attention before saving
              </h3>
              <ul class="mt-2 list-disc pl-5">
                <% @user.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="space-y-8">
            <div class="space-y-4">
              <p class="c-h3">Profile</p>

              <div class="u-grid" style="--u-grid-min: 260px">
                <div class="c-kv c-kv--compact" style="grid-column: 1 / -1;">
                  <div class="c-field">
                    <%= form.label :name, "Display name", class: "c-label" %>
                    <%= form.text_field :name,
                          placeholder: "John Doe",
                          required: true,
                          class: "c-input" %>
                    <small class="c-help">Used on dashboards and communications.</small>
                  </div>
                </div>

                <div class="c-kv c-kv--compact">
                  <dt class="c-eyebrow">Email</dt>
                  <dd class="c-value c-value--lg"><%= email %></dd>
                </div>

                <div class="c-kv c-kv--compact">
                  <dt class="c-eyebrow">Role</dt>
                  <dd class="c-value c-value--lg"><%= role_label %></dd>
                </div>
              </div>
            </div>
          </div>

          <div class="c-form-actions u-actions u-actions--split border-t border-slate-100 pt-6">
            <%= link_to dashboard_path, class: tailwind_button_classes(:secondary) do %>
              Cancel
            <% end %>

            <%= form.submit "Save changes", class: tailwind_button_classes(:primary) %>
          </div>
        <% end %>
      </section>
    </div>
  </div>
</div>
