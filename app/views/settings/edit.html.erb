<main class="flex justify-center px-6 py-8">
  <div class="w-full max-w-2xl">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold">Settings</h1>
      <p class="text-sm text-slate-600">Update your preferences. Changes are saved to your account.</p>
    </header>

    <div class="rounded-sm bg-white p-6 shadow-sm border ring-1 ring-slate-200">
      <%= form_with model: @user, url: settings_path, method: :patch, local: true, id: "settings-form" do |f| %>
        <% if @user.errors.any? %>
          <div class="mb-4">
            <div class="text-sm font-semibold text-red-700">There were errors with your submission:</div>
            <ul class="text-sm text-red-600 list-disc list-inside">
              <% @user.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

  <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700">Language</label>
            <%= f.select :language, options_for_select([["English", "en"], ["Spanish", "es"]], @user.language), include_blank: "Select language", class: "mt-1 block w-full rounded-md border-slate-300 px-3 py-2 text-sm" %>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700">Text size</label>
            <%= f.select :text_scale_percent,
                  options_for_select([["100% (default)", 100], ["125%", 125], ["150%", 150], ["175%", 175], ["200%", 200]], @user.text_scale_percent || 100),
                  {},
                  class: "mt-1 block w-full rounded-md border-slate-300 px-3 py-2 text-sm"
            %>
            <p class="text-xs text-slate-500 mt-1">Increase text size up to 200% for accessibility. Line spacing and controls will scale proportionally.</p>
          </div>

          <div>
            <div class="flex items-center gap-3">
              <%= f.check_box :notifications_enabled, class: "h-4 w-4 text-blue-600" %>
              <label class="text-sm text-slate-700">Enable email notifications</label>
            </div>
          </div>

          <div class="pt-4">
            <%= f.submit "Save changes", class: "inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-white text-sm hover:bg-blue-700" %>
            <%# Back button goes to the appropriate dashboard based on user role %>
            <% back_path = if current_user&.role_admin?
                              admin_dashboard_path
                            elsif current_user&.role_advisor?
                              advisor_dashboard_path
                            elsif current_user&.role_student?
                              student_dashboard_path
                            else
                              root_path
                            end %>
            <%= link_to "â† Back", back_path, class: "ml-3 inline-flex items-center rounded-lg bg-slate-200 px-4 py-2 text-slate-800 hover:bg-slate-300" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</main>
<script>
  // Submit settings via fetch to ensure we can reload the app immediately on success.
  (function() {
    var form = document.getElementById('settings-form');
    if (!form) return;

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var submit = form.querySelector('[type=submit]');
      if (submit) submit.disabled = true;

      var token = document.querySelector('meta[name=csrf-token]') && document.querySelector('meta[name=csrf-token]').getAttribute('content');
      var fd = new FormData(form);

      fetch(form.action, {
        method: 'POST', // form_with uses POST with _method=patch
        body: fd,
        credentials: 'same-origin',
        headers: token ? { 'X-CSRF-Token': token } : {}
      }).then(function(resp) {
        if (resp.redirected) {
          window.location.href = resp.url;
          return;
        }
        if (resp.ok) {
          // Successful update - refresh the page so the new settings (and root font-size) apply app-wide
          window.location.reload();
          return;
        }
        // On error, replace the form container with server response (this will show validation errors)
        return resp.text().then(function(html) {
          try {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var newForm = doc.getElementById('settings-form');
            if (newForm) {
              form.replaceWith(newForm);
            } else {
              // fallback: reload so user can see server-rendered errors
              window.location.reload();
            }
          } catch (err) {
            window.location.reload();
          }
        });
      }).catch(function() {
        // network failure - re-enable submit and show a simple alert
        if (submit) submit.disabled = false;
        alert('Failed to save settings. Please try again.');
      });
    });
  })();
</script>
