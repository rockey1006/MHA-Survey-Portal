<% track_options = (@available_tracks + survey.track_list).uniq.compact.sort %>
<% input_classes = "block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm placeholder:text-slate-400 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" %>
<% textarea_classes = "#{input_classes} min-h-[5rem]" %>
<% checkbox_classes = "h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" %>

<%= form_with(model: [:admin, survey], local: true, class: "space-y-10") do |form| %>
  <% if survey.errors.any? %>
    <div class="rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-700">
      <h2 class="mb-2 text-base font-semibold"><%= pluralize(survey.errors.count, "error") %> prevented this survey from being saved:</h2>
      <ul class="list-disc space-y-1 pl-5">
        <% survey.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <section class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <header class="space-y-1">
      <h2 class="text-lg font-semibold text-slate-900">Survey basics</h2>
      <p class="text-sm text-slate-600">Provide a clear title, semester, and description for advisors.</p>
    </header>

    <div class="grid gap-6 md:grid-cols-2">
      <div class="space-y-2">
        <%= form.label :title, "Survey title", class: "block text-sm font-medium text-slate-700" %>
        <%= form.text_field :title, required: true, class: input_classes, placeholder: "Capstone Competency Survey" %>
      </div>

      <div class="space-y-2">
        <%= form.label :semester, "Semester", class: "block text-sm font-medium text-slate-700" %>
        <%= form.text_field :semester, required: true, class: input_classes, placeholder: "Fall 2025" %>
      </div>

      <div class="md:col-span-2 space-y-2">
        <%= form.label :description, "Summary", class: "block text-sm font-medium text-slate-700" %>
        <%= form.text_area :description, class: textarea_classes, placeholder: "Explain where this survey fits in the advising process." %>
      </div>

      <div class="md:col-span-2 flex items-start gap-3">
        <%= form.check_box :is_active, class: checkbox_classes %>
        <div class="space-y-1 text-sm">
          <span class="font-medium text-slate-700">Survey is active</span>
          <p class="text-slate-500">Inactive surveys stay hidden from advisors until you reactivate them.</p>
        </div>
      </div>
    </div>
  </section>

  <section class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <header class="space-y-1">
      <h2 class="text-lg font-semibold text-slate-900">Track assignments</h2>
      <p class="text-sm text-slate-600">Choose which program tracks should see this survey. Add custom tracks if needed.</p>
    </header>

    <div class="grid gap-6 md:grid-cols-2">
      <div class="space-y-2">
        <label for="survey-track-list" class="block text-sm font-medium text-slate-700">Select existing tracks</label>
        <%= hidden_field_tag "survey[track_list][]", "" %>
        <%= select_tag "survey[track_list][]",
                       options_for_select(track_options, survey.track_list),
                       multiple: true,
                       size: [track_options.size, 5].max,
                       id: "survey-track-list",
                       class: "min-h-[12rem] #{input_classes}" %>
        <p class="text-xs text-slate-500">Hold CTRL/âŒ˜ to choose multiple tracks. Leave everything unchecked to keep the survey hidden.</p>
      </div>

      <div class="space-y-2">
        <label for="survey-additional-track-names" class="block text-sm font-medium text-slate-700">Add new track names</label>
        <%= text_area_tag "survey[additional_track_names]",
                          nil,
                          rows: 4,
                          id: "survey-additional-track-names",
                          class: textarea_classes,
                          placeholder: "Executive Online\nHybrid" %>
        <p class="text-xs text-slate-500">Separate multiple tracks with commas or new lines. They will be saved once you submit.</p>
      </div>
    </div>
  </section>

  <section class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <header class="space-y-1">
      <h2 class="text-lg font-semibold text-slate-900">Categories &amp; questions</h2>
      <p class="text-sm text-slate-600">Every category should contain at least one question. Remove the items you no longer need.</p>
    </header>

    <div class="space-y-6">
      <%= form.fields_for :categories do |category_fields| %>
        <% category = category_fields.object %>
        <article class="space-y-5 rounded-xl border border-slate-200 bg-slate-50 p-5 shadow-sm">
          <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
            <div class="flex-1 space-y-2">
              <%= category_fields.hidden_field :id %>
              <%= category_fields.label :name, "Category name", class: "block text-sm font-medium text-slate-700" %>
              <%= category_fields.text_field :name, required: true, class: input_classes, placeholder: "Leadership" %>
            </div>

            <% if category.persisted? %>
              <label class="flex items-center gap-2 text-sm font-medium text-rose-600">
                <%= category_fields.check_box :_destroy, class: checkbox_classes %>
                <span>Remove category</span>
              </label>
            <% end %>
          </div>

          <div class="space-y-5">
            <div class="space-y-2">
              <%= category_fields.label :description, "Description", class: "block text-sm font-medium text-slate-700" %>
              <%= category_fields.text_area :description, class: textarea_classes, placeholder: "Optional context shown to advisors and students." %>
            </div>

            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-600">Questions</h3>
              <%= category_fields.fields_for :questions do |question_fields| %>
                <% question = question_fields.object %>
                <div class="space-y-5 rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
                  <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
                    <div class="flex-1 space-y-2">
                      <%= question_fields.hidden_field :id %>
                      <%= question_fields.label :question_text, "Prompt", class: "block text-sm font-medium text-slate-700" %>
                      <%= question_fields.text_area :question_text, class: textarea_classes, placeholder: "Describe the competency being assessed." %>
                    </div>

                    <% if question.persisted? %>
                      <label class="flex items-center gap-2 text-sm font-medium text-rose-600">
                        <%= question_fields.check_box :_destroy, class: checkbox_classes %>
                        <span>Remove question</span>
                      </label>
                    <% end %>
                  </div>

                  <div class="grid gap-4 md:grid-cols-2">
                    <div class="space-y-2">
                      <%= question_fields.label :question_order, "Order", class: "block text-sm font-medium text-slate-700" %>
                      <%= question_fields.number_field :question_order, in: 1..200, class: input_classes %>
                    </div>

                    <div class="space-y-2">
                      <%= question_fields.label :question_type, "Response type", class: "block text-sm font-medium text-slate-700" %>
                      <%= question_fields.select :question_type,
                                                options_for_select(@question_types.map { |type| [type.humanize, type] }, question.question_type),
                                                {},
                                                class: input_classes %>
                    </div>

                    <div class="flex items-start gap-3">
                      <%= question_fields.check_box :is_required, class: checkbox_classes %>
                      <span class="text-sm text-slate-700">Required response</span>
                    </div>

                    <div class="flex items-start gap-3">
                      <%= question_fields.check_box :has_evidence_field, class: checkbox_classes %>
                      <span class="text-sm text-slate-700">Include evidence field</span>
                    </div>
                  </div>

                  <div class="space-y-2">
                    <%= question_fields.label :answer_options, "Answer options", class: "block text-sm font-medium text-slate-700" %>
                    <%= question_fields.text_area :answer_options, class: textarea_classes, placeholder: "Comma separated values for multiple choice questions." %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </article>
      <% end %>
    </div>
  </section>

  <div class="flex flex-wrap items-center gap-3">
    <%= form.submit(survey.persisted? ? "Update survey" : "Create survey", class: tailwind_button_classes(:primary)) %>
    <%= link_to "Cancel", admin_surveys_path, class: tailwind_button_classes(:secondary) %>
  </div>
<% end %>
