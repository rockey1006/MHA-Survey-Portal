<h2>Feedback for <%= @student.user.name %> â€“ <%= @survey.title %></h2>

<h3>Student Responses</h3>
<div class="mb-6">
  <%# Prefer rendering the SurveyResponse PORO (same layout students see). If it has
      no question_responses (or the PORO is nil), fall back to the @responses table. %>
  <% if defined?(@survey_response) && @survey_response %>
    <%= render partial: 'survey_responses/survey_response', locals: { survey_response: @survey_response } %>
  <% elsif @responses.present? %>
    <table class="table">
      <thead>
        <tr>
          <th>Question</th>
          <th>Response</th>
        </tr>
      </thead>
      <tbody>
        <% @responses.each do |r| %>
          <tr>
            <td><%= r.question.try(:question_text) || r.question.try(:content) || "Q#{r.question_id}" %></td>
            <td><%= r.response_value %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-sm text-slate-600">No student responses found for this survey.</p>
  <% end %>
</div>

<hr>

<h3>Advisor Feedback (per-category)</h3>

<%= form_with url: feedbacks_path(survey_id: @survey.id, student_id: @student.id), local: true do |f| %>
  <div class="space-y-4">
    <% @survey.categories.order(:id).each do |category| %>
      <% existing = @existing_feedbacks_by_category && @existing_feedbacks_by_category[category.id] %>
      <section class="p-4 border rounded">
        <h4 class="font-semibold"><%= category.name %></h4>

          <div class="mt-2 grid grid-cols-1 gap-2 md:grid-cols-3">
            <div>
              <label for="ratings_<%= category.id %>_average_score">Score (1-5)</label>
              <input id="ratings_<%= category.id %>_average_score" name="ratings[<%= category.id %>][average_score]" value="<%= params[:prefill].present? && existing ? existing.average_score : '' %>" type="number" min="1" max="5" step="1" class="w-full border rounded px-2 py-1" />
            </div>
            <div class="md:col-span-2">
              <label for="ratings_<%= category.id %>_comments">Comment (optional)</label>
              <input id="ratings_<%= category.id %>_comments" name="ratings[<%= category.id %>][comments]" value="<%= params[:prefill].present? && existing ? existing.comments : '' %>" type="text" class="w-full border rounded px-2 py-1" />
            </div>
          </div>

          <% if params[:prefill].present? && existing %>
            <input type="hidden" name="ratings[<%= category.id %>][id]" value="<%= existing.id %>" />
          <% end %>
      </section>
    <% end %>
  </div>

  <div class="mt-4">
    <%= f.submit "Save all categories", class: "btn btn-primary" %>
  </div>
<% end %>


