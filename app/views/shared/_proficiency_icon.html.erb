<%# Large accessible info icon showing the full MHA Proficiency Scale. If a `text:` local is provided, it will be shown above the scale. %>
<div class="inline-flex items-center relative">
  <button type="button" aria-haspopup="true" aria-expanded="false" class="ml-2 inline-flex items-center justify-center rounded-full p-1 text-lg leading-none text-slate-700 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500" data-proficiency-trigger>
    <span class="sr-only">Show proficiency scale</span>
    <span aria-hidden="true">â“˜</span>
  </button>

  <div role="tooltip" aria-hidden="true" class="invisible z-50 w-[min(28rem,80vw)] max-h-[60vh] overflow-auto rounded-md border border-slate-200 bg-white p-4 text-sm text-slate-800 shadow-lg transition-all duration-150" data-proficiency-popover>
    <% provided = local_assigns[:text].presence %>
    <% only_text = local_assigns.key?(:only_text) && local_assigns[:only_text] %>
    <% if provided %>
      <div class="mb-2 text-sm text-slate-700"><%= provided %></div>
    <% end %>

    <% unless only_text %>
      <h3 class="mb-2 text-base font-semibold">MHA Proficiency Scale <span class="text-xs font-normal text-slate-500">(Approved Fall 2023)</span></h3>
      <p class="mb-2 text-xs text-slate-600">This five-point proficiency scale is designed for a graduate professional program, focusing on the transition from academic theory to applied professional practice. Here is a summary of each level:</p>

      <div class="space-y-3">
        <div>
          <div class="font-semibold">Mastery (5)</div>
          <ul class="list-disc ml-5 text-xs text-slate-700">
            <li>The student is a recognized authority and a leader who can shape professional practice.</li>
            <li>They demonstrate extensive knowledge of current trends and complex theories.</li>
            <li>They can pioneer new solutions and troubleshoot complex, non-routine problems.</li>
            <li>They function with complete independence and contribute to strategic-level decision-making.</li>
          </ul>
        </div>

        <div>
          <div class="font-semibold">Experienced (4)</div>
          <ul class="list-disc ml-5 text-xs text-slate-700">
            <li>The student has a strong, well-developed skill set and can apply complex theories in their professional practice.</li>
            <li>They have a deep understanding of core concepts and specialized theories and can articulate nuances to others.</li>
            <li>They independently apply theoretical knowledge to solve real-world problems with minimal to no guidance.</li>
          </ul>
        </div>

        <div>
          <div class="font-semibold">Capable (3)</div>
          <ul class="list-disc ml-5 text-xs text-slate-700">
            <li>The student has a practical, working grasp of the professional area and can perform standard tasks independently.</li>
            <li>They possess foundational knowledge and skills and can complete a range of standard job tasks.</li>
            <li>They can work without assistance on most routine assignments and effectively participate in team projects.</li>
            <li>They reliably meet expectations for their position but may need minimal guidance for unusual situations.</li>
          </ul>
        </div>

        <div>
          <div class="font-semibold">Emerging (2)</div>
          <ul class="list-disc ml-5 text-xs text-slate-700">
            <li>The student has a limited, but growing, understanding of professional concepts and requires direct guidance for complex tasks.</li>
            <li>They are familiar with foundational terminology and techniques, but their understanding is limited in scope.</li>
            <li>They can perform basic, simple tasks but their performance does not consistently meet professional standards.</li>
            <li>They operate under close supervision and need frequent checks and clear instructions.</li>
          </ul>
        </div>

        <div>
          <div class="font-semibold">Beginner (1)</div>
          <ul class="list-disc ml-5 text-xs text-slate-700">
            <li>The student has only a basic or superficial understanding with little to no practical experience.</li>
            <li>They have a basic awareness of the topic and can identify core concepts.</li>
            <li>They cannot perform job duties independently, and their performance generally fails to meet expectations even with guidance.</li>
            <li>They require constant and direct supervision for all tasks.</li>
          </ul>
        </div>

        <div>
          <div class="font-semibold flex items-center gap-2">
            Not able to assess (0)
            <span class="rounded-full bg-slate-100 px-2 py-0.5 text-[0.6rem] font-semibold uppercase tracking-wide text-slate-600">Advisor only</span>
          </div>
          <p class="mt-1 text-xs text-slate-600">Use only when an advisor cannot evaluate the student at this time;</p>
        </div>
      </div>
    <% end %>
  </div>
</div>

  <script>
  (function(){
    function placePopover(trigger, pop) {
      // ensure pop has layout to measure
      pop.style.position = 'absolute';
      pop.style.left = '-9999px';
      pop.style.top = '-9999px';
      pop.classList.remove('invisible');
      pop.style.opacity = 1;

      const trigRect = trigger.getBoundingClientRect();
      const gap = 8;
      const scrollX = window.scrollX || window.pageXOffset;
      const scrollY = window.scrollY || window.pageYOffset;

      const minWidth = 220; // px
      const maxWidth = 448; // px (~28rem)

      // available space to right and left (in px)
      const availRight = Math.floor(window.innerWidth - trigRect.right - gap - 8);
      const availLeft = Math.floor(trigRect.left - gap - 8);

      let placeRight = availRight >= Math.min(minWidth, Math.max(0, availRight));
      let width;

      if (availRight >= minWidth) {
        width = Math.min(maxWidth, availRight);
        placeRight = true;
      } else if (availLeft >= minWidth) {
        width = Math.min(maxWidth, availLeft);
        placeRight = false;
      } else {
        // narrow viewport: use almost full width and position clamped
        width = Math.max(minWidth, Math.floor(window.innerWidth - 16));
        // prefer right if any space exists
        placeRight = availRight >= availLeft;
      }

      pop.style.width = width + 'px';
      // recompute popRect after width applied
      const popRect = pop.getBoundingClientRect();

      // vertical center aligned to trigger
      let top = trigRect.top + (trigRect.height / 2) - (popRect.height / 2) + scrollY;
      const minTop = 8 + scrollY;
      const maxTop = window.innerHeight - popRect.height - 8 + scrollY;
      top = Math.min(Math.max(top, minTop), maxTop);

      let left;
      if (placeRight) {
        left = Math.min(trigRect.right + gap + scrollX, window.innerWidth - popRect.width - 8 + scrollX);
        pop.style.transformOrigin = 'left center';
      } else {
        left = Math.max(trigRect.left - popRect.width - gap + scrollX, 8 + scrollX);
        pop.style.transformOrigin = 'right center';
      }

      pop.style.left = Math.round(left) + 'px';
      pop.style.top = Math.round(top) + 'px';
    }

    document.querySelectorAll('[data-proficiency-trigger]').forEach(function(trigger, idx){
      const pop = trigger.parentElement.querySelector('[data-proficiency-popover]');
      if(!pop) return;

  // move pop to body so it's not clipped by container overflow
  document.body.appendChild(pop);
  pop.style.position = 'absolute';
  pop.classList.add('invisible');
  pop.style.opacity = 0;
  // ensure hidden popovers don't intercept pointer events (can block re-hover)
  pop.style.pointerEvents = 'none';
  // hide via display so it can't cover the trigger element
  pop.style.display = 'none';

      let hideTimer = null;
      let isOpen = false;

      const show = () => {
        clearTimeout(hideTimer);
        placePopover(trigger, pop);
  pop.classList.remove('invisible');
  pop.style.display = 'block';
  pop.style.opacity = 1;
  pop.style.pointerEvents = 'auto';
        pop.setAttribute('aria-hidden','false');
        trigger.setAttribute('aria-expanded','true');
        isOpen = true;
      };
      const hide = () => {
        clearTimeout(hideTimer);
  pop.classList.add('invisible');
  pop.style.opacity = 0;
  pop.style.pointerEvents = 'none';
  pop.style.display = 'none';
        pop.setAttribute('aria-hidden','true');
        trigger.setAttribute('aria-expanded','false');
        isOpen = false;
      };

      trigger.addEventListener('mouseenter', show);
      trigger.addEventListener('focus', show);
      trigger.addEventListener('mouseleave', function(){ hideTimer = setTimeout(hide, 150); });
      trigger.addEventListener('blur', function(){ hideTimer = setTimeout(hide, 150); });

      pop.addEventListener('mouseenter', function(){ clearTimeout(hideTimer); });
      pop.addEventListener('mouseleave', function(){ hideTimer = setTimeout(hide, 150); });

      // recompute on resize/scroll while open
      window.addEventListener('resize', function(){ if(isOpen) placePopover(trigger, pop); });
      window.addEventListener('scroll', function(){ if(isOpen) placePopover(trigger, pop); }, true);

      // Allow Esc to hide
      document.addEventListener('keydown', function(e){ if(e.key === 'Escape' && isOpen) hide(); });
    });
  })();
  </script>
