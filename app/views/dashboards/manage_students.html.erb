<!-- Student Advisor Management view -->
<main class="main-content" style="display: flex; justify-content: center;">
    <section class="c-card dashboard-section" style="max-width: 1200px; width: 100%;">
        <div class="section-header">
            <h1 class="section-title">ðŸŽ“ Student Advisor Management</h1>
            <p class="section-subtitle">Review advisees and assign advisors across the program.</p>
        </div>

        <div class="role-summary-grid">
            <div class="c-card role-summary-card">
                <div class="role-summary-icon student">ðŸ‘¥</div>
                <div class="role-summary-info">
                    <div class="role-summary-count"><%= @assignment_stats[:total] %></div>
                    <div class="role-summary-label">Total Students</div>
                </div>
            </div>

            <div class="c-card role-summary-card">
                <div class="role-summary-icon advisor">âœ…</div>
                <div class="role-summary-info">
                    <div class="role-summary-count"><%= @assignment_stats[:assigned] %></div>
                    <div class="role-summary-label">Assigned</div>
                </div>
            </div>

            <div class="c-card role-summary-card">
                <div class="role-summary-icon admin">ðŸ“‹</div>
                <div class="role-summary-info">
                    <div class="role-summary-count"><%= @assignment_stats[:unassigned] %></div>
                    <div class="role-summary-label">Unassigned</div>
                </div>
            </div>
        </div>

            <% if @students.blank? %>
                <div class="flex flex-col items-center justify-center gap-3 rounded-2xl border border-dashed border-slate-300 bg-white p-10 text-center shadow-sm">
                    <span class="text-4xl" aria-hidden="true">ðŸ“­</span>
                    <p class="text-sm text-slate-600">No students were found for your account.</p>
                </div>
        <% elsif @can_manage %>
            <%= form_with url: update_student_advisors_path, method: :patch, local: true, id: "advisor-management-form", data: { turbo: false }, remote: false do |form| %>
                <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                <% track_select_options = [["Select track", ""]] + @track_select_options %>

                <div class="c-card c-card--flush c-table-wrapper">
                    <table class="c-table">
                        <thead>
                            <tr>
                                <th class="table-header-avatar">Avatar</th>
                                <th class="table-header-name" style="min-width: 15rem;">Student</th>
                                <th class="table-header-email" style="min-width: 16rem;">Email</th>
                                <th class="table-header-track" style="min-width: 8rem;">Track</th>
                                <th class="table-header-track min-w-[10rem]" style="min-width: 12rem;">New Track</th>
                                <th class="table-header-current-role" style="min-width: 12rem;">Current Advisor</th>
                                <th class="table-header-new-role" style="min-width: 12rem;">New Advisor</th>
                                <th class="table-header-actions" style="min-width: 12rem;">Changes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% @students.each do |student| %>
                                <% user = student.user %>
                                <% current_advisor = student.advisor %>
                                <% current_advisor_name = current_advisor&.display_name || "Unassigned" %>
                                <% current_advisor_id = student.advisor_id.present? ? student.advisor_id.to_s : "" %>
                                <% track_key = student.track.presence || "" %>
                                <% track_label = track_key.present? ? track_key.titleize : "Unassigned" %>

                                <tr class="user-row" data-student-row="<%= student.student_id %>">
                                    <td class="user-avatar-cell">
                                        <div class="user-table-avatar"
                                                 <% if user&.avatar_url.present? %>
                                                     style="background-image: url('<%= user.avatar_url %>');"
                                                 <% end %>>
                                            <% unless user&.avatar_url.present? %>ðŸ‘¤<% end %>
                                        </div>
                                    </td>

                                    <td class="user-name-cell" style="min-width: 15rem;">
                                        <div class="user-name"><%= user&.name || "Unknown Student" %></div>
                                    </td>

                                    <td class="user-email-cell" style="min-width: 16rem;">
                                        <%= user&.email || "â€”" %>
                                    </td>

                                    <td class="user-track-cell" style="min-width: 8rem;">
                                        <span class="role-badge track"><%= track_label %></span>
                                    </td>

                                    <td class="user-track-update-cell" style="min-width: 13rem;">
                                        <div class="c-select-wrapper">
                                            <%= select_tag "track_updates[#{student.student_id}]",
                                                    options_for_select(track_select_options, track_key),
                                                    class: "c-select track-select w-full",
                                                    data: {
                                                        student_id: student.student_id,
                                                        original_track: track_key,
                                                        original_track_name: track_label,
                                                        student_name: user&.name || "Student ##{student.student_id}"
                                                    },
                                                    id: "track_select_#{student.student_id}" %>
                                        </div>
                                    </td>

                                    <td class="user-current-role-cell" style="min-width: 12rem;">
                                        <span class="role-badge advisor"><%= current_advisor_name %></span>
                                    </td>

                                    <td class="user-new-role-cell" style="min-width: 12rem;">
                                        <div class="c-select-wrapper">
                                            <%= select_tag "advisor_updates[#{student.student_id}]",
                                                    options_for_select(@advisor_select_options, current_advisor_id),
                                                    class: "c-select advisor-select",
                                                    data: {
                                                        student_id: student.student_id,
                                                        original_advisor: current_advisor_id,
                                                        original_advisor_name: current_advisor_name,
                                                        student_name: user&.name || "Student ##{student.student_id}"
                                                    },
                                                    id: "advisor_select_#{student.student_id}" %>
                                        </div>
                                    </td>

                                    <td class="user-actions-cell" style="min-width: 12rem;">
                                        <span class="c-change-indicator" data-student-id="<%= student.student_id %>">
                                            No changes
                                        </span>
                                    </td>
                                </tr>
                            <% end %>
                        </tbody>
                    </table>
                </div>

                <div class="c-card c-card--tight mt-6 flex flex-col gap-4">
                    <div class="text-sm text-slate-600" id="student-changes-summary" style="display: none;">
                        <span class="changes-count font-semibold">0 changes pending</span>
                    </div>

                    <div class="flex flex-wrap items-center justify-end gap-3">
                        <%= link_to "Cancel", admin_dashboard_path, class: tailwind_button_classes(:secondary) %>
                        <%= form.submit "Save Changes", class: tailwind_button_classes(:primary), id: "advisor-save-btn", disabled: true %>
                    </div>
                </div>
            <% end %>
        <% else %>
            <div class="c-card c-card--flush c-table-wrapper">
                <table class="c-table">
                    <thead>
                        <tr>
                            <th class="table-header-avatar">Avatar</th>
                            <th class="table-header-name" style="min-width: 15rem;">Student</th>
                            <th class="table-header-email" style="min-width: 16rem;">Email</th>
                            <th class="table-header-track" style="min-width: 8rem;">Track</th>
                            <th class="table-header-current-role">Advisor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% @students.each do |student| %>
                            <% user = student.user %>
                            <% current_advisor = student.advisor %>
                            <tr class="user-row">
                                <td class="user-avatar-cell">
                                    <div class="user-table-avatar"
                                             <% if user&.avatar_url.present? %>
                                                 style="background-image: url('<%= user.avatar_url %>');"
                                             <% end %>>
                                        <% unless user&.avatar_url.present? %>ðŸ‘¤<% end %>
                                    </div>
                                </td>
                                <td class="user-name-cell" style="min-width: 15rem;">
                                    <div class="user-name"><%= user&.name || "Unknown Student" %></div>
                                </td>
                                <td class="user-email-cell" style="min-width: 16rem;">
                                    <%= user&.email || "â€”" %>
                                </td>
                                <td class="user-track-cell" style="min-width: 8rem;">
                                    <span class="role-badge track"><%= student.track.present? ? student.track.titleize : "Unassigned" %></span>
                                </td>
                                <td class="user-current-role-cell" style="min-width: 12rem;">
                                    <span class="role-badge advisor"><%= current_advisor&.display_name || "Unassigned" %></span>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        <% end %>

        <div class="mt-6 flex justify-start">
            <%= link_to "â† Back",
                                    admin_dashboard_path,
                                    class: tailwind_button_classes(:secondary),
                                    data: { turbo: false } %>
        </div>
    </section>
</main>

<script>
    (function() {
        function initAdvisorManagement() {
            const form = document.getElementById('advisor-management-form');
            if (!form || form.dataset.initialized === 'true') {
                return;
            }

            form.dataset.initialized = 'true';

            const saveButton = document.getElementById('advisor-save-btn');
            const changesSummary = document.getElementById('student-changes-summary');
            const changesCount = changesSummary ? changesSummary.querySelector('.changes-count') : null;

            if (!saveButton || !changesSummary || !changesCount) {
                return;
            }

            const changeRegistry = new Map();

            function indicatorFor(studentId) {
                return form.querySelector(`.c-change-indicator[data-student-id="${studentId}"]`);
            }

            function rowFor(studentId) {
                return form.querySelector(`.user-row[data-student-row="${studentId}"]`);
            }

            function updateIndicator(studentId) {
                const indicator = indicatorFor(studentId);
                if (!indicator) {
                    return;
                }

                const row = rowFor(studentId);
                const entry = changeRegistry.get(studentId);
                const messages = [];

                if (entry && entry.advisor) {
                    messages.push(`Advisor: ${entry.advisor.from} â†’ ${entry.advisor.to}`);
                }

                if (entry && entry.track) {
                    messages.push(`Track: ${entry.track.from} â†’ ${entry.track.to}`);
                }

                if (messages.length > 0) {
                    indicator.textContent = messages.join(' | ');
                    indicator.className = 'c-change-indicator changed';
                    if (row) {
                        row.classList.add('has-changes');
                    }
                } else {
                    indicator.textContent = 'No changes';
                    indicator.className = 'c-change-indicator';
                    if (row) {
                        row.classList.remove('has-changes');
                    }
                }
            }

            function updateUI() {
                const changeCount = changeRegistry.size;

                if (changeCount > 0) {
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.cursor = 'pointer';
                    changesSummary.style.display = 'block';
                    changesCount.textContent = `${changeCount} student${changeCount === 1 ? '' : 's'} pending updates`;
                    saveButton.setAttribute('data-has-changes', 'true');
                } else {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.5';
                    saveButton.style.cursor = 'not-allowed';
                    changesSummary.style.display = 'none';
                    saveButton.removeAttribute('data-has-changes');
                }
            }

            function setChange(studentId, type, payload) {
                const existing = changeRegistry.get(studentId) || { studentName: (payload && payload.studentName) || `Student ${studentId}`, advisor: null, track: null };

                if (payload) {
                    existing.studentName = payload.studentName || existing.studentName;
                    existing[type] = payload;
                } else {
                    existing[type] = null;
                }

                if (!existing.advisor && !existing.track) {
                    changeRegistry.delete(studentId);
                } else {
                    changeRegistry.set(studentId, existing);
                }

                updateIndicator(studentId);
                updateUI();
            }

            form.querySelectorAll('.advisor-select').forEach(select => {
                const studentId = select.dataset.studentId;
                const originalAdvisor = select.dataset.originalAdvisor || '';
                const originalName = select.dataset.originalAdvisorName || 'Unassigned';
                const studentName = select.dataset.studentName || `Student ${studentId}`;

                select.value = originalAdvisor;

                select.addEventListener('change', function() {
                    const newAdvisor = this.value || '';
                    const selectedOption = this.options[this.selectedIndex];
                    const newAdvisorName = selectedOption ? selectedOption.text.trim() : 'Unassigned';

                    if (newAdvisor !== originalAdvisor) {
                        setChange(studentId, 'advisor', {
                            from: originalName,
                            to: newAdvisorName,
                            value: newAdvisor,
                            studentName: studentName
                        });
                    } else {
                        setChange(studentId, 'advisor', null);
                    }
                });
            });

            form.querySelectorAll('.track-select').forEach(select => {
                const studentId = select.dataset.studentId;
                const originalTrack = select.dataset.originalTrack || '';
                const originalTrackName = select.dataset.originalTrackName || 'Unassigned';
                const studentName = select.dataset.studentName || `Student ${studentId}`;

                select.value = originalTrack;

                select.addEventListener('change', function() {
                    const newTrack = this.value || '';
                    const selectedOption = this.options[this.selectedIndex];
                    const newTrackName = selectedOption ? selectedOption.text.trim() : 'Unassigned';

                    if (newTrack !== originalTrack) {
                        setChange(studentId, 'track', {
                            from: originalTrackName,
                            to: newTrackName,
                            value: newTrack,
                            studentName: studentName
                        });
                    } else {
                        setChange(studentId, 'track', null);
                    }
                });
            });

            saveButton.addEventListener('click', function(e) {
                if (this.disabled) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('No changes to save. Please make student updates first.');
                }
            });

            form.addEventListener('submit', function(e) {
                if (changeRegistry.size === 0) {
                    alert('No changes to save.');
                    e.preventDefault();
                    return false;
                }

                const changeLines = [];
                let fieldChangeCount = 0;

                changeRegistry.forEach(entry => {
                    if (entry.advisor) {
                        changeLines.push(`â€¢ ${entry.studentName}: Advisor ${entry.advisor.from} â†’ ${entry.advisor.to}`);
                        fieldChangeCount += 1;
                    }
                    if (entry.track) {
                        changeLines.push(`â€¢ ${entry.studentName}: Track ${entry.track.from} â†’ ${entry.track.to}`);
                        fieldChangeCount += 1;
                    }
                });

                if (fieldChangeCount === 0) {
                    alert('No changes to save.');
                    e.preventDefault();
                    return false;
                }

                const confirmMessage = `You are about to apply ${fieldChangeCount} change${fieldChangeCount === 1 ? '' : 's'} across ${changeRegistry.size} student${changeRegistry.size === 1 ? '' : 's'}:\n\n${changeLines.join('\n')}\n\nProceed?`;

                if (!confirm(confirmMessage)) {
                    e.preventDefault();
                    return false;
                }

                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';
                return true;
            });

            updateUI();
        }

        document.addEventListener('turbo:load', initAdvisorManagement);
        document.addEventListener('DOMContentLoaded', initAdvisorManagement);
    })();
</script>
