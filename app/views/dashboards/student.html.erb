<!-- app/views/dashboards/student.html.erb -->

<main class="main-content">
  <%= render "shared/role_switcher" %>
  <div class="dashboard-grid dashboard-grid-2">
    
    <!-- To-Do Section -->
    <section class="dashboard-card">
      <h2 class="section-title">
        <div class="section-icon"></div>
        To-do
      </h2>
      
      <div class="todo-list">
        <% if @pending_surveys.present? %>
          <% @pending_surveys.each do |entry| %>
            <% survey = entry[:survey] %>
            <div class="todo-item">
              <div class="survey-icon"></div>
              <div class="survey-title"><%= survey.title %></div>
              <div class="survey-meta">
                Status: <%= entry[:status] %>
                <% if entry[:total_count].to_i.positive? %>
                  <span class="survey-progress">&bull; <%= entry[:answered_count] %>/<%= entry[:total_count] %> answered</span>
                <% end %>
              </div>
              <div class="survey-actions">
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;">
                  <%= link_to 'Open', survey_path(survey), class: tailwind_button_classes(:primary) %>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="todo-item empty">No pending surveys</div>
        <% end %>
      </div>
    </section>

    <!-- Notifications Section -->
    <section class="dashboard-card">
      <h2 class="section-title">
        <div class="section-icon"></div>
        Notifications
      </h2>
      
      <div class="notification-list">
        <% if @dashboard_notifications.present? %>
          <% @dashboard_notifications.each do |notification| %>
            <div class="notification<%= notification.read? ? '' : ' unread' %>">
              <div class="notification-icon"></div>
              <div class="notification-content">
                <div class="notification-text">
                  <%= link_to notification.title, notification_path(notification), class: "notification-title" %>
                  <span>
                    <%= truncate(notification.message, length: 120) %>
                  </span>
                </div>
                <div class="notification-time">
                  <time datetime="<%= notification.created_at.iso8601 %>"><%= time_ago_in_words(notification.created_at) %> ago</time>
                </div>
                <% if (target = notification.target_path_for(current_user)).present? %>
                  <div class="notification-actions" style="margin-top: 0.5rem;">
                    <%= link_to "Open related record", target, class: tailwind_button_classes(:subtle) %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          <div class="notification-footer">
            <%= link_to "View all notifications", notifications_path, class: tailwind_button_classes(:secondary) %>
          </div>
        <% else %>
          <div class="notification">
            <div class="notification-icon"></div>
            <div class="notification-content">
              <div class="notification-text">You're all caught up! New notifications will appear here.</div>
            </div>
          </div>
        <% end %>
      </div>
    </section>

    <!-- Completed Surveys Section -->
    <section class="dashboard-card">
      <h2 class="section-title">
        <div class="section-icon"></div>
        Completed Surveys
      </h2>

      <div class="completed-list">
        <% if @completed_surveys.present? %>
          <% @completed_surveys.each do |entry| %>
            <% survey = entry[:survey] %>
            <% survey_response = entry[:survey_response] %>
            <% download_token = entry[:download_token] %>
            <div class="completed-item">
              <div class="survey-icon"></div>
              <div class="survey-title"><%= survey.title %></div>
              <div class="survey-meta">
                Completed on <%= entry[:completed_at]&.to_date || 'N/A' %>
                <% if entry[:total_count].to_i.positive? %>
                  <span class="survey-progress">&bull; <%= entry[:answered_count] %>/<%= entry[:total_count] %> answered</span>
                <% end %>
              </div>
              <div class="survey-actions">
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;">
                  <%= link_to 'Review', survey_response_path(survey_response), class: tailwind_button_classes(:secondary) %>
                  <%= link_to 'Download PDF', download_survey_response_path(survey_response, token: download_token), class: tailwind_button_classes(:primary), target: "_blank", rel: "noopener noreferrer" %>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="completed-item empty">No completed surveys</div>
        <% end %>
      </div>
    </section>

  </div>
  
  
</main>
