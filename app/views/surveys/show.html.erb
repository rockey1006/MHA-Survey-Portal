<% survey_title = @survey.title.presence || "Survey ##{@survey.id}" %>

<div class="survey-container mx-auto max-w-4xl space-y-8">
  <style>
    .survey-container [id^="survey-section-"],
    .survey-container [id^="survey-category-"],
    .survey-container .question-block {
      scroll-margin-top: 120px;
    }
    .survey-container .indented-description {
      border-left: 2px solid #e2e8f0;
      margin-left: 0.25rem;
      padding-left: 1rem;
    }
  </style>
  <header class="survey-header text-center space-y-1">
    <h1 class="text-2xl font-semibold text-slate-900"><%= @survey.title %></h1>
    <p class="text-sm text-slate-600">
      Semester: <%= @survey.semester.presence || "TBD" %> Â· Tracks: <%= @survey.track_list.presence&.join(", ") || "Unassigned" %>
    </p>
    <p class="text-xs text-slate-500">*
      required to answer
    </p>
  </header>

  <% flash_alert_present = flash[:alert].present? || flash.now[:alert].present? %>
  <% if @invalid_evidence.present? && !flash_alert_present %>
    <div class="rounded-md border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700">
      <p class="font-medium">Please fix the highlighted items:</p>
      <ul class="mt-1 list-disc pl-5">
        <li>One or more evidence links require Google sharing set to "Anyone with the link can view."</li>
      </ul>
    </div>
  <% end %>

  <%= form_with url: submit_survey_path(@survey), method: :post, local: true, data: { turbo: false }, class: "space-y-6 survey-form" do |form| %>
    <% rendered_section_ids = [] %>
    <% invalid_evidence_ids = Array(@invalid_evidence).map(&:to_s) %>
    <% @category_groups.each do |category| %>
      <% section = category.section %>
      <% section_anchor_id = section.present? ? "survey-section-#{section.id}" : nil %>
      <% if section.present? && !rendered_section_ids.include?(section.id) %>
        <div id="<%= section_anchor_id %>" class="space-y-2 rounded-2xl border border-amber-200 bg-amber-50/60 p-5 text-left shadow-sm">
          <p class="text-xs font-semibold uppercase tracking-wide text-amber-700">Section</p>
          <h2 class="text-xl font-bold text-[#500000]"><%= section.title %></h2>
          <% if section.description.present? %>
            <p class="text-sm text-slate-700"><%= section.description %></p>
          <% end %>
        </div>
        <% rendered_section_ids << section.id %>
      <% end %>
      <section id="survey-category-<%= category.id %>" class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm space-y-4">
        <header>
          <h2 class="text-xl font-semibold text-slate-900"><%= category.name %></h2>
          <% category_desc = category.description.to_s.strip.presence %>
          <% if category_desc.present? %>
            <p class="indented-description text-sm text-slate-600"><%= category_desc.gsub(/\r?\n/, '<br>').html_safe %></p>
          <% end %>
        </header>

        <% category.questions.ordered.each_with_index do |question, index| %>
          <% field_name = "answers[#{question.id}]" %>
          <% current_value = @existing_answers[question.id.to_s] %>
          <% required = @computed_required[question.id] %>
          <% evidence_value = if question.question_type == "evidence"
                                current_value.is_a?(Hash) ? current_value["link"] : current_value
                              else
                                nil
                              end %>
          <% missing_required_error = false %>
          <% if request.post? && required %>
            <% if question.question_type == "evidence" %>
              <% missing_required_error = evidence_value.to_s.strip.blank? %>
            <% else %>
              <% missing_required_error = current_value.to_s.strip.blank? %>
            <% end %>
          <% end %>
          <% invalid_evidence_error = question.question_type == "evidence" && invalid_evidence_ids.include?(question.id.to_s) %>
          <% has_error = missing_required_error || invalid_evidence_error %>
          <% article_classes = ["space-y-2", "question-block"] %>
          <% article_classes << "ring-2 ring-rose-300 rounded-lg bg-rose-50/70" if has_error %>

          <article id="question-block-<%= question.id %>" class="<%= article_classes.join(' ') %>" data-question-id="<%= question.id %>">
            <% q_text = question.question_text.to_s.squish %>
            <% desc_text = question.description.to_s.strip.presence %>
            <% tooltip_text = question.tooltip_text.to_s.strip.presence %>
            <% show_mha_tooltip = question.question_type == "multiple_choice" && section&.mha_competency? %>
            <% show_custom_tooltip = tooltip_text.present? && !show_mha_tooltip %>
            <% formatted_desc = desc_text.present? ? desc_text.gsub(/\r?\n/, '<br>').html_safe : nil %>

            <label class="block text-sm font-medium text-slate-900" for="question-<%= question.id %>">
              <span class="font-semibold">Q<%= index + 1 %></span>
              <span class="ml-2 inline-flex flex-col gap-1">
                <span class="flex flex-wrap items-center gap-2">
                  <span><%= q_text %></span>
                  <% if show_mha_tooltip %>
                    <% if tooltip_text.present? %>
                      <span class="inline-flex"><%= render 'shared/question_tooltip', text: tooltip_text, label: "Show proficiency guidance" %></span>
                    <% else %>
                      <span class="inline-flex"><%= render 'shared/proficiency_tooltip' %></span>
                    <% end %>
                  <% elsif show_custom_tooltip %>
                    <span class="inline-flex"><%= render 'shared/question_tooltip', text: tooltip_text %></span>
                  <% end %>
                  <% if required %>
                    <span class="text-red-600" aria-hidden="true">*</span>
                  <% end %>
                </span>
                <% if formatted_desc.present? %>
                  <div class="indented-description text-xs text-slate-600"><%= formatted_desc %></div>
                <% end %>
              </span>
            </label>

            <% case question.question_type %>
            <% when "short_answer" %>
              <%= text_area_tag field_name, current_value, rows: 3, id: "question-#{question.id}", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              
            <% when "multiple_choice" %>
              <% options = question.answer_options_list.presence || [] %>
              <div class="flex flex-col gap-2" role="radiogroup">
                <% options.each do |option| %>
                  <label class="flex items-center gap-2 text-sm text-slate-800">
                    <%= radio_button_tag field_name, option, current_value.to_s == option.to_s, id: "question-#{question.id}-#{option.parameterize}", class: "h-4 w-4 text-blue-600" %>
                    <span><%= option %></span>
                  </label>
                <% end %>
              </div>
              
            <% when "scale" %>
              <div class="flex items-center gap-3">
                <span class="text-xs text-slate-500">Low</span>
                <%= range_field_tag field_name, current_value || 3, in: 1..5, step: 1, id: "question-#{question.id}", class: "w-full" %>
                <span class="text-xs text-slate-500">High</span>
              </div>
              
            <% when "evidence" %>
              <%= text_field_tag field_name, evidence_value, id: "question-#{question.id}", placeholder: "https://drive.google.com/...", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              <% if invalid_evidence_error %>
                <div class="text-xs text-red-600 mt-1">Link is invalid or not publicly accessible</div>
              <% elsif missing_required_error %>
                <div class="text-xs text-red-600 mt-1">This question is required</div>
              <% end %>
              
            <% else %>
              <%= text_field_tag field_name, current_value, id: "question-#{question.id}", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              
            <% end %>

            <% if missing_required_error && question.question_type != "evidence" %>
              <div class="text-xs text-red-600 mt-1">This question is required</div>
            <% end %>

          </article>
        <% end %>
      </section>
    <% end %>

    <div class="flex items-center justify-between gap-3">
      <%= button_tag "Save Progress", type: "button", class: "inline-flex items-center rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 focus:outline-none focus-visible:ring focus-visible:ring-slate-500/70", onclick: "saveSurveyProgress()" %>
      <%= form.submit "Submit Survey", class: "inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-500 focus:outline-none focus-visible:ring focus-visible:ring-blue-500/70" %>
    </div>
  <% end %>

  <% if request.post? && (@first_error_question_id.present? || @scroll_to_form_top) %>
    <script>
      (function() {
        var scrolled = false;
        function runScroll() {
          if (scrolled) return;
          scrolled = true;
          <% if @scroll_to_form_top %>
            window.scrollTo({ top: 0, behavior: "smooth" });
          <% end %>
          <% if @first_error_question_id.present? %>
            var field = document.getElementById("question-<%= @first_error_question_id %>");
            var block = document.getElementById("question-block-<%= @first_error_question_id %>");
            if (!block) {
              block = document.querySelector('[data-question-id="<%= @first_error_question_id %>"]');
            }
            var sectionTargetId = "<%= j(@first_error_section_dom_id.to_s) %>";
            var sectionBlock = sectionTargetId ? document.getElementById(sectionTargetId) : null;
            var target = block || field || sectionBlock;
            if (target && target.scrollIntoView) {
              var blockOption = (target === sectionBlock) ? "start" : "center";
              var performScroll = function() {
                target.scrollIntoView({ behavior: "smooth", block: blockOption });
              };
              if (window.requestAnimationFrame) {
                window.requestAnimationFrame(performScroll);
              } else {
                setTimeout(performScroll, 0);
              }
            }
            if (field && typeof field.focus === "function") {
              try { field.focus({ preventScroll: true }); } catch (err) {}
            } else if (block && typeof block.focus === "function") {
              if (!block.hasAttribute('tabindex')) { block.setAttribute('tabindex', '-1'); }
              try { block.focus({ preventScroll: true }); } catch (err) {}
            }
          <% end %>
        }
        if (document.readyState === "complete" || document.readyState === "interactive") {
          runScroll();
        } else {
          document.addEventListener("DOMContentLoaded", runScroll, { once: true });
        }
        document.addEventListener("turbo:load", runScroll, { once: true });
      })();
    </script>
  <% end %>

  <script>
    function saveSurveyProgress() {
      const form = document.querySelector('.survey-form');
      const originalAction = form.action;
      
      // Change to save_progress endpoint
      form.action = '<%= save_progress_survey_path(@survey) %>';
      
      // Submit the form
      form.submit();
    }
  </script>
</div>