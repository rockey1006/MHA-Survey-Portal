<% survey_name =
  case @survey.id
  when 1 then "Current Residential and Executive MHA Track Study Survey"
  when 2 then "Competency Self-Assessment Survey"
  when 3 then "Final Feedback Survey"
  else "Survey ##{@survey.id}"
  end
%>

<div class="mx-auto flex max-w-5xl flex-col gap-8 rounded-2xl bg-white p-8 shadow-sm ring-1 ring-slate-200">
  <div class="space-y-1">
    <h1 class="text-3xl font-semibold text-[#500000]"><%= survey_name %></h1>
    <p class="text-sm text-slate-500">Please complete each required competency question before submitting.</p>
  </div>

  <%= form_with url: submit_survey_path(@survey), local: true, class: "survey-form space-y-6" do |f| %>
    <% if @survey.respond_to?(:categories) && @survey.categories.any? %>
      <%# global question counter across categories (number dependent questions as same number as parent) %>
      <% q_number = 0 %>
      <%# Render questions grouped by category (competency) so evidence fields appear under each competency %>
      <% @survey.categories.order(:id).each do |cat| %>
        <section class="space-y-5 rounded-2xl border border-slate-200 bg-slate-50/70 p-6 shadow-sm">
          <h3 class="text-xl font-semibold text-slate-800"><%= cat.name %></h3>
          <% if cat.questions.any? %>
            <% cat.questions.order(:question_order).each do |q| %>
              <% depends_on_qid = q.depends_on_question_id %>
              <% depends_on_val = q.depends_on_value %>
              <% # Treat questions as dependent if they are explicitly marked as depending on another question or their text starts with 'If yes'/'If no' %>
              <% dependent_by_text = q.question.to_s.strip.match?(/^\s*If\s+(yes|no)/i) rescue false %>
              <% numbered = depends_on_qid.blank? && !dependent_by_text %>
              <% if numbered %>
                <% q_number += 1 %>
              <% end %>
              <%# detect simple Yes/No multiple choice questions to exclude them from required-star behavior %>
              <% raw_opts = (q.answer_options || '').to_s %>
              <% parsed_opts = raw_opts.gsub(/[\[\]\"“”]/, '').split(',').map(&:strip).map(&:downcase) rescue [] %>
              <%# Per UX: any numbered question is required. Dependents (If yes/If no) remain unnumbered and not required. %>
              <% data_required = numbered %>
              <div class="question-block space-y-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm" data-question-id="<%= q.id %>" data-depends-on-question-id="<%= depends_on_qid %>" data-depends-on-value="<%= depends_on_val %>" data-numbered="<%= numbered %>" data-question-number="<%= (numbered ? q_number : '') %>" data-required="<%= data_required %>">
                <label class="flex items-start gap-2 text-sm font-medium text-slate-800">
                  <% if numbered %>
                    <span class="text-sm font-semibold text-[#500000]"><%= q_number %>.</span>
                  <% end %>
                  <span class="leading-6">
                    <%= q.question || "Question #{q.id}" %>
                    <% if data_required %>
                      <span class="ml-2 text-xs font-semibold uppercase tracking-wide text-rose-600">Required</span>
                    <% end %>
                  </span>
                </label>

                <% case q.question_type %>
                <% when 'short_answer' %>
                  <%= text_area_tag "answers[#{q.id}]",
                                    (@existing_answers[q.id] || nil),
                                    class: "w-full max-w-full break-words rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#500000] resize-none",
                                    rows: 3 %>
                <% when 'multiple_choice' %>
                  <% raw_opts = (q.answer_options || '').to_s %>
                  <% parsed = begin
                    JSON.parse(raw_opts) rescue nil
                  end %>
                  <% if parsed.is_a?(Array)
                       options = parsed.map(&:to_s)
                     else
                       options = raw_opts.gsub(/[\[\]\"“”]/, '').split(',').map(&:strip)
                     end %>
                  <div class="multiple-choice-options flex flex-wrap gap-2" role="group" aria-label="Options">
                    <% options.each do |opt| %>
                      <% checked = (@existing_answers[q.id].to_s == opt.to_s) %>
                      <label class="mc-btn inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-1 text-sm font-medium text-slate-700 shadow-sm transition data-[checked=true]:border-[#500000] data-[checked=true]:bg-[#f9f2f2] data-[checked=true]:text-[#500000]" data-value="<%= opt %>" data-qid="<%= q.id %>" data-checked="<%= checked %>">
                        <%= radio_button_tag "answers[#{q.id}]", opt, checked, data: { question_id: q.id }, class: "hidden" %>
                        <span class="mc-circle inline-flex h-3 w-3 items-center justify-center rounded-full border border-slate-400" aria-hidden="true"></span>
                        <span class="mc-label"><%= opt %></span>
                      </label>
                    <% end %>
                  </div>
                <% when 'scale' %>
                  <% options = (1..5).to_a.map(&:to_s) %>
                  <%= select_tag "answers[#{q.id}]",
                                  options_for_select(options, @existing_answers[q.id]&.to_s),
                                  include_blank: true,
                                  class: "w-full max-w-xs rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#500000]" %>
                <% when 'evidence' %>
                  <div class="evidence-input space-y-2">
                    <%= label_tag "answers[#{q.id}]", 'Google Drive link (file or folder):', class: "text-sm font-medium text-slate-700" %>
                    <%# prefill with latest existing evidence for this question if present, fallback to stored answer %>
                    <% latest_q_link = @existing_evidence_by_question && @existing_evidence_by_question[q.id]&.first&.link %>
                    <%= text_field_tag "answers[#{q.id}]",
                                       (latest_q_link || @existing_answers[q.id] || nil),
                                       class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#500000]",
                                       placeholder: 'https://drive.google.com/...'%>
                    <p class="text-sm text-slate-500">Paste a Google Drive file or folder link here. Previous submissions are shown below for audit.</p>

                    <%# Show history attached specifically to this question (if any) %>
                    <% if @existing_evidence_by_question && @existing_evidence_by_question[q.id] %>
                      <div class="existing-evidence-list space-y-2">
                        <p class="text-sm font-semibold text-slate-700">Previous submissions for this question:</p>
                        <ul class="list-disc space-y-1 pl-5 text-sm text-slate-600">
                          <% @existing_evidence_by_question[q.id].each do |eu| %>
                            <li><a class="text-[#500000] underline hover:text-[#330000]" href="<%= eu.link %>" target="_blank" rel="noopener noreferrer"><%= eu.link %></a> — <span class="text-xs text-slate-500"><%= eu.created_at.strftime('%F %T') rescue eu.created_at %></span></li>
                          <% end %>
                        </ul>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <%= text_field_tag "answers[#{q.id}]",
                                     (@existing_answers[q.id] || nil),
                                     class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#500000]" %>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="rounded-lg border border-dashed border-slate-300 bg-white p-4 text-sm text-slate-600">No questions for this competency.</p>
          <% end %>

          <!-- Per-category evidence upload (render after questions for the competency) -->
          <div class="category-evidence-upload space-y-2">
            <% latest_cat_link = @existing_evidence_by_category && @existing_evidence_by_category[cat.id]&.first&.link %>
            <%= label_tag "evidence_links_by_category[#{cat.id}]", 'Upload evidence for this competency (Google Drive link):', class: "text-sm font-medium text-slate-700" %>
            <%= text_field_tag "evidence_links_by_category[#{cat.id}]",
                               (latest_cat_link || ''),
                               class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#500000]",
                               placeholder: 'https://drive.google.com/...'%>
            <p class="text-sm text-slate-500">This link will be attached to the competency. If there is an evidence question defined it will be used; otherwise a question will be created to record this upload.</p>
          </div>
        </section>
      <% end %>
    <% else %>
      <!-- Fallback sample questions if none exist in DB -->
      <div class="space-y-2 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
        <label class="text-sm font-semibold text-slate-700">Sample free text</label>
        <%= text_area_tag "answers[sample_text]", nil, class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#500000] resize-none" %>
      </div>
    <% end %>

    <div class="flex justify-end">
      <%= f.submit "Submit Survey", class: tailwind_button_classes(:primary) %>
    </div>
  <% end %>
</div>

  <script>
    // Initialize survey UI controls. Works both on full page loads and Turbo visits.
    function initSurveyControls() {
      if (window._surveyControlsInitialized) return;
      window._surveyControlsInitialized = true;

      // Toggle dependent questions visibility
      function evaluateDependency(qBlock) {
        var dependsOn = qBlock.dataset.dependsOnQuestionId;
        var dependsValue = qBlock.dataset.dependsOnValue;
        if (!dependsOn || dependsOn === "") { qBlock.style.display = ''; return; }
        var selector = '[name="answers[' + dependsOn + ']"]';
        var el = document.querySelector(selector);
        var visible = false;
        if (!el) {
          // maybe radio buttons
          var radios = document.querySelectorAll('input[name="answers['+dependsOn+']"]');
          radios.forEach(function(r){ if (r.checked && (dependsValue==='' || r.value==dependsValue)) visible = true; });
        } else {
          var val = el.value;
          if (dependsValue === '' || val == dependsValue) visible = true;
        }
        qBlock.style.display = visible ? '' : 'none';
      }

      document.querySelectorAll('.question-block').forEach(function(qb) {
        evaluateDependency(qb);
      });

      document.body.addEventListener('change', function(e){
        if (!e.target.name) return;
        var m = e.target.name.match(/^answers\[(\d+)\]/);
        if (!m) return;
        var changedQid = m[1];
        document.querySelectorAll('.question-block').forEach(function(qb){
          if (qb.dataset.dependsOnQuestionId === changedQid) evaluateDependency(qb);
        });
      });

      // multiple choice nice buttons: clicking label toggles radio and selected state
      document.querySelectorAll('.multiple-choice-options').forEach(function(group){
        group.querySelectorAll('.mc-btn').forEach(function(btn){
          btn.dataset.checked = btn.querySelector('input[type="radio"]').checked ? 'true' : 'false';
        });

        group.addEventListener('click', function(e){
          var target = e.target.closest('.mc-btn');
          if (!target) return;
          var qid = target.dataset.qid;
          var value = target.dataset.value;

          group.querySelectorAll('.mc-btn').forEach(function(lb){
            lb.dataset.checked = 'false';
          });

          target.dataset.checked = 'true';

          var radios = group.querySelectorAll('input[type="radio"]');
          var matched = null;
          radios.forEach(function(r){
            if (r.name === 'answers[' + qid + ']' && r.value == value) matched = r;
          });
          if (matched) {
            matched.checked = true;
            matched.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', initSurveyControls);
    document.addEventListener('turbo:load', initSurveyControls);
  </script>

  <script>
    // Client-side validation for required numbered questions (except simple yes/no)
    (function(){
      function showInlineError(qBlock, msg) {
        var existing = qBlock.querySelector('.inline-error');
        if (!existing) {
          existing = document.createElement('div');
          existing.className = 'inline-error mt-1 text-sm font-semibold text-rose-600';
          existing.setAttribute('role', 'alert');
          qBlock.appendChild(existing);
        }
        existing.textContent = msg;
      }
      function clearInlineError(qBlock){
        var existing = qBlock.querySelector('.inline-error');
        if (existing) existing.remove();
      }

  var form = document.querySelector('.survey-form');
      if (!form) return;

  // Drive link regex for client-side validation (matches Drive/docs/spreadsheets/forms and open?id patterns)
  var driveRegex = /^https?:\/\/(?:drive\.google\.com|docs\.google\.com)\/(?:file\/d\/|drive\/folders\/|document\/d\/|spreadsheets\/d\/|forms\/d\/|open\?).+/i;

      form.addEventListener('submit', function(e){
        var invalid = [];
        var invalidCategoryLinks = [];

        // Validate per-category evidence link inputs (only when a value is present)
        document.querySelectorAll('.category-evidence-upload').forEach(function(catDiv){
          var input = catDiv.querySelector('input[name^="evidence_links_by_category"]');
          if (!input) return;
          var v = input.value ? input.value.toString().trim() : '';
          if (!v) {
            // clear any previous inline error
            clearInlineError(catDiv);
            return;
          }
          if (!driveRegex.test(v)) {
            invalidCategoryLinks.push(catDiv);
            showInlineError(catDiv, 'Invalid Google Drive link. Please enter a valid file or folder link.');
          } else {
            clearInlineError(catDiv);
          }
        });
        document.querySelectorAll('.question-block').forEach(function(qb){
          var required = qb.dataset.required === 'true' || qb.getAttribute('data-required') === 'true';
          if (!required) { clearInlineError(qb); return; }
          var qid = qb.dataset.questionId;
          var name = 'answers[' + qid + ']';
          var val = null;
          // Prefer explicit radio-group check: radios may exist and should be checked for .checked
          var radios = qb.querySelectorAll('input[type="radio"][name="' + name + '"]');
          if (radios && radios.length > 0) {
            radios.forEach(function(r){ if (r.checked) val = r.value; });
          } else {
            var input = qb.querySelector('[name="' + name + '"]');
            if (input) val = input.value;
          }
          if (!val || val.toString().trim() === '') {
            invalid.push(qb);
            showInlineError(qb, 'This question is required — please answer before submitting.');
          } else {
            clearInlineError(qb);
          }
        });
        if (invalid.length) {
          e.preventDefault();
          // scroll to first invalid
          invalid[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        if (invalidCategoryLinks.length) {
          e.preventDefault();
          invalidCategoryLinks[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
    })();
  </script>

</div>
