<% question = question_fields.object %>
<% question_uid = question.persisted? ? "question-#{question.id}" : "question-temp-#{question.object_id}" %>
<% supports_sub_questions = question.respond_to?(:parent_question_id) && question.respond_to?(:sub_question_order) %>
<% is_sub_question = supports_sub_questions && question.parent_question_id.present? %>
<% can_add_sub_questions = supports_sub_questions && !is_sub_question %>
<% wrapper_classes = ["question-block", "rounded-lg", "border", "border-slate-100", "bg-slate-50/40", "p-4", "space-y-4"] %>
<% wrapper_classes << "ml-6" if is_sub_question %>
<div id="<%= question_uid %>"
  class="<%= wrapper_classes.join(' ') %>"
  data-question-fields-target="item"
  data-builder-kind="question"
  data-builder-label="<%= question.question_text.to_s.strip.presence || 'Untitled question' %>">
  <%= question_fields.hidden_field :id %>
  <%= question_fields.hidden_field :_destroy, value: 0 %>
  <%= question_fields.hidden_field :question_order %>

  <% question_type_value = question_fields.object.question_type.to_s %>
  <% supports_description = true %>

  <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
    <div class="flex-1 space-y-2">
      <div class="flex items-center justify-between gap-3">
        <span class="js-drag-handle select-none rounded-md border border-slate-200 bg-white px-2 py-1 text-xs font-semibold text-slate-500 cursor-grab" aria-label="Drag to reorder">
          ‚ãÆ‚ãÆ
        </span>
        <span class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
          <span aria-hidden="true">‚ùì</span>
          <span>Question</span>
        </span>
      </div>
      <%= question_fields.label :question_text, "Prompt", class: "block text-sm font-medium text-slate-700" %>
      <%= question_fields.text_area :question_text,
            class: textarea_classes,
            placeholder: "Describe the competency being assessed." %>
      <% if supports_description %>
        <%= question_fields.label :description, "Question description (optional)", class: "block text-xs font-semibold uppercase tracking-wide text-slate-500" %>
        <%= question_fields.text_area :description, class: textarea_classes, placeholder: "Shown under the prompt for everyone completing the survey." %>
      <% end %>

      <%= question_fields.label :tooltip_text, "Tooltip text (optional)", class: "block text-xs font-semibold uppercase tracking-wide text-slate-500" %>
      <%= question_fields.text_area :tooltip_text, class: textarea_classes, placeholder: "Appears inside the tooltip icon when defined." %>
      <% tooltip_preview = question_fields.object.tooltip_text.to_s.strip.presence %>
      <% if tooltip_preview.present? %>
        <div class="flex items-center gap-2 text-xs text-slate-500">
          <span>Tooltip preview:</span>
          <%= render 'shared/question_tooltip', text: tooltip_preview %>
        </div>
      <% end %>
    </div>

    <div class="flex flex-wrap items-center justify-end gap-2">
      <% if can_add_sub_questions %>
        <% if question.persisted? %>
          <button type="button"
                  class="<%= tailwind_button_classes(:subtle, extra_classes: 'btn-sm') %>"
                  data-action="survey-builder#addSubQuestion"
                  data-parent-question-id="<%= question.id %>">
            <span aria-hidden="true">‚Ü≥</span>
            <span>Add sub-question</span>
          </button>
        <% else %>
          <button type="button"
                  class="<%= tailwind_button_classes(:subtle, extra_classes: 'btn-sm') %> opacity-60"
                  aria-disabled="true"
                  title="Save the survey first to add sub-questions.">
            <span aria-hidden="true">‚Ü≥</span>
            <span>Add sub-question</span>
          </button>
        <% end %>
      <% end %>

      <button type="button"
              class="<%= tailwind_button_classes(:secondary, extra_classes: 'btn-sm') %> text-rose-600"
              data-action="question-fields#remove">
        <span aria-hidden="true">üóëÔ∏è</span>
        <span>Remove</span>
      </button>
    </div>
  </div>

  <div class="flex flex-wrap items-center gap-x-6 gap-y-4">
    <div class="flex min-w-[12rem] flex-col gap-1">
      <%= question_fields.label :question_type, "Response type", class: "block text-xs font-semibold uppercase tracking-wide text-slate-500" %>
      <%= question_fields.select :question_type,
                options_for_select(@question_types.map { |type| [type.humanize, type] }, question_fields.object.question_type),
                {},
                class: input_classes %>
    </div>

    <div class="flex items-center gap-2 text-sm text-slate-700">
      <%= question_fields.check_box :is_required, class: checkbox_classes %>
      <%= question_fields.label :is_required, "Required response", class: "cursor-pointer select-none" %>
    </div>

    <div class="flex items-center gap-2 text-sm text-slate-700">
      <%= question_fields.check_box :has_evidence_field, class: checkbox_classes %>
      <%= question_fields.label :has_evidence_field, "Include evidence field", class: "cursor-pointer select-none" %>
    </div>

    <% if question.respond_to?(:has_feedback) %>
      <div class="flex items-center gap-2 text-sm text-slate-700">
        <%= question_fields.check_box :has_feedback, class: checkbox_classes %>
        <%= question_fields.label :has_feedback, "Collect advisor feedback", class: "cursor-pointer select-none" %>
      </div>
    <% end %>

    <% if question.respond_to?(:program_target_level) %>
      <div class="flex min-w-[12rem] flex-col gap-1">
        <%= question_fields.label :program_target_level, "Program target level", class: "block text-xs font-semibold uppercase tracking-wide text-slate-500" %>
        <%= question_fields.select :program_target_level,
                                   options_for_select([["None", ""]] + (1..5).map { |level| ["#{level}/5", level] }, question.program_target_level),
                                   {},
                                   class: input_classes %>
      </div>
    <% end %>
  </div>

  <% if supports_sub_questions %>
    <%= question_fields.hidden_field :sub_question_order %>
    <% category = question.category %>
    <% persisted_parent_candidates = if category.present?
      category.questions.to_a.select do |candidate|
        candidate != question &&
          candidate.id.present? &&
          (!candidate.respond_to?(:parent_question_id) || candidate.parent_question_id.blank?)
      end
    else
      []
    end %>
    <% parent_options = [["(No parent ‚Äî this is a parent question)", ""]] + persisted_parent_candidates.map { |candidate| [candidate.question_text.to_s.truncate(80), candidate.id] } %>

    <div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
      <div class="grid gap-4 md:grid-cols-2">
        <div class="space-y-1">
          <%= question_fields.label :parent_question_id, "Sub-question parent", class: "block text-xs font-semibold uppercase tracking-wide text-slate-500" %>
          <%= question_fields.select :parent_question_id,
                                     options_for_select(parent_options, question.parent_question_id),
                                     {},
                                     class: input_classes,
                                     disabled: persisted_parent_candidates.empty? %>
          <% if persisted_parent_candidates.empty? %>
            <p class="text-xs text-slate-500">Save the survey first, then edit to link sub-questions to a parent (parent questions need IDs).</p>
          <% else %>
            <p class="text-xs text-slate-500">Choose a parent question to make this a sub-question. Leave blank for a normal question.</p>
          <% end %>
        </div>

        <div class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Sub-question order</p>
          <p class="text-xs text-slate-500">Controlled by drag-and-drop when a parent is selected.</p>
        </div>
      </div>
    </div>
  <% end %>

  <div class="space-y-2">
    <%= question_fields.label :answer_options, "Answer options", class: "block text-sm font-medium text-slate-700" %>
    <%= question_fields.text_area :answer_options, class: textarea_classes, placeholder: "Comma separated values for multiple choice questions." %>
  </div>
</div>
