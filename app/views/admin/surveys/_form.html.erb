<% selected_question_ids = Array(survey.question_ids) %>
<% selected_advisor_ids = Array(survey.assigned_advisor_ids) %>
<% selected_category_ids = Array(survey.tagged_category_ids) %>

<%= form_with(model: [:admin, survey], local: true, class: "survey-form") do |form| %>
  <% if survey.errors.any? %>
    <div class="form-errors">
      <h2><%= pluralize(survey.errors.count, "error") %> prevented this survey from being saved:</h2>
      <ul>
        <% survey.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="survey-form-layout">
    <div class="survey-form-main">
      <section class="form-card">
        <header class="form-card-header">
          <span class="step-pill">Step 1</span>
          <div>
            <h2 class="section-heading">Survey Basics</h2>
            <p class="section-subtext">Give the survey a clear title, the semester it applies to, and the track it supports.</p>
          </div>
        </header>

        <div class="form-grid">
          <div class="form-field">
            <%= form.label :title, "Survey Title" %>
            <%= form.text_field :title, required: true, class: "input", placeholder: "Capstone Competency Survey" %>
          </div>

          <div class="form-field">
            <%= form.label :semester, "Semester" %>
            <%= form.text_field :semester, required: true, placeholder: "Fall 2025", class: "input" %>
          </div>

          <div class="form-field">
            <%= form.label :track, "Program Track" %>
            <%= form.text_field :track, list: "survey-track-options", placeholder: "Residential", class: "input" %>
            <datalist id="survey-track-options">
              <% @track_options.each do |track_option| %>
                <option value="<%= track_option %>"></option>
              <% end %>
            </datalist>
            <p class="field-hint">Tracks help advisors locate the right survey for their advisees.</p>
          </div>
        </div>
      </section>

      <section class="form-card">
        <header class="form-card-header">
          <span class="step-pill">Step 2</span>
          <div>
            <h2 class="section-heading">Audience &amp; Tags</h2>
            <p class="section-subtext">Decide who can distribute the survey and how it should be grouped.</p>
          </div>
        </header>

        <div class="form-columns">
          <div class="form-column">
            <label class="section-subheading" for="survey_assigned_advisor_ids">Advisor Visibility</label>
            <p class="field-hint">Select advisors who should see this survey in their dashboard.</p>
            <%= form.select :assigned_advisor_ids,
              options_from_collection_for_select(@advisors, :advisor_id, :display_name, selected_advisor_ids),
              { include_hidden: false },
              multiple: true,
              size: 8,
              class: "multi-select" %>
          </div>

          <div class="form-column">
            <label class="section-subheading" for="survey_tagged_category_ids">Competency Categories</label>
            <p class="field-hint">Tagging helps filter surveys by competency focus areas.</p>
            <%= form.select :tagged_category_ids,
              options_from_collection_for_select(@categories, :id, :name, selected_category_ids),
              { include_hidden: false },
              multiple: true,
              size: 8,
              class: "multi-select" %>
          </div>
        </div>
      </section>

      <section class="form-card">
        <header class="form-card-header">
          <span class="step-pill">Step 3</span>
          <div>
            <h2 class="section-heading">Questions</h2>
            <p class="section-subtext">Pick the prompts advisors and students will respond to. Questions stay in their original order.</p>
          </div>
          <span class="count-pill"><%= selected_question_ids.size %> selected</span>
        </header>

        <div class="question-toolbar">
          <div class="question-toolbar__links">
            <%= link_to "Add question", new_admin_question_path, class: "btn btn-secondary" %>
            <%= link_to "Manage question bank", admin_questions_path, class: "btn" %>
          </div>
          <p class="question-toolbar__hint">Need a new prompt or edits to existing ones? Use the actions above, then return here to attach them to this survey.</p>
        </div>

        <div class="question-groups">
          <% grouped_questions = @questions.group_by { |question| question.categories.map(&:name).presence || ["General"] } %>
          <% grouped_questions.sort_by { |names, _| names.first.to_s.downcase }.each do |names, questions| %>
            <details class="question-group" <%= "open" if questions.any? { |q| selected_question_ids.include?(q.id) } %>>
              <summary>
                <span class="group-title"><%= Array(names).join(", ") %></span>
                <span class="group-count"><%= pluralize(questions.size, "question") %></span>
              </summary>

              <div class="question-selection">
                <% questions.sort_by(&:question_order).each do |question| %>
                  <% checkbox_id = "survey-question-#{question.id}" %>
                  <label class="question-option" for="<%= checkbox_id %>">
                    <span class="question-checkbox">
                      <%= check_box_tag "survey[question_ids][]", question.id, selected_question_ids.include?(question.id), id: checkbox_id %>
                    </span>
                    <span class="question-content">
                      <span class="question-text"><%= question.question %></span>
                      <span class="question-meta"><%= question.question_type.humanize %></span>
                    </span>
                  </label>
                <% end %>
              </div>
            </details>
          <% end %>
        </div>
      </section>

      <div class="form-actions">
        <%= form.submit(survey.persisted? ? "Update Survey" : "Create Survey", class: "btn btn-primary") %>
        <%= link_to "Cancel", admin_surveys_path, class: "btn btn-secondary" %>
      </div>
    </div>

    <aside class="survey-form-sidebar">
      <div class="summary-card">
        <h3>Survey at a glance</h3>
        <ul class="summary-list">
          <li>
            <span>Advisor access</span>
            <strong><%= selected_advisor_ids.size %></strong>
          </li>
          <li>
            <span>Tagged categories</span>
            <strong><%= selected_category_ids.size %></strong>
          </li>
          <li>
            <span>Questions selected</span>
            <strong><%= selected_question_ids.size %></strong>
          </li>
        </ul>
      </div>

      <div class="summary-card">
        <h3>Tips</h3>
        <ul class="summary-notes">
          <li>Multi-select lists support CTRL/âŒ˜ click for granular choices.</li>
          <li>Leave advisor visibility empty to draft a survey without publishing it.</li>
          <li>Questions stay aligned with their original numbering in the student view.</li>
        </ul>
      </div>
    </aside>
  </div>
<% end %>
