<main class="main-content space-y-12">

  <div class="c-toolbar c-toolbar--spaced">
    <div class="c-toolbar__row justify-between w-full">
      <%= link_to "← Back",
                  admin_dashboard_path,
                  class: tailwind_button_classes(:secondary),
                  data: { turbo: false } %>

      <div class="flex flex-wrap gap-3">
        <% if defined?(admin_survey_change_logs_path) %>
          <%= link_to "View Change Log", admin_survey_change_logs_path, class: tailwind_button_classes(:secondary) %>
        <% end %>
        <%= link_to "Create Survey", new_admin_survey_path, class: tailwind_button_classes(:primary) %>
      </div>
    </div>
  </div>

  <section class="flex w-full flex-col gap-6 sm:flex-row sm:items-start sm:justify-between">
    <div class="space-y-2">
      <h1 class="text-3xl font-semibold tracking-tight text-slate-900">Survey Builder</h1>
      <p class="text-sm text-slate-600">Launch new advisor surveys, monitor what is live, and review the audit trail of recent changes.</p>
    </div>
  </section>

  <% active_count = @active_surveys.size %>
  <% archived_count = @archived_surveys.size %>
  <% total_questions = @active_surveys.sum { |survey| survey.respond_to?(:question_count) ? survey.question_count.to_i : survey.questions.size } %>
  <% latest_activity_at = (@recent_logs.first&.created_at || @active_surveys.map(&:updated_at).compact.max) %>

  <section class="c-stats-grid">
    <div class="c-stat c-stat--info">
      <p class="c-stat__label">Active surveys</p>
      <p class="c-stat__value c-stat__value--lg"><%= active_count %></p>
      <p class="c-stat__subtext">Currently visible to advisors</p>
    </div>
    <div class="c-stat c-stat--success">
      <p class="c-stat__label">Question inventory</p>
      <p class="c-stat__value c-stat__value--lg"><%= number_with_delimiter(total_questions) %></p>
      <p class="c-stat__subtext">Across all active surveys</p>
    </div>
    <div class="c-stat c-stat--warning">
      <p class="c-stat__label">Archived surveys</p>
      <p class="c-stat__value c-stat__value--lg"><%= archived_count %></p>
      <p class="c-stat__subtext">Ready to reactivate when needed</p>
    </div>
    <div class="c-stat c-stat--muted">
      <p class="c-stat__label">Last change</p>
      <% if latest_activity_at.present? %>
        <p class="c-stat__value c-stat__value--md"><%= time_ago_in_words(latest_activity_at) %></p>
        <p class="c-stat__subtext">ago via admin activity</p>
      <% else %>
        <p class="c-stat__value c-stat__value--md">—</p>
        <p class="c-stat__subtext">No edits recorded yet</p>
      <% end %>
    </div>
  </section>

  <section class="w-full space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Active surveys</h2>
        <p class="text-sm text-slate-600">Search, filter, and sort active surveys currently visible to advisors.</p>
      </div>
      <% if @active_surveys.present? %>
        <span class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700"><%= pluralize(@active_surveys.size, "active survey") %></span>
      <% end %>
    </header>

    <div class="w-full c-card c-card--flush">
      <div class="border-b border-slate-200 p-5">
        <%= form_with url: admin_surveys_path, method: :get, local: true, class: "flex w-full flex-wrap items-center gap-3 md:flex-nowrap" do %>
          <%= hidden_field_tag :sort, @sort_column %>
          <%= hidden_field_tag :direction, @sort_direction %>

          <div class="relative flex-1 min-w-[220px]">
            <%= text_field_tag :q, @search_query, placeholder: "Search by title, semester, or description", class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 pr-16 text-sm text-slate-900 shadow-sm placeholder:text-slate-400 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" %>
            <% if @search_query.present? %>
              <button type="submit" name="q" value="" class="absolute inset-y-0 right-3 flex items-center text-xs font-semibold text-slate-400 hover:text-slate-600">Clear</button>
            <% end %>
          </div>

          <div class="md:w-48">
            <%= select_tag :track,
                           options_for_select([
                             ["All tracks", ""],
                             ["Unassigned", @unassigned_track_token]
                           ] + @track_filter_options.map { |track| [track, track] }, @selected_track),
                           class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" %>
          </div>

          <div class="flex items-center gap-3">
            <%= submit_tag "Apply", class: tailwind_button_classes(:primary) %>
            <% if @search_query.present? || @selected_track.present? %>
              <%= link_to "Reset", admin_surveys_path(sort: @sort_column, direction: @sort_direction), class: tailwind_button_classes(:subtle) %>
            <% end %>
          </div>
        <% end %>
        <% if @search_query.present? || @selected_track.present? %>
          <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
            <% if @search_query.present? %>
              <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">Search: "<%= @search_query %>"</span>
            <% end %>
            <% if @selected_track.present? %>
              <% track_label = @selected_track == @unassigned_track_token ? "Unassigned" : @selected_track %>
              <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">Track: <%= track_label %></span>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if @active_surveys.blank? %>
        <div class="p-6 text-center text-sm text-slate-500">No surveys match the current search or filter criteria.</div>
      <% else %>
        <div class="c-table-wrapper">
          <table class="c-table min-w-full w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold"><%= sortable_header("Title", "title") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold"><%= sortable_header("Semester", "semester") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold">Tracks</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold"><%= sortable_header("Categories", "category_count") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold"><%= sortable_header("Questions", "question_count") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold"><%= sortable_header("Updated", "updated_at") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 text-slate-600">
              <% @active_surveys.each do |survey| %>
                <% category_count = survey.respond_to?(:category_count) ? survey.category_count.to_i : survey.categories.size %>
                <% question_count = survey.respond_to?(:question_count) ? survey.question_count.to_i : survey.questions.size %>
                <% tracks = survey.track_list %>
                <tr class="hover:bg-slate-50">
                  <td class="px-4 py-3 align-top">
                    <div class="font-semibold text-slate-900"><%= survey.title %></div>
                    <div class="mt-1 text-xs text-slate-500"><%= survey.description.presence || "No description provided." %></div>
                  </td>
                  <td class="whitespace-nowrap px-4 py-3 align-top text-slate-700"><%= survey.semester.presence || "Unscheduled" %></td>
                  <td class="px-4 py-3 align-top">
                    <% if tracks.present? %>
                      <div class="flex flex-wrap gap-1">
                        <% tracks.each do |track| %>
                          <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600"><%= track %></span>
                        <% end %>
                      </div>
                    <% else %>
                      <span class="text-xs font-medium text-amber-600">Unassigned</span>
                    <% end %>
                  </td>
                  <td class="whitespace-nowrap px-4 py-3 text-right font-semibold text-slate-900"><%= category_count %></td>
                  <td class="whitespace-nowrap px-4 py-3 text-right font-semibold text-slate-900"><%= question_count %></td>
                  <td class="whitespace-nowrap px-4 py-3 align-top text-right text-slate-500"><%= time_ago_in_words(survey.updated_at) %> ago</td>
                  <td class="px-4 py-3 align-top">
                    <div class="flex flex-wrap justify-end gap-2">
                      <%= link_to "Preview", preview_admin_survey_path(survey), class: tailwind_button_classes(:subtle, extra_classes: "btn-sm") %>
                      <%= link_to "Edit", edit_admin_survey_path(survey), class: tailwind_button_classes(:subtle, extra_classes: "btn-sm") %>
                      <%= button_to "Archive", archive_admin_survey_path(survey), method: :patch, data: { turbo_confirm: "Archive '#{survey.title}' and remove it from advisors?" }, class: tailwind_button_classes(:secondary) %>
                      <%= button_to "Delete", admin_survey_path(survey), method: :delete, data: { turbo_confirm: "Delete '#{survey.title}' permanently?" }, class: tailwind_button_classes(:danger) %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </section>

  <section class="w-full space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Archived surveys</h2>
        <p class="text-sm text-slate-600">Re-activate an archived survey to make it available for new assignments.</p>
      </div>
      <% if @archived_surveys.present? %>
        <span class="inline-flex items-center rounded-full bg-slate-200 px-3 py-1 text-xs font-semibold text-slate-700"><%= pluralize(@archived_surveys.size, "archived survey") %></span>
      <% end %>
    </header>

    <% if @archived_surveys.blank? %>
      <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50 px-6 py-10 text-center text-sm text-slate-600">No archived surveys yet.</div>
    <% else %>
      <div class="w-full c-card c-card--flush">
        <div class="c-table-wrapper">
          <table class="c-table min-w-full w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold">Title</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold">Semester</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold">Tracks</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Categories</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Questions</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Updated</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 text-slate-600">
              <% @archived_surveys.each do |survey| %>
                <% category_count = survey.respond_to?(:category_count) ? survey.category_count.to_i : survey.categories.size %>
                <% question_count = survey.respond_to?(:question_count) ? survey.question_count.to_i : survey.questions.size %>
                <% tracks = survey.track_list %>
                <tr class="hover:bg-slate-50">
                  <td class="px-4 py-3 align-top">
                    <div class="font-semibold text-slate-900"><%= survey.title %></div>
                    <div class="mt-1 text-xs text-slate-500"><%= survey.description.presence || "No description provided." %></div>
                  </td>
                  <td class="whitespace-nowrap px-4 py-3 align-top text-slate-700"><%= survey.semester.presence || "Unscheduled" %></td>
                  <td class="px-4 py-3 align-top">
                    <% if tracks.present? %>
                      <div class="flex flex-wrap gap-1">
                        <% tracks.each do |track| %>
                          <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600"><%= track %></span>
                        <% end %>
                      </div>
                    <% else %>
                      <span class="text-xs font-medium text-amber-600">Unassigned</span>
                    <% end %>
                  </td>
                  <td class="whitespace-nowrap px-4 py-3 text-right font-semibold text-slate-900"><%= category_count %></td>
                  <td class="whitespace-nowrap px-4 py-3 text-right font-semibold text-slate-900"><%= question_count %></td>
                  <td class="whitespace-nowrap px-4 py-3 align-top text-right text-slate-500"><%= time_ago_in_words(survey.updated_at) %> ago</td>
                  <td class="px-4 py-3 align-top">
                    <div class="flex flex-wrap justify-end gap-2">
                      <%= link_to "Preview", preview_admin_survey_path(survey), class: tailwind_button_classes(:subtle, extra_classes: "btn-sm") %>
                      <%= button_to "Activate", activate_admin_survey_path(survey), method: :patch, data: { turbo_confirm: "Activate '#{survey.title}' for advisors?" }, class: tailwind_button_classes(:primary) %>
                      <%= button_to "Delete", admin_survey_path(survey), method: :delete, data: { turbo_confirm: "Delete '#{survey.title}' permanently?" }, class: tailwind_button_classes(:danger) %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </section>

  <section class="w-full space-y-4">
    <header class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Recent activity</h2>
        <p class="text-sm text-slate-600">Automatic log entries capture who changed each survey and what was updated.</p>
      </div>
      <% if @recent_logs.present? %>
        <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">Last <%= @recent_logs.size %> events</span>
      <% end %>
    </header>

    <% if @recent_logs.blank? %>
      <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50 px-6 py-8 text-center text-sm text-slate-600">No survey activity has been recorded yet.</div>
    <% else %>
      <ul class="space-y-3">
        <% @recent_logs.each do |log| %>
          <li class="flex items-start gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm">
            <div class="mt-1 h-2.5 w-2.5 rounded-full bg-indigo-500" aria-hidden="true"></div>
            <div class="flex-1 space-y-1">
              <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                <strong class="font-semibold text-slate-700"><%= log.admin&.display_name || "Unknown admin" %></strong>
                <span aria-hidden="true">•</span>
                <span><%= log.action.titleize %></span>
                <% if log.survey.present? %>
                  <span aria-hidden="true">•</span>
                  <span>Survey: <strong class="font-semibold text-slate-700"><%= log.survey.title %></strong></span>
                <% end %>
                <span aria-hidden="true">•</span>
                <span><%= time_ago_in_words(log.created_at) %> ago</span>
              </div>
              <p class="text-sm text-slate-600"><%= log.description %></p>
            </div>
          </li>
        <% end %>
      </ul>
    <% end %>
  </section>
</main>
