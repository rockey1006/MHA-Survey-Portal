<main class="px-4 py-8">
  <div class="c-container c-container--wide">
    <div class="c-page space-y-6">
    <header class="c-page-header space-y-2">
      <h1 class="c-page-title c-page-title--brand text-3xl font-semibold">Student Records</h1>
      <% intro_text = if current_user&.respond_to?(:role_admin?) && current_user.role_admin?
        "Browse survey progress across all students."
      elsif current_user&.respond_to?(:role_advisor?) && current_user.role_advisor?
        "Browse survey progress by semester for the students you advise."
      else
        "Browse survey progress by semester."
      end %>
      <p class="text-sm text-slate-600"><%= intro_text %></p>
    </header>

    <div class="c-toolbar">
      <div class="c-toolbar__row items-center w-full gap-3">
        <div class="shrink-0">
          <% if defined?(advisor_dashboard_path) && current_user&.respond_to?(:role_advisor?) && current_user.role_advisor? %>
            <%= link_to "‚Üê Back",
                        advisor_dashboard_path,
                        class: tailwind_button_classes(:secondary),
                        data: { turbo: false } %>
          <% elsif defined?(admin_dashboard_path) && current_user&.respond_to?(:role_admin?) && current_user.role_admin? %>
            <%= link_to "‚Üê Back",
                        admin_dashboard_path,
                        class: tailwind_button_classes(:secondary),
                        data: { turbo: false } %>
          <% else %>
            <%= link_to "‚Üê Back",
                        dashboard_path,
                        class: tailwind_button_classes(:secondary),
                        data: { turbo: false } %>
          <% end %>
        </div>

        <div class="flex-1">
          <%= render ToolbarSearchComponent.new(
            url: student_records_path,
            query: @search_query,
            placeholder: "Search by name, email, or UIN"
          ) %>
        </div>
      </div>
    </div>

    <% if @students.blank? %>
      <div class="c-card flex flex-col items-center justify-center gap-3 rounded-2xl border border-dashed border-slate-300 bg-white p-10 text-center shadow-sm">
        <span class="text-4xl" aria-hidden="true">üì≠</span>
        <p class="text-sm text-slate-600">No students were found for your account.</p>
      </div>
    <% elsif @student_records.blank? %>
      <div class="c-card flex flex-col items-center justify-center gap-3 rounded-2xl border border-dashed border-slate-300 bg-white p-10 text-center shadow-sm">
        <span class="text-4xl" aria-hidden="true">üóÇÔ∏è</span>
        <p class="text-sm text-slate-600">No surveys have been scheduled yet for the selected students.</p>
      </div>
    <% else %>
      <div class="space-y-6">
        <% @student_records.each do |semester_block| %>
          <details class="c-surface overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm" open>
            <summary class="flex cursor-pointer items-center justify-between gap-3 bg-slate-100 px-6 py-4 text-left text-slate-800">
              <span class="text-lg font-semibold"><%= semester_block[:semester] %></span>
              <span class="text-sm text-slate-500"><%= pluralize(semester_block[:surveys].size, "survey") %></span>
            </summary>

            <div class="space-y-4 px-6 py-5">
              <% semester_block[:surveys].each do |survey_block| %>
                <% survey = survey_block[:survey] %>

                <% survey_track_key =
                     if survey.respond_to?(:track) && survey.track.present?
                       survey.track.to_s.downcase
                     else
                       t = survey.title.to_s.downcase
                       if t.include?("executive")
                         "executive"
                       elsif t.include?("residential")
                         "residential"
                       else
                         nil
                       end
                     end %>

                <% filtered_rows =
                     if survey_track_key.present?
                       survey_block[:rows].select do |r|
                         r[:student].track.to_s.downcase == survey_track_key
                       end
                     else
                       survey_block[:rows]
                     end %>

                <details class="c-surface overflow-hidden rounded-2xl border border-slate-200 bg-slate-50" open>
                  <summary class="flex cursor-pointer flex-col gap-1 bg-slate-100 px-5 py-4 text-slate-700 sm:flex-row sm:items-center sm:justify-between">
                    <span class="text-base font-semibold text-slate-800"><%= survey.title %></span>
                    <span class="text-sm text-slate-500">Assigned <%= l(survey.created_at.to_date, format: :long) rescue survey.created_at.to_s(:long) %></span>
                  </summary>

                  <%= render TableComponent.new(
                    headers: ["#", "Student", "Advisor", "Track", "Class year", "Status", "Completion", "Feedback", "Survey"],
                    right_align: [8]
                  ) do %>
                        <% if filtered_rows.blank? %>
                          <% empty_track_message = if current_user&.respond_to?(:role_admin?) && current_user.role_admin?
                            "No students currently in this track."
                          else
                            "No students currently in this track are assigned to you."
                          end %>
                          <tr>
                            <td colspan="9" class="px-4 py-6 text-center text-sm text-slate-500">
                              <%= empty_track_message %>
                            </td>
                          </tr>
                        <% else %>
                          <% filtered_rows.each_with_index do |row, idx| %>
                            <% student                 = row[:student] %>
                            <% advisor                 = row[:advisor] %>
                            <% status_text             = row[:status] %>
                            <% completion_date         = row[:completed_at] %>
                            <% available_until         = row[:available_until] %>
                            <% admin_updated_at         = row[:admin_updated_at] %>
                            <% survey_response         = row[:survey_response] %>
                            <% download_token          = row[:download_token] %>
                            <% feedback_entries        = Array(row[:feedbacks]) %>
                            <% has_feedback            = feedback_entries.any? %>
                            <% has_completed          = status_text == "Completed" %>
                            <% is_assigned           = status_text == "Assigned" %>
                            <% is_unassigned         = status_text == "Unassigned" %>
                            <% survey_label            = has_completed ? (has_feedback ? "Edit Feedback" : "Review") : nil %>
                            <% survey_link_params      = { survey_id: survey.id, student_id: student.student_id } %>
                            <% survey_link_params[:prefill] = true if has_feedback %>
                            <% survey_link             = new_feedback_path(survey_link_params) %>

                            <tr class="transition hover:bg-slate-50">
                              <td class="u-text-primary whitespace-nowrap px-4 py-3 text-sm font-semibold"><%= idx + 1 %></td>

                              <td class="min-w-[14rem] px-4 py-3 text-sm text-slate-700">
                                <div class="font-semibold text-slate-900"><%= student.user&.name || "Unknown Student" %></div>
                                <div class="mt-1 flex flex-wrap gap-x-4 gap-y-1 text-xs text-slate-500">
                                  <% if student.user&.email.present? %><span>Email: <%= student.user.email %></span><% end %>
                                  <% if student.uin.present? %><span>UIN: <%= student.uin %></span><% end %>
                                </div>
                              </td>

                              <td class="min-w-[12rem] px-4 py-3 text-sm text-slate-700">
                                <% if advisor.present? %>
                                  <div class="font-semibold text-slate-900"><%= advisor.name %></div>
                                  <% if advisor.email.present? %>
                                    <div class="mt-1 text-xs text-slate-500"><%= advisor.email %></div>
                                  <% end %>
                                <% else %>
                                  <div class="font-semibold text-rose-600">Unassigned</div>
                                <% end %>
                              </td>

                              <td class="px-4 py-3 text-sm text-slate-700">
                                <% if student.track.present? %>
                                  <div class="font-semibold text-slate-900"><%= student.track.titleize %></div>
                                <% else %>
                                  <div class="font-semibold text-slate-400">Track unknown</div>
                                <% end %>
                              </td>

                              <td class="px-4 py-3 text-sm text-slate-700">
                                <% if student.class_of.present? %>
                                  <div class="font-semibold text-slate-900"><%= student.class_of %></div>
                                <% elsif student.program_year.present? %>
                                  <div class="font-semibold text-slate-900">Year <%= student.program_year %></div>
                                <% else %>
                                  <div class="font-semibold text-slate-400">‚Äî</div>
                                <% end %>
                              </td>

                              <td class="px-4 py-3 text-sm text-slate-700">
                                <span class="<%= survey_status_badge_classes(status_text) %>"><%= status_text %></span>
                              </td>

                              <td class="px-4 py-3 text-sm text-slate-700">
                                <% if completion_date.present? %>
                                  <% if admin_updated_at.present? %>
                                    <div class="font-semibold text-slate-900">Submitted <%= l(completion_date, format: :long) %></div>
                                    <div class="mt-1 text-xs text-slate-500">Admin updated <%= l(admin_updated_at, format: :long) %></div>
                                  <% else %>
                                    <div class="font-semibold text-slate-900"><%= l(completion_date, format: :long) %></div>
                                    <div class="mt-1 text-xs text-slate-500">Updated <%= time_ago_in_words(completion_date) %> ago</div>
                                  <% end %>
                                  <div class="mt-1 text-xs text-slate-500"><%= survey_availability_note(available_until) %></div>
                                <% else %>
                                  <span class="text-xs text-slate-500">Not yet completed</span>
                                  <div class="mt-1 text-xs text-slate-500"><%= survey_availability_note(available_until) %></div>
                                <% end %>
                              </td>

                              <td class="px-4 py-3 text-sm text-slate-700">
                                <% if feedback_entries.present? %>
                                  <span class="font-semibold text-slate-900">Has feedback</span>
                                <% else %>
                                  <span class="text-xs text-slate-500">No feedback</span>
                                <% end %>
                              </td>

                              <td class="px-4 py-3 text-right text-sm whitespace-nowrap">
                                <% admin_can_open = current_user&.respond_to?(:role_admin?) && current_user.role_admin? %>
                                <% advisor_can_open = current_advisor_profile&.advisor_id.present? && student.advisor_id.present? && current_advisor_profile.advisor_id == student.advisor_id %>
                                <% can_open = admin_can_open || advisor_can_open %>
                                <% show_actions = has_completed && can_open %>
                                <div class="flex flex-nowrap items-center justify-end gap-2">
                                  <% if show_actions %>
                                    <%= link_to survey_label,
                                                survey_link,
                                                class: tailwind_button_classes(:secondary) %>
                                    <% if survey_response.present? %>
                                      <%= link_to "Download PDF",
                                                  download_survey_response_path(survey_response, token: download_token),
                                                  class: tailwind_button_classes(:primary),
                                                  target: "_blank", rel: "noopener noreferrer" %>

                                      <% if admin_can_open %>
                                          <details class="relative">
                                            <summary
                                              class="list-none <%= tailwind_button_classes(:secondary) %>"
                                              aria-label="More actions"
                                              title="More actions">
                                              ‚Ä¶
                                            </summary>

                                            <div class="absolute right-0 z-20 mt-2 w-44 overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm">
                                              <div class="py-1">
                                                <%= link_to "Edit",
                                                            edit_survey_response_path(survey_response, return_to: request.fullpath),
                                                            class: "block w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50" %>

                                                <%= button_to "Delete",
                                                            survey_response_path(survey_response),
                                                            method: :delete,
                                                            form_class: "block",
                                                            class: "block w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50",
                                                            data: { turbo_confirm: "Delete this student's survey responses? This cannot be undone." } %>
                                              </div>
                                            </div>
                                          </details>
                                      <% end %>
                                    <% end %>
                                  <% elsif has_completed %>
                                    <span
                                      class="<%= tailwind_button_classes(:secondary) %>"
                                      aria-disabled="true"
                                      title="Only the student's advisor or an admin can open this survey">
                                      <%= survey_label || "Review" %>
                                    </span>
                                  <% elsif is_assigned %>
                                    <span class="text-xs text-slate-500">Awaiting student completion</span>
                                  <% else %>
                                    <span class="text-xs text-slate-500">Survey not assigned</span>
                                  <% end %>
                                </div>
                              </td>
                            </tr>
                          <% end %>
                        <% end %>
                  <% end %>
                </details>
              <% end %>
            </div>
          </details>
        <% end %>
      </div>
    <% end %>

    </div>
  </div>
</main>
