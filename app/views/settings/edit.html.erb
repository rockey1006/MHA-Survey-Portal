<% content_for :title, "Settings" %>

<% lang_code = (@user&.language.presence || 'en') %>
<% lang_labels = {
  'en' => 'English', 'es' => 'Spanish', 'fr' => 'Français', 'de' => 'Deutsch',
  'zh-CN' => '中文 (简体)', 'zh-TW' => '中文 (繁體)', 'ja' => '日本語',
  'ko' => '한국어', 'pt' => 'Português', 'ru' => 'Русский'
} %>
<% current_language_label = lang_labels[lang_code] || lang_code %>
<% text_scale = @user.text_scale_percent || 100 %>
<% notifications_enabled = @user.notifications_enabled.nil? ? true : @user.notifications_enabled %>
<% back_path = if current_user&.role_admin?
                 admin_dashboard_path
               elsif current_user&.role_advisor?
                 advisor_dashboard_path
               elsif current_user&.role_student?
                 student_dashboard_path
               else
                 root_path
               end %>

<div class="py-6 sm:py-8">
  <div class="u-stack u-stack--lg">
    <section class="c-hero c-hero--maroon c-hero--compact">
      <div class="flex flex-col gap-10 lg:flex-row lg:items-start lg:justify-between">
        <div class="space-y-8">
          <div class="space-y-4">
            <p class="c-eyebrow c-eyebrow--inverse">Settings</p>
            <h1 class="c-h1 c-h1--inverse">Personalize your workspace</h1>
            <p class="c-lede c-lede--inverse max-w-2xl">Language and text settings sync everywhere you sign in, so dashboards, surveys, and reports stay readable.</p>
          </div>

          <div class="flex flex-wrap gap-3">
            <span class="c-pill c-pill--inverse">
              <span class="c-pill__dot c-pill__dot--inverse" aria-hidden="true"></span>
              Language · <span id="current-language-display"><%= current_language_label %></span>
            </span>
            <span class="c-pill c-pill--inverse">
              Text scale · <%= text_scale %>%
            </span>
          </div>
        </div>

        <div class="c-kv c-kv--inverse" style="max-width: 28rem;">
          <p class="c-eyebrow c-eyebrow--inverse">Tip</p>
          <p class="c-value c-value--lg c-value--inverse">Changes apply instantly</p>
          <p class="c-lede c-lede--inverse" style="margin-top: var(--spacing-sm);">We refresh after saving so your preferences update app-wide.</p>
        </div>
      </div>
    </section>

    <div>
      <section class="c-card c-card--tight space-y-8">
        <header>
          <p class="c-eyebrow">Account-wide</p>
          <h2 class="c-h2">Accessibility preferences</h2>
          <p class="c-lede">These settings change typography scale and translation helpers across dashboards, surveys, and reports.</p>
        </header>

        <%= form_with model: @user, url: settings_path, method: :patch, local: true, id: "settings-form", class: "u-stack u-stack--lg" do |f| %>
          <% if @user.errors.any? %>
            <div class="c-card c-card--tight border border-rose-200 bg-rose-50 text-rose-800 shadow-none">
              <h3 class="font-semibold text-rose-900">
                <%= pluralize(@user.errors.count, "error") %> need attention
              </h3>
              <ul class="mt-2 list-disc pl-5">
                <% @user.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="u-grid u-grid--2">
            <div class="c-kv c-kv--compact">
              <div class="c-field">
                <label class="c-label">Language</label>
                <p class="c-value c-value--lg"><span id="language-pill-label"><%= current_language_label %></span></p>
                <small class="c-help">Managed automatically via the translation bar.</small>
                <%= f.hidden_field :language, value: lang_code, id: 'settings_language_input' %>
              </div>
            </div>

            <div class="c-kv c-kv--compact">
              <div class="c-field">
                <label class="c-label">Text size</label>
                <%= f.select :text_scale_percent,
                      options_for_select([["100% (default)", 100], ["125%", 125], ["150%", 150], ["175%", 175], ["200%", 200]], text_scale),
                      {},
                      class: "c-input" %>
                <small class="c-help">Increase up to 200% for larger copy.</small>
              </div>
            </div>

            <div class="c-kv c-kv--compact">
              <div class="c-field">
                <label class="c-label">Notifications</label>
                <%= f.select :notifications_enabled,
                      options_for_select([["On", true], ["Off", false]], notifications_enabled),
                      {},
                      class: "c-input" %>
                <small class="c-help">Turns account notifications on or off.</small>
              </div>
            </div>

            <div class="c-kv c-kv--compact">
              <div class="c-field">
                <div class="flex items-baseline justify-between gap-3">
                  <label class="c-label" for="tts-rate">Read Aloud speed</label>
                  <span class="c-help" id="tts-rate-value" aria-live="polite">1.0×</span>
                </div>
                <input
                  class="c-input"
                  id="tts-rate"
                  type="range"
                  min="0.25"
                  max="2.0"
                  step="0.1"
                  value="1.0"
                  data-tts-rate
                />
                <div class="mt-3 flex flex-wrap gap-2" aria-label="Read aloud speed presets">
                  <button type="button" class="btn btn-subtle" data-tts-rate-preset="0.25">0.25×</button>
                  <button type="button" class="btn btn-subtle" data-tts-rate-preset="0.5">0.5×</button>
                  <button type="button" class="btn btn-subtle" data-tts-rate-preset="0.75">0.75×</button>
                  <button type="button" class="btn btn-subtle" data-tts-rate-preset="1.0">1.0×</button>
                  <button type="button" class="btn btn-subtle" data-tts-rate-preset="1.25">1.25×</button>
                  <button type="button" class="btn btn-subtle" data-tts-rate-preset="1.5">1.5×</button>
                  <button type="button" class="btn btn-subtle" data-tts-rate-preset="1.75">1.75×</button>
                  <button type="button" class="btn btn-subtle" data-tts-rate-preset="2.0">2.0×</button>
                </div>
                <small class="c-help">Saved on this device and used when you toggle “Read Aloud” in the header.</small>
              </div>
            </div>
          </div>

          <div class="c-form-actions u-actions u-actions--split border-t border-slate-100 pt-6">
            <div class="flex flex-wrap gap-2">
              <button type="button" class="btn btn-secondary" id="reset-local-defaults">Reset to defaults</button>
              <%= link_to "Cancel", back_path, class: tailwind_button_classes(:secondary) %>
            </div>
            <%= f.submit "Save changes", class: tailwind_button_classes(:primary) %>
          </div>
        <% end %>
      </section>
    </div>
  </div>
</div>
<script>
  // Submit settings via fetch to ensure we can reload the app immediately on success.
  (function() {
    var form = document.getElementById('settings-form');
    if (!form) return;

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var submit = form.querySelector('[type=submit]');
      if (submit) submit.disabled = true;

      var token = document.querySelector('meta[name=csrf-token]') && document.querySelector('meta[name=csrf-token]').getAttribute('content');
      var fd = new FormData(form);

      fetch(form.action, {
        method: 'POST', // form_with uses POST with _method=patch
        body: fd,
        credentials: 'same-origin',
        headers: token ? { 'X-CSRF-Token': token } : {}
      }).then(function(resp) {
        if (resp.redirected) {
          window.location.href = resp.url;
          return;
        }
        if (resp.ok) {
          // Successful update - refresh the page so the new settings (and root font-size) apply app-wide
          window.location.reload();
          return;
        }
        // On error, replace the form container with server response (this will show validation errors)
        return resp.text().then(function(html) {
          try {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var newForm = doc.getElementById('settings-form');
            if (newForm) {
              form.replaceWith(newForm);
            } else {
              // fallback: reload so user can see server-rendered errors
              window.location.reload();
            }
          } catch (err) {
            window.location.reload();
          }
        });
      }).catch(function() {
        // network failure - re-enable submit and show a simple alert
        if (submit) submit.disabled = false;
        alert('Failed to save settings. Please try again.');
      });
    });
  })();
</script>
<script>
  // Read Aloud speed (local-only): store in localStorage so it applies to TTS everywhere.
  (function() {
    var KEY = 'mha:tts_rate';
    var HIGH_CONTRAST_KEY = 'mha_high_contrast';
    var slider = document.querySelector('[data-tts-rate]');
    var valueLabel = document.getElementById('tts-rate-value');
    if (!slider || !valueLabel) return;

    var presets = Array.prototype.slice.call(document.querySelectorAll('[data-tts-rate-preset]'));

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    function formatRate(rate) {
      return (Math.round(rate * 10) / 10).toFixed(1) + '×';
    }

    try {
      var stored = window.localStorage.getItem(KEY);
      var initial = stored ? parseFloat(stored) : 1.0;
      if (!isFinite(initial)) initial = 1.0;
      initial = clamp(initial, 0.25, 2.0);

      slider.value = String(initial);
      valueLabel.textContent = formatRate(initial);
    } catch (e) {
      // ignore
    }

    slider.addEventListener('input', function() {
      var next = parseFloat(slider.value);
      if (!isFinite(next)) return;
      valueLabel.textContent = formatRate(next);
    });

    function persist(rate) {
      try {
        window.localStorage.setItem(KEY, String(rate));
      } catch (e) {
        // ignore
      }
    }

    slider.addEventListener('change', function() {
      var next = parseFloat(slider.value);
      if (!isFinite(next)) return;
      persist(next);
    });

    presets.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var rate = parseFloat(btn.getAttribute('data-tts-rate-preset'));
        if (!isFinite(rate)) return;
        rate = clamp(rate, 0.25, 2.0);
        slider.value = String(rate);
        valueLabel.textContent = formatRate(rate);
        persist(rate);
      });
    });

    // Reset local-only preferences back to defaults.
    var resetBtn = document.getElementById('reset-local-defaults');
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        try {
          window.localStorage.removeItem(KEY);
          window.localStorage.removeItem(HIGH_CONTRAST_KEY);
        } catch (e) {
          // ignore
        }

        // Reset Read Aloud speed UI
        slider.value = '1.0';
        valueLabel.textContent = '1.0×';

        // Stop reading if active
        try {
          if (window.speechSynthesis && window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
          }
        } catch (e) {
          // ignore
        }

        // Remove highlight overlay if present
        var highlight = document.querySelector('.c-tts-highlight');
        if (highlight) {
          highlight.style.width = '0';
          highlight.style.height = '0';
        }

        // Turn off high contrast immediately
        document.body && document.body.classList.remove('high-contrast');
        var hcToggles = document.querySelectorAll('[data-high-contrast-toggle]');
        hcToggles.forEach(function(el) {
          if (el && el.type === 'checkbox') {
            el.checked = false;
            el.setAttribute('aria-checked', 'false');
          }
        });
      });
    }
  })();
</script>
<script>
  // Update the visible language display from Google Translate cookie if present.
  (function() {
    function readCookie(name) {
      var m = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]+)'));
      return m ? decodeURIComponent(m[2]) : null;
    }

    var display = document.getElementById('current-language-display');
    var hiddenInput = document.getElementById('settings_language_input');
    if (!display || !hiddenInput) return;

    // Map common language codes to labels
    var labels = {
      'en': 'English', 'es': 'Spanish', 'fr': 'Français', 'de': 'Deutsch',
      'zh-CN': '中文 (简体)', 'zh-TW': '中文 (繁體)', 'ja': '日本語', 'ko': '한국어',
      'pt': 'Português', 'ru': 'Русский'
    };

    try {
      var g = readCookie('googtrans');
      if (g && g !== '/auto/en') {
        var code = g.split('/').pop();
        // Google sometimes uses short codes like 'zh-CN' or 'zh_TW' with underscore
        code = code.replace('_', '-');
        display.textContent = labels[code] || code;
        hiddenInput.value = code;
      } else {
        // No active translation cookie; ensure display matches saved user language
        var saved = hiddenInput.value || 'en';
        display.textContent = labels[saved] || saved;
      }
    } catch (e) {
      // ignore
    }
  })();
</script>
