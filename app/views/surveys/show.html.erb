<% survey_title = @survey.title.presence || "Survey ##{@survey.id}" %>

<div class="survey-container mx-auto max-w-4xl space-y-8">
  <header class="survey-header text-center space-y-1">
    <h1 class="text-2xl font-semibold text-slate-900"><%= @survey.title %></h1>
    <p class="text-sm text-slate-600">
      Semester: <%= @survey.semester.presence || "TBD" %> · Tracks: <%= @survey.track_list.presence&.join(", ") || "Unassigned" %>
    </p>
    <p class="text-xs text-slate-500">*
      required to answer
    </p>
  </header>

  <%= form_with url: submit_survey_path(@survey), method: :post, local: true, data: { turbo: false }, class: "space-y-6 survey-form" do |form| %>
    <% @category_groups.each do |category| %>
      <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm space-y-4">
        <header>
          <h2 class="text-xl font-semibold text-slate-900"><%= category.name %></h2>
          <% if category.description.present? %>
            <p class="text-sm text-slate-600"><%= category.description %></p>
          <% end %>
        </header>

        <% category.questions.ordered.each_with_index do |question, index| %>
          <% field_name = "answers[#{question.id}]" %>
          <% current_value = @existing_answers[question.id.to_s] %>
          <% required = @computed_required[question.id] %>

          <article class="space-y-2 question-block" data-question-id="<%= question.id %>">
            <label class="block text-sm font-medium text-slate-900" for="question-<%= question.id %>">
              <span class="font-semibold">Q<%= index + 1 %></span>
              <span class="ml-2"><%= question.question_text %></span>
              <% if required %>
                <span class="ml-1 text-red-600" aria-hidden="true">*</span>
              <% end %>
            </label>

            <% case question.question_type %>
            <% when "short_answer" %>
              <%= text_area_tag field_name, current_value, rows: 3, id: "question-#{question.id}", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              <% if required && (current_value.nil? || current_value.to_s.strip.blank?) && request.post? %>
                <div class="text-xs text-red-600 mt-1">This question is required</div>
              <% end %>
            <% when "multiple_choice" %>
              <% options = question.answer_options_list.presence || [] %>
              <div class="flex flex-col gap-2" role="radiogroup">
                <% options.each do |option| %>
                  <label class="flex items-center gap-2 text-sm text-slate-800">
                    <%= radio_button_tag field_name, option, current_value.to_s == option.to_s, id: "question-#{question.id}-#{option.parameterize}", class: "h-4 w-4 text-blue-600" %>
                    <span><%= option %></span>
                  </label>
                <% end %>
              </div>
              <% if required && (current_value.nil? || current_value.to_s.strip.blank?) && request.post? %>
                <div class="text-xs text-red-600 mt-1">This question is required</div>
              <% end %>
            <% when "scale" %>
              <div class="flex items-center gap-3">
                <span class="text-xs text-slate-500">Low</span>
                <%= range_field_tag field_name, current_value || 3, in: 1..5, step: 1, id: "question-#{question.id}", class: "w-full" %>
                <span class="text-xs text-slate-500">High</span>
              </div>
              <% if required && (current_value.nil? || current_value.to_s.strip.blank?) && request.post? %>
                <div class="text-xs text-red-600 mt-1">This question is required</div>
              <% end %>
            <% when "evidence" %>
              <% evidence_link = current_value.is_a?(Hash) ? current_value["link"] : current_value %>
              <%= text_field_tag field_name, evidence_link, id: "question-#{question.id}", placeholder: "https://drive.google.com/...", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              <% if required && (evidence_link.nil? || evidence_link.to_s.strip.blank?) && request.post? %>
                <div class="text-xs text-red-600 mt-1">This question is required</div>
              <% elsif evidence_link.present? && Array(@invalid_evidence).map(&:to_s).include?(question.id.to_s) %>
                <div class="text-xs text-red-600 mt-1">Link is invalid or not publicly accessible</div>
              <% end %>

              <% unless category.name == "Employment Information" %>
                <% rating_value = current_value.is_a?(Hash) ? current_value["rating"] : (@existing_ratings && @existing_ratings[question.id.to_s]) %>
                <div class="mt-3 space-y-1">
                  <label class="block text-xs font-medium text-slate-700" for="question-<%= question.id %>-rating">
                    Self-rating (1–5)
                    <span class="text-red-600" aria-hidden="true">*</span>
                  </label>
                  <%= select_tag "answers_rating[#{question.id}]",
                                options_for_select((1..5).map { |n| [n, n] }, rating_value),
                                include_blank: true,
                                id: "question-#{question.id}-rating",
                                class: "w-32 rounded-md border border-slate-300 px-2 py-1 text-sm" %>
                  <% if (@missing_rating_ids && @missing_rating_ids.include?(question.id)) %>
                    <div class="text-xs text-red-600 mt-1">Self-rating is required</div>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <%= text_field_tag field_name, current_value, id: "question-#{question.id}", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              <% if required && (current_value.nil? || current_value.to_s.strip.blank?) && request.post? %>
                <div class="text-xs text-red-600 mt-1">This question is required</div>
              <% end %>
            <% end %>

          </article>
        <% end %>
      </section>
    <% end %>

    <div class="flex items-center justify-between gap-3">
      <%= button_tag "Save Progress", type: "button", class: "inline-flex items-center rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 focus:outline-none focus-visible:ring focus-visible:ring-slate-500/70", onclick: "saveSurveyProgress()" %>
      <%= form.submit "Submit Survey", class: "inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-500 focus:outline-none focus-visible:ring focus-visible:ring-blue-500/70" %>
    </div>
  <% end %>

  <script>
    function saveSurveyProgress() {
      const form = document.querySelector('.survey-form');
      const originalAction = form.action;
      
      // Change to save_progress endpoint
      form.action = '<%= save_progress_survey_path(@survey) %>';
      
      // Submit the form
      form.submit();
    }
  </script>
</div>