<% category = category_fields.object %>
<% panel_dom_id = category.instance_variable_get(:@panel_dom_id) %>
<% panel_dom_id ||= "category-panel-#{category.object_id}" %>
<% category.instance_variable_set(:@panel_dom_id, panel_dom_id) %>
<% section_uid = category.respond_to?(:section_form_uid) ? category.section_form_uid.presence : nil %>
<article class="space-y-5 rounded-xl border border-slate-200 bg-white p-5 shadow-sm"
         data-category-fields-target="item"
         data-survey-structure-target="panel"
         data-panel-type="category"
         data-panel-key="<%= panel_dom_id %>"
         data-panel-label="<%= category.name.presence || 'Untitled category' %>"
         data-section-uid="<%= section_uid %>">
  <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
    <div class="flex-1 space-y-2">
      <%= category_fields.hidden_field :id %>
      <%= category_fields.label :name, "Category name", class: "block text-sm font-medium text-slate-700" %>
      <%= category_fields.text_field :name,
                                     required: true,
                                     class: input_classes,
                                     placeholder: "Leadership",
                                     data: { action: "input->survey-structure#syncPanelLabel" } %>
      <%= category_fields.hidden_field :section_form_uid,
                                       value: section_uid,
                                       data: { survey_structure_target: "assignmentField", panel_key: panel_dom_id } %>
      <p class="text-xs text-slate-500"
         data-survey-structure-target="assignmentLabel"
         data-panel-key="<%= panel_dom_id %>">
        <%= section_uid.present? ? "Linked to section" : "No section selected" %>
      </p>
    </div>

    <% if category.persisted? %>
      <label class="flex items-center gap-2 text-sm font-medium text-rose-600">
        <%= category_fields.check_box :_destroy, class: checkbox_classes %>
        <span>Remove category</span>
      </label>
    <% else %>
      <button type="button"
              class="text-sm font-medium text-rose-600"
              data-action="category-fields#remove">
        Remove category
      </button>
    <% end %>
  </div>

  <div class="space-y-5">
    <div class="space-y-2">
      <%= category_fields.label :description, "Description", class: "block text-sm font-medium text-slate-700" %>
      <%= category_fields.text_area :description, class: textarea_classes, placeholder: "Optional context shown to advisors and students." %>
    </div>

    <div class="space-y-4" data-controller="question-fields">
      <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-600">Questions</h3>
      <div class="space-y-4" data-question-fields-target="container">
        <%= category_fields.fields_for :questions do |question_fields| %>
          <%= render "admin/surveys/question_fields",
                     question_fields: question_fields,
                     input_classes: input_classes,
                     textarea_classes: textarea_classes,
                     checkbox_classes: checkbox_classes %>
        <% end %>
      </div>

      <% new_question = category.questions.build(question_text: "", question_order: (category.questions.maximum(:question_order) || 0) + 1) %>
      <% template = capture do %>
        <%= category_fields.fields_for(:questions, new_question, child_index: "NEW_QUESTION") do |question_fields| %>
          <%= render "admin/surveys/question_fields",
                     question_fields: question_fields,
                     input_classes: input_classes,
                     textarea_classes: textarea_classes,
                     checkbox_classes: checkbox_classes %>
        <% end %>
      <% end %>
      <% category.questions.target.delete(new_question) %>

      <template data-question-fields-target="template"><%= template %></template>

      <button type="button"
              class="rounded-lg border border-dashed border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:border-slate-400"
              data-action="question-fields#add">
        + Add another question
      </button>
    </div>
  </div>
</article>
