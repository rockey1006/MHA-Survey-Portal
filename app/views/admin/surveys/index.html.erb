<main class="main-content space-y-12">

  <div class="mb-4">
    <%= link_to "← Back",
                admin_dashboard_path,
                class: tailwind_button_classes(:secondary),
                data: { turbo: false } %>
  </div>

  <section class="flex w-full flex-col gap-6 sm:flex-row sm:items-start sm:justify-between">
    <div class="space-y-2">
      <h1 class="text-3xl font-semibold tracking-tight text-slate-900">Survey Builder</h1>
      <p class="text-sm text-slate-600">Launch new advisor surveys, monitor what is live, and review the audit trail of recent changes.</p>
    </div>
    <div class="flex flex-wrap gap-3">
      <% if defined?(admin_survey_change_logs_path) %>
        <%= link_to "View Change Log", admin_survey_change_logs_path, class: tailwind_button_classes(:secondary) %>
      <% end %>
      <%= link_to "Create Survey", new_admin_survey_path, class: tailwind_button_classes(:primary) %>
    </div>
  </section>

  <% active_count = @active_surveys.size %>
  <% archived_count = @archived_surveys.size %>
  <% total_questions = @active_surveys.sum { |survey| survey.respond_to?(:question_count) ? survey.question_count.to_i : survey.questions.size } %>
  <% latest_activity_at = (@recent_logs.first&.created_at || @active_surveys.map(&:updated_at).compact.max) %>

  <section class="grid gap-4 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm sm:grid-cols-2 xl:grid-cols-4">
    <div class="rounded-xl border border-indigo-100 bg-indigo-50/60 p-4">
      <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600">Active surveys</p>
      <p class="mt-2 text-3xl font-semibold text-slate-900"><%= active_count %></p>
      <p class="text-xs text-slate-500">Currently visible to advisors</p>
    </div>
    <div class="rounded-xl border border-emerald-100 bg-emerald-50/60 p-4">
      <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600">Question inventory</p>
      <p class="mt-2 text-3xl font-semibold text-slate-900"><%= number_with_delimiter(total_questions) %></p>
      <p class="text-xs text-slate-500">Across all active surveys</p>
    </div>
    <div class="rounded-xl border border-amber-100 bg-amber-50/60 p-4">
      <p class="text-xs font-semibold uppercase tracking-wide text-amber-600">Archived surveys</p>
      <p class="mt-2 text-3xl font-semibold text-slate-900"><%= archived_count %></p>
      <p class="text-xs text-slate-500">Ready to reactivate when needed</p>
    </div>
    <div class="rounded-xl border border-slate-200 bg-slate-50/80 p-4">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-600">Last change</p>
      <% if latest_activity_at.present? %>
        <p class="mt-2 text-2xl font-semibold text-slate-900"><%= time_ago_in_words(latest_activity_at) %></p>
        <p class="text-xs text-slate-500">ago via admin activity</p>
      <% else %>
        <p class="mt-2 text-2xl font-semibold text-slate-900">—</p>
        <p class="text-xs text-slate-500">No edits recorded yet</p>
      <% end %>
    </div>
  </section>

  <section id="semester-manager" class="w-full c-card u-stack">
    <header class="toolbar">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Program semesters</h2>
        <p class="text-sm text-slate-600">Add upcoming terms and choose which semester should appear across advisor and student pages.</p>
      </div>
      <% if @current_program_semester.present? %>
        <span class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-4 py-1 text-sm font-semibold text-indigo-700">
          <span class="h-2 w-2 rounded-full bg-indigo-500" aria-hidden="true"></span>
          Current: <%= @current_program_semester.name %>
        </span>
      <% else %>
        <span class="inline-flex items-center rounded-full bg-amber-100 px-4 py-1 text-sm font-semibold text-amber-800">No current semester set</span>
      <% end %>
    </header>

    <div class="grid gap-6 lg:grid-cols-[2fr_1fr]">
      <div class="u-stack u-stack--md">
        <% if @program_semesters.blank? %>
          <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50 px-4 py-6 text-sm text-slate-600">
            No semesters yet. Use the form to create your first entry.
          </div>
        <% else %>
          <ul class="space-y-3">
            <% @program_semesters.each do |semester| %>
              <li class="flex flex-wrap items-center justify-between gap-3 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                <div>
                  <p class="text-base font-semibold text-slate-900"><%= semester.name %></p>
                  <p class="text-xs text-slate-500">Added <%= time_ago_in_words(semester.created_at) %> ago</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <% if semester.current? %>
                    <span class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">Current</span>
                  <% else %>
                    <%= button_to "Make current",
                                  make_current_admin_program_semester_path(semester),
                                  method: :patch,
                                  class: tailwind_button_classes(:subtle, extra_classes: "btn-sm") %>
                  <% end %>
                  <%= button_to "Delete",
                                admin_program_semester_path(semester),
                                method: :delete,
                                data: { turbo_confirm: "Delete #{semester.name}?" },
                                class: tailwind_button_classes(:danger) %>
                </div>
              </li>
            <% end %>
          </ul>
        <% end %>
      </div>

      <div class="c-card c-card--tight c-card--muted">
        <h3 class="text-base font-semibold text-slate-900">Add semester</h3>
        <p class="mb-4 text-sm text-slate-600">Name semesters consistently (e.g., "Fall 2025").</p>
        <%= form_with model: [:admin, @new_program_semester], url: admin_program_semesters_path, local: true, class: "space-y-4" do |form| %>
          <div class="space-y-1">
            <%= form.label :name, "Semester name", class: "text-sm font-medium text-slate-700" %>
            <%= form.text_field :name, required: true, class: "w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500", placeholder: "Fall 2026" %>
          </div>
          <div class="flex items-start gap-2 text-sm text-slate-600">
            <%= form.check_box :current, class: "mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" %>
            <label for="program_semester_current" class="space-y-1">
              <span class="font-medium text-slate-700">Set as current semester</span>
              <p>Existing current semester will be turned off automatically.</p>
            </label>
          </div>
          <%= form.submit "Save semester", class: tailwind_button_classes(:primary) %>
        <% end %>
      </div>
    </div>
  </section>

  <section class="w-full space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Active surveys</h2>
        <p class="text-sm text-slate-600">Search, filter, and sort active surveys currently visible to advisors.</p>
      </div>
      <% if @active_surveys.present? %>
        <span class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700"><%= pluralize(@active_surveys.size, "active survey") %></span>
      <% end %>
    </header>

    <div class="w-full c-card c-card--flush">
      <div class="border-b border-slate-200 p-5">
        <%= form_with url: admin_surveys_path, method: :get, local: true, class: "flex w-full flex-wrap items-center gap-3 md:flex-nowrap" do %>
          <%= hidden_field_tag :sort, @sort_column %>
          <%= hidden_field_tag :direction, @sort_direction %>

          <div class="relative flex-1 min-w-[220px]">
            <%= text_field_tag :q, @search_query, placeholder: "Search by title, semester, or description", class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 pr-16 text-sm text-slate-900 shadow-sm placeholder:text-slate-400 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" %>
            <% if @search_query.present? %>
              <button type="submit" name="q" value="" class="absolute inset-y-0 right-3 flex items-center text-xs font-semibold text-slate-400 hover:text-slate-600">Clear</button>
            <% end %>
          </div>

          <div class="md:w-48">
            <%= select_tag :track,
                           options_for_select([
                             ["All tracks", ""],
                             ["Unassigned", @unassigned_track_token]
                           ] + @track_filter_options.map { |track| [track, track] }, @selected_track),
                           class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" %>
          </div>

          <div class="flex items-center gap-3">
            <%= submit_tag "Apply", class: tailwind_button_classes(:primary) %>
            <% if @search_query.present? || @selected_track.present? %>
              <%= link_to "Reset", admin_surveys_path(sort: @sort_column, direction: @sort_direction), class: tailwind_button_classes(:subtle) %>
            <% end %>
          </div>
        <% end %>
        <% if @search_query.present? || @selected_track.present? %>
          <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
            <% if @search_query.present? %>
              <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">Search: "<%= @search_query %>"</span>
            <% end %>
            <% if @selected_track.present? %>
              <% track_label = @selected_track == @unassigned_track_token ? "Unassigned" : @selected_track %>
              <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">Track: <%= track_label %></span>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if @active_surveys.blank? %>
        <div class="p-6 text-center text-sm text-slate-500">No surveys match the current search or filter criteria.</div>
      <% else %>
        <div class="c-table-wrapper">
          <table class="c-table min-w-full w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold"><%= sortable_header("Title", "title") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold"><%= sortable_header("Semester", "semester") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold">Tracks</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold"><%= sortable_header("Categories", "category_count") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold"><%= sortable_header("Questions", "question_count") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold"><%= sortable_header("Updated", "updated_at") %></th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 text-slate-600">
              <% @active_surveys.each do |survey| %>
                <% category_count = survey.respond_to?(:category_count) ? survey.category_count.to_i : survey.categories.size %>
                <% question_count = survey.respond_to?(:question_count) ? survey.question_count.to_i : survey.questions.size %>
                <% tracks = survey.track_list %>
                <tr class="hover:bg-slate-50">
                  <td class="px-4 py-3 align-top">
                    <div class="font-semibold text-slate-900"><%= survey.title %></div>
                    <div class="mt-1 text-xs text-slate-500"><%= survey.description.presence || "No description provided." %></div>
                  </td>
                  <td class="whitespace-nowrap px-4 py-3 align-top text-slate-700"><%= survey.semester.presence || "Unscheduled" %></td>
                  <td class="px-4 py-3 align-top">
                    <% if tracks.present? %>
                      <div class="flex flex-wrap gap-1">
                        <% tracks.each do |track| %>
                          <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600"><%= track %></span>
                        <% end %>
                      </div>
                    <% else %>
                      <span class="text-xs font-medium text-amber-600">Unassigned</span>
                    <% end %>
                  </td>
                  <td class="whitespace-nowrap px-4 py-3 text-right font-semibold text-slate-900"><%= category_count %></td>
                  <td class="whitespace-nowrap px-4 py-3 text-right font-semibold text-slate-900"><%= question_count %></td>
                  <td class="whitespace-nowrap px-4 py-3 align-top text-right text-slate-500"><%= time_ago_in_words(survey.updated_at) %> ago</td>
                  <td class="px-4 py-3 align-top">
                    <div class="flex flex-wrap justify-end gap-2">
                      <%= link_to "Preview", preview_admin_survey_path(survey), class: tailwind_button_classes(:subtle, extra_classes: "btn-sm") %>
                      <%= link_to "Edit", edit_admin_survey_path(survey), class: tailwind_button_classes(:subtle, extra_classes: "btn-sm") %>
                      <%= button_to "Archive", archive_admin_survey_path(survey), method: :patch, data: { turbo_confirm: "Archive '#{survey.title}' and remove it from advisors?" }, class: tailwind_button_classes(:secondary) %>
                      <%= button_to "Delete", admin_survey_path(survey), method: :delete, data: { turbo_confirm: "Delete '#{survey.title}' permanently?" }, class: tailwind_button_classes(:danger) %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </section>

  <section class="w-full space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Archived surveys</h2>
        <p class="text-sm text-slate-600">Re-activate an archived survey to make it available for new assignments.</p>
      </div>
      <% if @archived_surveys.present? %>
        <span class="inline-flex items-center rounded-full bg-slate-200 px-3 py-1 text-xs font-semibold text-slate-700"><%= pluralize(@archived_surveys.size, "archived survey") %></span>
      <% end %>
    </header>

    <% if @archived_surveys.blank? %>
      <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50 px-6 py-10 text-center text-sm text-slate-600">No archived surveys yet.</div>
    <% else %>
      <div class="w-full c-card c-card--flush">
        <div class="c-table-wrapper">
          <table class="c-table min-w-full w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold">Title</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold">Semester</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-left font-semibold">Tracks</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Categories</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Questions</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Updated</th>
                <th scope="col" class="whitespace-nowrap px-4 py-3 text-right font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 text-slate-600">
              <% @archived_surveys.each do |survey| %>
                <% category_count = survey.respond_to?(:category_count) ? survey.category_count.to_i : survey.categories.size %>
                <% question_count = survey.respond_to?(:question_count) ? survey.question_count.to_i : survey.questions.size %>
                <% tracks = survey.track_list %>
                <tr class="hover:bg-slate-50">
                  <td class="px-4 py-3 align-top">
                    <div class="font-semibold text-slate-900"><%= survey.title %></div>
                    <div class="mt-1 text-xs text-slate-500"><%= survey.description.presence || "No description provided." %></div>
                  </td>
                  <td class="whitespace-nowrap px-4 py-3 align-top text-slate-700"><%= survey.semester.presence || "Unscheduled" %></td>
                  <td class="px-4 py-3 align-top">
                    <% if tracks.present? %>
                      <div class="flex flex-wrap gap-1">
                        <% tracks.each do |track| %>
                          <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600"><%= track %></span>
                        <% end %>
                      </div>
                    <% else %>
                      <span class="text-xs font-medium text-amber-600">Unassigned</span>
                    <% end %>
                  </td>
                  <td class="whitespace-nowrap px-4 py-3 text-right font-semibold text-slate-900"><%= category_count %></td>
                  <td class="whitespace-nowrap px-4 py-3 text-right font-semibold text-slate-900"><%= question_count %></td>
                  <td class="whitespace-nowrap px-4 py-3 align-top text-right text-slate-500"><%= time_ago_in_words(survey.updated_at) %> ago</td>
                  <td class="px-4 py-3 align-top">
                    <div class="flex flex-wrap justify-end gap-2">
                      <%= link_to "Preview", preview_admin_survey_path(survey), class: tailwind_button_classes(:subtle, extra_classes: "btn-sm") %>
                      <%= button_to "Activate", activate_admin_survey_path(survey), method: :patch, data: { turbo_confirm: "Activate '#{survey.title}' for advisors?" }, class: tailwind_button_classes(:primary) %>
                      <%= button_to "Delete", admin_survey_path(survey), method: :delete, data: { turbo_confirm: "Delete '#{survey.title}' permanently?" }, class: tailwind_button_classes(:danger) %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </section>

  <section class="w-full space-y-4">
    <header class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Recent activity</h2>
        <p class="text-sm text-slate-600">Automatic log entries capture who changed each survey and what was updated.</p>
      </div>
      <% if @recent_logs.present? %>
        <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">Last <%= @recent_logs.size %> events</span>
      <% end %>
    </header>

    <% if @recent_logs.blank? %>
      <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50 px-6 py-8 text-center text-sm text-slate-600">No survey activity has been recorded yet.</div>
    <% else %>
      <ul class="space-y-3">
        <% @recent_logs.each do |log| %>
          <li class="flex items-start gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm">
            <div class="mt-1 h-2.5 w-2.5 rounded-full bg-indigo-500" aria-hidden="true"></div>
            <div class="flex-1 space-y-1">
              <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                <strong class="font-semibold text-slate-700"><%= log.admin&.display_name || "Unknown admin" %></strong>
                <span aria-hidden="true">•</span>
                <span><%= log.action.titleize %></span>
                <% if log.survey.present? %>
                  <span aria-hidden="true">•</span>
                  <span>Survey: <strong class="font-semibold text-slate-700"><%= log.survey.title %></strong></span>
                <% end %>
                <span aria-hidden="true">•</span>
                <span><%= time_ago_in_words(log.created_at) %> ago</span>
              </div>
              <p class="text-sm text-slate-600"><%= log.description %></p>
            </div>
          </li>
        <% end %>
      </ul>
    <% end %>
  </section>
</main>
