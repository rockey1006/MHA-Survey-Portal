<!-- Member Management content - layout provides html/head/body and navbar -->
<main class="main-content main-content--dashboard">
    <section class="c-card dashboard-section">
      <div class="section-header">
        <h1 class="section-title">ğŸ‘¥ Member Management</h1>
        <p class="section-subtitle">Manage member roles and permissions for the MHA Program</p>
      </div>

      <!-- Role Summary Cards -->
      <div class="c-stats-grid">
        <div class="c-stat c-stat--info">
          <div class="c-stat__label">ğŸ‘¨â€ğŸ“ Students</div>
          <div class="c-stat__value c-stat__value--md"><%= @role_counts[:student] %></div>
        </div>

        <div class="c-stat c-stat--success">
          <div class="c-stat__label">ğŸ‘¨â€ğŸ« Advisors</div>
          <div class="c-stat__value c-stat__value--md"><%= @role_counts[:advisor] %></div>
        </div>

        <div class="c-stat c-stat--warning">
          <div class="c-stat__label">ğŸ‘¨â€ğŸ’¼ Admins</div>
          <div class="c-stat__value c-stat__value--md"><%= @role_counts[:admin] %></div>
        </div>
      </div>

      <!-- Member Management Form -->
      <%= form_with url: update_roles_path, method: :patch, local: true, id: "role-management-form", data: { turbo: false }, remote: false do |form| %>
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <div class="c-card c-card--flush c-table-wrapper">
          <table class="c-table">
            <thead>
              <tr>
                <th class="table-header-avatar">Avatar</th>
                <th class="table-header-name">Name</th>
                <th class="table-header-email">Email</th>
                <th class="table-header-current-role">Current Role</th>
                <th class="table-header-new-role">New Role</th>
                <th class="table-header-actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @users.each do |user| %>
                <tr class="c-table-row <%= 'current-user' if user == current_user %>">
                  <td class="user-avatar-cell">
                    <div class="c-table-avatar"
                         <% if user.avatar_url.present? %>
                           style="background-image: url('<%= user.avatar_url %>');"
                         <% end %>>
                      <% unless user.avatar_url.present? %>ğŸ‘¤<% end %>
                    </div>
                  </td>
                  
                  <td class="user-name-cell">
                    <div class="c-value"><%= user.full_name || "N/A" %></div>
                    <% if user == current_user %>
                      <span class="c-help">You</span>
                    <% end %>
                  </td>
                  
                  <td>
                    <span class="c-help"><%= user.email %></span>
                  </td>
                  
                  <td class="user-current-role-cell">
                    <span class="role-badge <%= user.role || 'student' %>">
                      <%= (user.role || 'student').upcase %>
                    </span>
                  </td>
                  
                  <td class="user-new-role-cell">
                    <% if user == current_user %>
                      <span class="c-help">Role Locked</span>
                    <% else %>
                      <div class="c-select-wrapper">
                        <%= select_tag "role_updates[#{user.id}]", 
                            options_for_select(User.roles.map { |key, value| [key.titleize, key] }, user.role || 'student'),
                            { 
                              class: 'c-select', 
                              data: { 
                                user_id: user.id, 
                                current_role: user.role || 'student',
                                original_role: user.role || 'student'
                              },
                              id: "role_select_#{user.id}"
                            } %>
                      </div>
                    <% end %>
                  </td>
                  
                  <td class="user-actions-cell">
                    <% if user == current_user %>
                      <span class="c-help">-</span>
                    <% else %>
                      <span class="c-change-indicator" data-user-id="<%= user.id %>">
                        No changes
                      </span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Action Buttons -->
        <div class="c-card c-card--tight mt-6 flex flex-col gap-4">
          <div class="text-sm text-slate-600" id="changes-summary" style="display: none;">
            <span id="role-changes-count" class="c-change-indicator changed">0 changes pending</span>
          </div>

          <div class="flex flex-wrap items-center justify-end gap-3">
            <%= link_to "Cancel", admin_dashboard_path, class: tailwind_button_classes(:secondary) %>
            <%= form.submit "Save Changes", class: tailwind_button_classes(:primary), id: "save-changes-btn", disabled: true %>
          </div>
        </div>

      <% end %>
    </section>
  </main>

  <!-- JavaScript for role management -->
  <script>
    (function() {
      function initManageMembers() {
        const form = document.getElementById('role-management-form');
        if (!form || form.dataset.initialized === 'true') {
          return;
        }

        form.dataset.initialized = 'true';

        const saveButton = document.getElementById('save-changes-btn');
        const changesSummary = document.getElementById('changes-summary');
        const changesCount = document.getElementById('role-changes-count');

        if (!saveButton || !changesSummary || !changesCount) {
          return;
        }

        const pendingChanges = {};

        function findIndicator(userId) {
          return form.querySelector(`.c-change-indicator[data-user-id="${userId}"]`);
        }

        function updateUI() {
          const changeCount = Object.keys(pendingChanges).length;

          if (changeCount > 0) {
            saveButton.disabled = false;
            saveButton.style.opacity = '1';
            saveButton.style.cursor = 'pointer';
            changesSummary.style.display = 'block';
            changesCount.textContent = `${changeCount} change${changeCount > 1 ? 's' : ''} pending`;
            saveButton.setAttribute('data-has-changes', 'true');
          } else {
            saveButton.disabled = true;
            saveButton.style.opacity = '0.5';
            saveButton.style.cursor = 'not-allowed';
            changesSummary.style.display = 'none';
            saveButton.removeAttribute('data-has-changes');
          }
        }

        form.querySelectorAll('.c-select').forEach(select => {
          const userId = select.dataset.userId;
          const originalRole = select.dataset.originalRole || select.dataset.currentRole;
          const indicator = findIndicator(userId);

          if (!indicator) {
            return;
          }

          select.value = originalRole;

          select.addEventListener('change', function() {
            const newRole = this.value;
            const userRow = this.closest('.c-table-row');
            const userName = userRow ? userRow.querySelector('.c-value').textContent.trim() : `User ${userId}`;

            if (newRole !== originalRole) {
              pendingChanges[userId] = {
                oldRole: originalRole,
                newRole: newRole,
                userName: userName
              };

              indicator.textContent = `${originalRole} â†’ ${newRole}`;
              indicator.className = 'c-change-indicator changed';

              if (userRow) {
                userRow.classList.add('c-table-row--changed');
              }
            } else {
              delete pendingChanges[userId];
              indicator.textContent = 'No changes';
              indicator.className = 'c-change-indicator';

              if (userRow) {
                userRow.classList.remove('c-table-row--changed');
              }
            }

            updateUI();
          });
        });

        saveButton.addEventListener('click', function(e) {
          if (this.disabled) {
            e.preventDefault();
            e.stopPropagation();
            alert('No changes to save. Please make role changes first.');
          }
        });

        form.addEventListener('submit', function(e) {
          const changeCount = Object.keys(pendingChanges).length;

          if (changeCount === 0) {
            alert('No changes to save.');
            e.preventDefault();
            return false;
          }

          const changesList = Object.values(pendingChanges)
            .map(change => `â€¢ ${change.userName}: ${change.oldRole} â†’ ${change.newRole}`)
            .join('\n');

          const confirmMessage = `You are about to make ${changeCount} role change${changeCount > 1 ? 's' : ''}:\n\n${changesList}\n\nAre you sure you want to continue?`;

          if (!confirm(confirmMessage)) {
            e.preventDefault();
            return false;
          }

          saveButton.disabled = true;
          saveButton.textContent = 'Saving...';

          return true;
        });

        updateUI();
      }

      document.addEventListener('turbo:load', initManageMembers);
      document.addEventListener('DOMContentLoaded', initManageMembers);
    })();
  </script>
<!-- end of manage members -->