<!DOCTYPE html>
<html lang="en" data-text-scale="<%= (user_signed_in? ? (current_user.text_scale_percent || 100) : 100) %>" style="font-size: <%= ((user_signed_in? ? (current_user.text_scale_percent || 100) : 100).to_f * 16.0 / 100.0).round(2) %>px;">
  <head>
  <!-- allow Google Translate to work on this page -->
    <title><%= content_for(:title) || "MHA Program Portal" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%= favicon_link_tag "tamu-logo.png", rel: "icon", type: "image/png" %>
    <%= favicon_link_tag "tamu-logo.png", rel: "apple-touch-icon", type: "image/png" %>

    <%= tailwind_stylesheet_tag %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="min-h-screen bg-slate-100 text-slate-800 antialiased">
    <style>
      /* Smoothly transition margin changes when browser/toolbars adjust the page */
      html, body { transition: margin-top 0.3s ease !important; will-change: margin-top; }
      /* Allow Google Translate top banner to be visible; we use JS to push the page down smoothly. */
    </style>

    <div class="flex min-h-screen flex-col">
      <!-- Compact Google Translate toggle (top-right under header). Click to open language selector panel. -->
      <div id="gt-compact" aria-hidden="false">
  <button id="gt-toggle" aria-label="Translate site" title="Translate site" style="position:fixed;right:1rem;top:7.5rem;z-index:1300;min-width:5.5rem;height:2.25rem;border-radius:0.5rem;background:#0b57d0;color:white;border:none;box-shadow:0 0.375rem 1.125rem rgba(11,87,208,0.14);cursor:pointer;font-weight:600;padding:0 0.75rem;">Translation</button>
        <div id="gt-panel" style="display:none;position:fixed;right:1rem;top:7.5rem;z-index:1300;background:white;border-radius:0.5rem;padding:0.5rem;box-shadow:0 0.375rem 1.5rem rgba(0,0,0,0.12);">
          <div id="google_translate_element" class="translate-widget" style="min-width:11.25rem;">Loading...</div>
        </div>
      </div>
      <% if content_for?(:header) %>
        <header class="w-full">
          <%= yield :header %>
        </header>
      <% end %>

      <% if flash.any? %>
        <div class="w-full px-4 pt-6">
          <div class="mx-auto w-full space-y-3">
            <% flash.each do |key, value| %>
              <% messages = Array(value).map(&:to_s) %>
              <section class="<%= flash_classes(key) %>" role="alert">
                <div class="flex-1">
                  <p class="text-xs font-semibold uppercase tracking-wide"><%= flash_title(key) %></p>
                  <div class="mt-1 text-sm leading-relaxed">
                    <%= safe_join(messages.map { |msg| tag.span(msg.html_safe) }, tag.br) %>
                  </div>
                </div>
              </section>
            <% end %>
          </div>
        </div>
      <% end %>

      <main class="flex flex-1 flex-col items-center justify-center gap-12 px-4 py-16 md:gap-16">
        <%= yield %>
      </main>
    </div>
  </body>
  <script>
    // Google Translate widget loader + compact toggle/panel behavior
    function googleTranslateElementInit() {
      try {
        if (document.querySelector('#google_translate_element select.goog-te-combo')) return;
        if (window.google && window.google.translate) {
          new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
        }
      } catch (e) { console.warn('googleTranslateElementInit', e); }
    }
    (function() {
      if (!window.__googleTranslateScriptInjected) {
        window.__googleTranslateScriptInjected = true;
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        s.async = true;
        document.head.appendChild(s);
      }

      // Toggle panel logic and move Google's select into our panel (if needed)
      var toggle = function() {
        var panel = document.getElementById('gt-panel');
        if (!panel) return;
        panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
      };
      var btn = document.getElementById('gt-toggle');
      if (btn) btn.addEventListener('click', toggle);

      var tries = 0;
      function adoptSelect() {
        tries++;
        var el = document.querySelector('#google_translate_element select.goog-te-combo');
        var panel = document.getElementById('gt-panel');
        if (el && panel) {
          el.style.width = '100%';
          el.style.height = '2.25rem';
          el.style.display = '';
          var parent = el.closest('#google_translate_element');
          if (parent) {
            Array.from(parent.children).forEach(function(c){ if (c !== el) c.style.display = 'none'; });
          }
          // Ensure the select triggers a reload once if Google sets translation cookie but DOM isn't updated
          try {
            if (!el.dataset.gtChangeBound) {
              el.addEventListener('change', function() {
                setTimeout(function() {
                  var m = document.cookie.match(/(^|; )googtrans=([^;]+)/);
                  if (m && !sessionStorage.getItem('gt_reloaded')) {
                    sessionStorage.setItem('gt_reloaded', '1');
                    location.reload();
                  }
                }, 700);
              });
              el.dataset.gtChangeBound = '1';
            }
          } catch (e) {}
          return;
        }
        if (tries < 12) setTimeout(adoptSelect, 400);
      }
      setTimeout(adoptSelect, 600);
      document.addEventListener('turbo:load', function() {
        try {
          console.log('[Google Translate] Turbo navigation detected, checking translation status...');

          if (window.google && window.google.translate && typeof google.translate.TranslateElement === 'function') {
            googleTranslateElementInit();
          }

          var match = document.cookie.match(/googtrans=([^;]+)/);
          if (match && match[1] && match[1] !== '/auto/en') {
            console.log('[Google Translate] Translation cookie found, attempting to reapply language for new content...');
            var lang = match[1].split('/').pop();
            var combo = document.querySelector('.goog-te-combo');
            if (combo) {
              try { combo.value = lang; combo.dispatchEvent(new Event('change')); } catch (e) {
                console.warn('[Google Translate] Failed to dispatch change on combo, will try fallback reload', e);
                if (!sessionStorage.getItem('gt_turbo_reloaded')) { sessionStorage.setItem('gt_turbo_reloaded', '1'); location.reload(); }
              }
            } else {
              setTimeout(function() {
                var combo2 = document.querySelector('.goog-te-combo');
                if (combo2) {
                  try { combo2.value = lang; combo2.dispatchEvent(new Event('change')); } catch (e) { console.warn('[Google Translate] retry failed', e); }
                } else {
                  console.log('[Google Translate] No combo found after retry, fallback reload.');
                  if (!sessionStorage.getItem('gt_turbo_reloaded')) { sessionStorage.setItem('gt_turbo_reloaded', '1'); location.reload(); }
                }
              }, 1000);
            }
          }
        } catch (e) { console.warn('[Google Translate] Turbo translation refresh failed', e); }

        tries = 0; setTimeout(adoptSelect, 250);
      });

    })();

    document.addEventListener("DOMContentLoaded", function() {
      function adjustForGoogleBar() {
        try {
          var frame = document.querySelector('iframe[id^="goog-gt-"]') || document.querySelector('iframe.goog-te-banner-frame');
          if (frame && frame.clientHeight) {
            var h = frame.clientHeight + 'px';
            document.body.style.setProperty('margin-top', h, 'important');
            document.documentElement.style.setProperty('margin-top', h, 'important');
            document.body.style.setProperty('transform', 'none', 'important');
          } else if (frame) {
            document.body.style.setProperty('margin-top', '40px', 'important');
            document.documentElement.style.setProperty('margin-top', '40px', 'important');
            document.body.style.setProperty('transform', 'none', 'important');
          } else {
            document.body.style.removeProperty('margin-top');
            document.documentElement.style.removeProperty('margin-top');
            document.body.style.removeProperty('transform');
          }
        } catch (e) {}
      }

      adjustForGoogleBar();
      var observer = new MutationObserver(function() { adjustForGoogleBar(); });
      observer.observe(document.documentElement || document.body, { childList: true, subtree: true });
      var checks = 0;
      var interval = setInterval(function() {
        adjustForGoogleBar();
        checks++;
        if (checks > 20) clearInterval(interval);
      }, 300);
    });
  </script>
    <script>
      (function() {
        try {
          var el = document.documentElement;
          var percent = parseFloat(el.getAttribute('data-text-scale')) || 100;
          var px = (16 * percent / 100);
          el.style.fontSize = px + 'px';
          el.style.setProperty('--app-font-scale', (percent/100).toString());
        } catch (e) { console.warn('text-scale apply failed', e); }
      })();
    </script>
</html>
