<main class="main-content">

    <div class="c-toolbar c-toolbar--spaced">
      <div class="c-toolbar__row">
        <%= link_to "â† Back to Surveys", assignments_surveys_path, class: tailwind_button_classes(:secondary) %>
      </div>
    </div>

  <section class="c-card dashboard-section">
    <div class="section-header">
      <h1 class="section-title">Assign Survey</h1>
      <p class="section-subtitle">Survey #<%= @survey_number %>: <%= @survey.title %></p>
    </div>

    <% if @students.present? %>
      <div class="c-card c-card--flush">
        <%= render TableComponent.new(
          headers: ["Student", "Email", "Track", "Status", "Due", "Action"],
          right_align: [5]
        ) do %>
          <% @students.each do |student| %>
            <% assignment = @assignments_by_student_id&.[](student.student_id) %>
            <% assigned = assignment.present? %>
            <% completed = assignment&.completed_at? %>
            <% status_text = completed ? "Completed" : (assigned ? "Assigned" : "Unassigned") %>
            <% due_label = assignment&.due_date.present? ? format_calendar_date(assignment.due_date) : "â€”" %>

            <tr class="transition hover:bg-slate-50">
              <td class="px-4 py-3 text-sm text-slate-700">
                <div class="font-semibold text-slate-900"><%= student.full_name.presence || student.email %></div>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700"><%= student.email %></td>

              <td class="px-4 py-3 text-sm text-slate-700">
                <%= student.track.present? ? student.track.titleize : "â€”" %>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700">
                <span class="<%= survey_status_badge_classes(status_text) %>"><%= status_text %></span>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700"><%= due_label %></td>

              <td class="px-4 py-3 text-sm">
                <% if completed %>
                  <span title="Completed surveys canâ€™t be unassigned.">
                    <button class="<%= tailwind_button_classes(:secondary) %>" disabled>Completed</button>
                  </span>
                <% elsif assigned %>
                  <%= button_to "Unassign",
                                unassign_assignments_survey_path(@survey, student_id: student.student_id),
                                method: :delete,
                                data: { turbo_confirm: "Are you sure you want to unassign â€œ#{@survey.title}â€ from #{student.full_name.presence || student.email}?",
                                        confirm:       "Are you sure you want to unassign â€œ#{@survey.title}â€ from #{student.full_name.presence || student.email}?" },
                                class: tailwind_button_classes(:secondary) %>
                <% else %>
                  <%= button_to "Assign",
                                assign_assignments_survey_path(@survey, student_id: student.student_id),
                                method: :post,
                                class: tailwind_button_classes(:primary),
                                data: { turbo_confirm: "Assign â€œ#{@survey.title}â€ to #{student.full_name.presence || student.email}?",
                                        confirm:       "Assign â€œ#{@survey.title}â€ to #{student.full_name.presence || student.email}?" } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="c-card c-tile" style="max-width: 560px; margin: 0 auto;">
        <div class="c-tile__icon" aria-hidden="true">ğŸ“­</div>
        <div class="c-tile__title">No students available</div>
        <div class="c-tile__description">Students assigned to you will appear here for survey assignment.</div>
      </div>
    <% end %>



    <div style="margin-top: 1rem;" class="flex justify-end">
      <%= button_to "Assign to all in this track",
                    assign_all_assignments_survey_path(@survey),
                    method: :post,
                    data: { turbo_confirm: "Assign â€œ#{@survey.title}â€ to ALL students in this track?",
                            confirm:       "Assign â€œ#{@survey.title}â€ to ALL students in this track?" },
                    class: tailwind_button_classes(:primary) %>
    </div>
  </section>
</main>
