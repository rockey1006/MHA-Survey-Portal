<!DOCTYPE html>
<html lang="en" data-text-scale="<%= (user_signed_in? ? (current_user.text_scale_percent || 100) : 100) %>" style="font-size: <%= ((user_signed_in? ? (current_user.text_scale_percent || 100) : 100).to_f * 16.0 / 100.0).round(2) %>px;">
  <head>
    
    <title><%= content_for(:title) || "Health App" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

  <%= favicon_link_tag "tamu-logo.png", rel: "icon", type: "image/png" %>
  <%= favicon_link_tag "tamu-logo.png", rel: "apple-touch-icon", type: "image/png" %>

  <%# Includes all consolidated stylesheet %>
  <%= tailwind_stylesheet_tag %>
    <%= stylesheet_link_tag(
          "00_tokens_utilities",
          "05_common_assets",
          "10_base_reports",
          "20_header_layout",
          "30_survey_guidance",
          "40_flash",
          "50_forms_tables",
          "60_components_accessibility",
          "data-turbo-track": "reload"
        ) %>
    <%= javascript_importmap_tags %>
    <%# App-wide text scaling: scales BOTH Tailwind rem units and our design-token font-size variables. %>
    <% font_scale = (user_signed_in? ? (current_user.text_scale_percent || 100) : 100).to_f / 100.0 %>
    <style>
      :root {
        --app-font-scale: <%= format("%.2f", font_scale) %>;

        /* Scale token-based font sizes (these are used all over our custom CSS). */
        --font-size-xs: calc(13px * var(--app-font-scale));
        --font-size-sm: calc(15px * var(--app-font-scale));
        --font-size-base: calc(17px * var(--app-font-scale));
        --font-size-lg: calc(19px * var(--app-font-scale));
        --font-size-xl: calc(21px * var(--app-font-scale));
        --font-size-2xl: calc(25px * var(--app-font-scale));
        --font-size-3xl: calc(29px * var(--app-font-scale));
        --font-size-4xl: calc(33px * var(--app-font-scale));
        --font-size-5xl: calc(41px * var(--app-font-scale));
        --font-size-6xl: calc(49px * var(--app-font-scale));
      }

      /* Scale rem-based sizing (Tailwind, spacing, etc.) */
      html { font-size: calc(16px * var(--app-font-scale)); }

      body { line-height: 1.45; }
    </style>
  </head>

  <body
    class="<%= ["min-h-screen bg-slate-50 text-slate-800 antialiased", (content_for?(:body_class) ? yield(:body_class) : nil)].compact.join(" ") %>"
    data-impersonating="<%= impersonating? ? "true" : "false" %>"
    data-impersonation-kind="<%= impersonation_kind %>"
  >
    <style>
      /* Smoothly transition margin changes when browser/toolbars adjust the page */
      html, body { transition: margin-top 0.3s ease !important; will-change: margin-top; }
      /* Allow Google Translate top banner to be visible; we use JS to push the page down smoothly. */
    </style>
    <div class="flex min-h-screen flex-col">
      <% if user_signed_in? %>
        <% case current_user.role %>
        <% when "student" %>
          <%= render "shared/student_navbar", active_page: @active_nav %>
        <% when "advisor" %>
          <%= render "shared/advisor_navbar", active_page: @active_nav %>
        <% when "admin" %>
          <%= render "shared/admin_navbar", active_page: @active_nav %>
        <% end %>
      <% elsif content_for?(:header) %>
        <header class="w-full">
          <%= yield :header %>
        </header>
      <% end %>

      <main class="flex-1 px-4 py-6 sm:px-6 lg:px-8">
        <div class="layout-shell">
          <% if flash.any? %>
            <div class="space-y-3">
              <% flash.each do |key, value| %>
                <% messages = Array(value).map(&:to_s) %>
                <section class="<%= flash_classes(key) %>" role="alert">
                  <div class="flex-1">
                    <p class="text-xs font-semibold uppercase tracking-wide"><%= flash_title(key) %></p>
                    <div class="mt-1 text-sm leading-relaxed">
                      <%= safe_join(messages.map { |msg| tag.span(msg.html_safe) }, tag.br) %>
                    </div>
                  </div>
                </section>
              <% end %>
            </div>
          <% end %>

          <%= yield %>
        </div>
      </main>
    </div>
  </body>
    <script>
      // Google Translate widget loader + compact toggle/panel behavior
      function googleTranslateElementInit() {
        try {
          // If the google select already exists inside our container, nothing to do
          if (document.querySelector('#google_translate_element select.goog-te-combo')) return;
          // Create the widget into the container (idempotent for the container)
          if (window.google && window.google.translate) {
            new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
          }
        } catch (e) { console.warn('googleTranslateElementInit', e); }
      }
      (function() {
        if (!window.__googleTranslateScriptInjected) {
          window.__googleTranslateScriptInjected = true;
          var s = document.createElement('script');
          s.type = 'text/javascript';
          s.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
          s.async = true;
          document.head.appendChild(s);
        }

        // Toggle panel logic and move Google's select into our panel (if needed)
        var toggle = function() {
          var panel = document.getElementById('gt-panel');
          if (!panel) return;
          panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
        };
        var btn = document.getElementById('gt-toggle');
        if (btn) btn.addEventListener('click', toggle);

        var tries = 0;
        function adoptSelect() {
          tries++;
          var el = document.querySelector('#google_translate_element select.goog-te-combo');
          var panel = document.getElementById('gt-panel');
          if (el && panel) {
            el.style.width = '100%';
            el.style.height = '2.25rem';
            el.style.display = '';
            var parent = el.closest('#google_translate_element');
            if (parent) {
              Array.from(parent.children).forEach(function(c){ if (c !== el) c.style.display = 'none'; });
            }
            // Ensure the select triggers a reload once if Google sets translation cookie but DOM isn't updated
            try {
              if (!el.dataset.gtChangeBound) {
                el.addEventListener('change', function() {
                  // give Google a moment to set cookie/state
                  setTimeout(function() {
                    var m = document.cookie.match(/(^|; )googtrans=([^;]+)/);
                    if (m && !sessionStorage.getItem('gt_reloaded')) {
                      sessionStorage.setItem('gt_reloaded', '1');
                      location.reload();
                    }
                  }, 700);
                });
                el.dataset.gtChangeBound = '1';
              }
            } catch (e) {}
            return;
          }
          if (tries < 12) setTimeout(adoptSelect, 400);
        }
        setTimeout(adoptSelect, 600);
        document.addEventListener('turbo:load', function() {
          try {
            console.log('[Google Translate] Turbo navigation detected, checking translation status...');

            // If Google Translate script exists, reinitialize the element (idempotent)
            if (window.google && window.google.translate && typeof google.translate.TranslateElement === 'function') {
              googleTranslateElementInit();
            }

            // Try to detect an active translation via cookie (format: /source/target)
            var match = document.cookie.match(/googtrans=([^;]+)/);
            if (match && match[1] && match[1] !== '/auto/en') {
              console.log('[Google Translate] Translation cookie found, attempting to reapply language for new content...');
              var lang = match[1].split('/').pop();
              var combo = document.querySelector('.goog-te-combo');
              if (combo) {
                try {
                  combo.value = lang;
                  combo.dispatchEvent(new Event('change'));
                } catch (e) {
                  console.warn('[Google Translate] Failed to dispatch change on combo, will try fallback reload', e);
                  // Final fallback: reload once to ensure translation is applied
                  if (!sessionStorage.getItem('gt_turbo_reloaded')) {
                    sessionStorage.setItem('gt_turbo_reloaded', '1');
                    location.reload();
                  }
                }
              } else {
                // select not present yet â€” wait a bit then retry once before reload
                setTimeout(function() {
                  var combo2 = document.querySelector('.goog-te-combo');
                  if (combo2) {
                    try { combo2.value = lang; combo2.dispatchEvent(new Event('change')); } catch (e) { console.warn('[Google Translate] retry failed', e); }
                  } else {
                    console.log('[Google Translate] No combo found after retry, fallback reload.');
                    if (!sessionStorage.getItem('gt_turbo_reloaded')) {
                      sessionStorage.setItem('gt_turbo_reloaded', '1');
                      location.reload();
                    }
                  }
                }, 1000);
              }
            }
          } catch (e) {
            console.warn('[Google Translate] Turbo translation refresh failed', e);
          }

          // ensure adoptSelect runs again to re-parent Google's select into our panel
          tries = 0; setTimeout(adoptSelect, 250);
        });
      })();
    // Detect Google Translate toolbar iframe and add/remove top margin to avoid covering content
    document.addEventListener("DOMContentLoaded", function() {
      function adjustForGoogleBar() {
        try {
          // Look for iframes that Google Translate may inject (ids can vary; use prefix match)
          var frame = document.querySelector('iframe[id^="goog-gt-"]') || document.querySelector('iframe.goog-te-banner-frame');
          if (frame && frame.clientHeight) {
            var h = frame.clientHeight + 'px';
            document.body.style.setProperty('margin-top', h, 'important');
            document.documentElement.style.setProperty('margin-top', h, 'important');
            document.body.style.setProperty('transform', 'none', 'important');
          } else if (frame) {
            // Fallback to a sensible default height
            document.body.style.setProperty('margin-top', '40px', 'important');
            document.documentElement.style.setProperty('margin-top', '40px', 'important');
            document.body.style.setProperty('transform', 'none', 'important');
          } else {
            // Remove any inline overrides so the page returns to its natural layout
            document.body.style.removeProperty('margin-top');
            document.documentElement.style.removeProperty('margin-top');
            document.body.style.removeProperty('transform');
          }
        } catch (e) {
          // ignore errors
        }
      }

      adjustForGoogleBar();

      var observer = new MutationObserver(function() { adjustForGoogleBar(); });
      observer.observe(document.documentElement || document.body, { childList: true, subtree: true });
      // Also periodically check for a short time in case the iframe is injected asynchronously
      var checks = 0;
      var interval = setInterval(function() {
        adjustForGoogleBar();
        checks++;
        if (checks > 20) clearInterval(interval);
      }, 300);
    });
  </script>
    <script>
      // Ensure root font-size is enforced at runtime (helps override any CSS ordering issues)
      (function() {
        try {
          var el = document.documentElement;
          var percent = parseFloat(el.getAttribute('data-text-scale')) || 100;
          var px = (16 * percent / 100);
          el.style.fontSize = px + 'px';
          // also update CSS variable for any runtime styles that reference it
          el.style.setProperty('--app-font-scale', (percent/100).toString());
        } catch (e) {
          console.warn('text-scale apply failed', e);
        }
      })();
    </script>
</html>
