<% survey_title = @survey.title.presence || "Survey ##{@survey.id}" %>

<main class="main-content space-y-8 survey-container">
  <header class="c-card survey-header space-y-1 text-center">
    <h1 class="text-2xl font-semibold text-slate-900"><%= survey_title %></h1>
    <p class="text-sm text-slate-600">
      Semester: <%= @survey.semester.presence || "TBD" %> · Tracks: <%= @track_list.presence&.join(", ") || "Unassigned" %>
    </p>
    <% if @survey.description.present? %>
      <p class="text-sm text-slate-600"><%= @survey.description %></p>
    <% end %>
    <p class="text-xs text-slate-500"><span class="text-red-600" aria-hidden="true">*</span> required to answer</p>
  </header>

  <div class="rounded-xl border border-indigo-100 bg-indigo-50 px-4 py-3 text-sm text-indigo-700">
    Read-only preview of the student experience. Inputs are disabled so you can review safely.
  </div>

  <% if @category_groups.blank? || @category_groups.all? { |category| category.questions.empty? } %>
    <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50 px-6 py-10 text-center text-sm text-slate-600">
      No questions are currently assigned to this survey.
    </div>
  <% else %>
    <div class="space-y-6">
      <% rendered_section_ids = [] %>
      <% section_question_numbers = Hash.new(0) %>
      <% @category_groups.each do |category| %>
        <% section = category.section %>
        <% if section.present? && !rendered_section_ids.include?(section.id) %>
          <div class="c-card space-y-1 border-amber-200 bg-amber-50/70">
            <p class="text-xs font-semibold uppercase tracking-wide text-amber-700">Section</p>
            <h2 class="text-xl font-bold text-[#500000]"><%= section.title %></h2>
            <% if section.description.present? %>
              <p class="text-sm text-slate-700"><%= section.description %></p>
            <% end %>
          </div>
          <% rendered_section_ids << section.id %>
        <% end %>
        <section class="c-card space-y-4">
          <header>
            <h2 class="text-xl font-semibold text-slate-900"><%= category.name %></h2>
            <% if category.description.present? %>
              <p class="text-sm text-slate-600"><%= category.description %></p>
            <% end %>
          </header>

          <% number_key = section&.id || category.id %>
          <% category.questions.ordered.each do |question| %>
            <% is_sub_question = question.sub_question? %>
            <% question_number = section_question_numbers[number_key] %>
            <% question_number = (section_question_numbers[number_key] += 1) unless is_sub_question %>

            <% q_text = question.question_text.to_s.strip %>
            <% desc_text = question.description.to_s.strip.presence %>
            <% tooltip_text = question.tooltip_text.to_s.strip.presence %>
            <% show_mha_tooltip = question.question_type == "multiple_choice" && section&.mha_competency? %>
            <% show_custom_tooltip = tooltip_text.present? && !show_mha_tooltip %>
            <% formatted_desc = desc_text.present? ? desc_text.gsub(/\r?\n/, '<br>').html_safe : nil %>
            <% required = @computed_required[question.id] %>

            <article class="space-y-2 question-block" data-question-id="<%= question.id %>">
              <label class="block text-sm font-medium text-slate-900">
                <% question_prefix = section&.mha_competency? ? "#" : "Q" %>
                <% if is_sub_question %>
                  <span class="font-semibold text-slate-600" aria-label="Sub-question">↳</span>
                <% else %>
                  <span class="font-semibold"><%= question_prefix %><%= question_number %></span>
                <% end %>
                <span class="ml-2 inline-flex flex-col gap-1">
                  <span class="flex items-start justify-between gap-3">
                    <span class="flex flex-wrap items-center gap-2">
                      <span><%= q_text %></span>
                      <% if show_mha_tooltip %>
                        <% if tooltip_text.present? %>
                          <span class="inline-flex"><%= render 'shared/question_tooltip', text: tooltip_text, label: "Show proficiency guidance" %></span>
                        <% else %>
                          <span class="inline-flex"><%= render 'shared/proficiency_tooltip' %></span>
                        <% end %>
                      <% elsif show_custom_tooltip %>
                        <span class="inline-flex"><%= render 'shared/question_tooltip', text: tooltip_text %></span>
                      <% end %>
                      <% if required %>
                        <span class="text-red-600" aria-hidden="true">*</span>
                        <span class="sr-only">Required question</span>
                      <% end %>
                    </span>

                      <% preview_track = (@track_list.is_a?(Array) && @track_list.size == 1) ? @track_list.first : nil %>
                      <% preview_student = preview_track.present? ? OpenStruct.new(track_before_type_cast: preview_track, program_year: nil) : nil %>
                      <% preview_target_level = preview_student ? effective_competency_target_level(question: question, survey: @survey, student: preview_student) : question.program_target_level %>
                      <% if question.question_type_dropdown? && preview_target_level.present? %>
                      <span class="shrink-0 ml-auto text-right">
                          <span class="target-level-badge">Target Level: <%= preview_target_level %>/5</span>
                      </span>
                    <% end %>
                  </span>
                  <% if formatted_desc.present? %>
                    <span class="text-xs text-slate-600"><%= formatted_desc %></span>
                  <% end %>
                </span>
              </label>

              <% case question.question_type %>
              <% when "short_answer" %>
                <textarea rows="3" disabled class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-600 shadow-sm">Student response will appear here</textarea>
              <% when "multiple_choice" %>
                <% option_pairs = question.answer_option_pairs.presence || [] %>
                <div class="flex flex-col gap-2" role="radiogroup">
                  <% option_pairs.each do |label, _value| %>
                    <label class="flex items-center gap-2 text-sm text-slate-800 opacity-75">
                      <input type="radio" disabled class="h-4 w-4 text-blue-600" />
                      <span><%= label %></span>
                    </label>
                  <% end %>
                  <% if option_pairs.empty? %>
                    <p class="text-xs text-slate-500">(No options configured)</p>
                  <% end %>
                </div>
              <% when "scale" %>
                <% scale_labels = scale_labels_for(question) %>
                <% scale_steps = [scale_labels.size, 1].max %>
                <div class="space-y-1">
                  <div class="flex items-center gap-3">
                    <span class="text-xs text-slate-500"><%= scale_labels.first || "Low" %></span>
                    <input type="range" min="1" max="<%= scale_steps %>" value="<%= ((scale_steps + 1) / 2.0).ceil %>" disabled class="w-full" />
                    <span class="text-xs text-slate-500"><%= scale_labels.last || "High" %></span>
                  </div>
                  <div class="flex justify-between text-[0.7rem] text-slate-500">
                    <% scale_labels.each do |label| %>
                      <span><%= label %></span>
                    <% end %>
                  </div>
                </div>
              <% when "evidence" %>
                <div class="space-y-1">
                  <input type="text" disabled value="https://sites.google.com/view/sample" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-600 shadow-sm" />
                  <p class="text-xs text-slate-500">Students paste a publicly shareable Google link (Drive, Docs, Sites, etc.).</p>
                </div>
              <% else %>
                <input type="text" disabled class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-600 shadow-sm" />
              <% end %>
            </article>
          <% end %>
        </section>
      <% end %>
    </div>

    <div class="flex flex-wrap items-center justify-between gap-3 rounded-lg border border-slate-200 bg-white px-5 py-4 shadow-sm">
      <div class="text-sm text-slate-600">Students use these buttons. They are disabled here for safety.</div>
      <div class="flex gap-3">
        <button type="button" disabled class="inline-flex items-center rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-500 opacity-70">Save Progress</button>
        <button type="button" disabled class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white opacity-70">Submit Survey</button>
      </div>
    </div>
  <% end %>

  <div class="flex flex-wrap gap-3">
    <%= link_to "Back to Surveys", admin_surveys_path, class: tailwind_button_classes(:secondary) %>
    <%= link_to "Edit Survey", edit_admin_survey_path(@survey), class: tailwind_button_classes(:primary) %>
  </div>
</main>
