<% content_for :pdf_brand do %>
  Master of Health Administration — Assessment Report
<% end %>

<% content_for :pdf_meta do %>
  Generated: <%= generated_at.strftime("%Y-%m-%d %H:%M") %>
<% end %>

<h1 class="survey-title"><%= survey.title %></h1>

<% latest_student = Array(question_responses).filter_map { |entry| entry.updated_at || entry.created_at }.max %>
<% latest_advisor = feedback_summary[:latest_feedback_at] %>

<div class="user-info">
  <div class="col">
    <div class="label">Student</div>
    <div class="value"><%= student.full_name %></div>
    <div class="muted"><%= student.email %></div>
    <div class="muted">Latest student update: <%= latest_student ? latest_student.strftime("%Y-%m-%d") : "—" %></div>
  </div>
  <div class="col">
    <div class="label">Advisor</div>
    <div class="value"><%= advisor&.display_name || "Unassigned" %></div>
    <% if advisor&.email.present? %>
      <div class="muted"><%= advisor.email %></div>
    <% end %>
    <div class="muted">Latest advisor update: <%= latest_advisor ? latest_advisor.strftime("%Y-%m-%d") : "—" %></div>
  </div>
</div>

<% competency_section_title = "MHA Competency Self-Assessment" %>
<% competency_rows = [] %>
<% competency_rating_question_ids = [] %>

<% categories.each do |cat| %>
  <% next unless cat.section&.title.to_s == competency_section_title %>

  <% cat.questions.ordered.to_a.each do |question| %>
    <% next if question.sub_question? %>
    <% next unless question.question_type == "dropdown" %>

    <% target_level = effective_competency_target_level(question: question, survey: survey, student: student) %>
    <% next unless target_level.present? %>

    <% raw_answer = answers_by_question[question.id] || answers_by_question[question.id.to_s] %>
    <% parts = composite_answer_parts(raw_answer) %>
    <% selected_value = parts[:value].to_s.presence %>
    <% option_pairs = question.answer_option_pairs %>

    <% selected_option_value = nil %>
    <% if selected_value.present? %>
      <% selected_option_value = option_pairs.find { |(_label, value)| value.to_s == selected_value.to_s }&.last %>
      <% selected_option_value ||= option_pairs.find { |(label, _value)| label.to_s == selected_value.to_s }&.last %>
      <% selected_option_value ||= selected_value %>
    <% end %>

    <% student_rating_numeric = selected_option_value.to_s[/\d+/] %>

    <% feedback_for_question = Array(feedbacks_by_category[cat.id]).find { |fb| fb.question_id.to_i == question.id } %>
    <% advisor_rating_numeric = feedback_for_question ? normalize_proficiency_value(feedback_for_question.average_score) : nil %>
    <% advisor_rating_numeric = advisor_rating_numeric.to_s[/\d+/] if advisor_rating_numeric.present? %>

    <% competency_rows << {
      competency: question.question_text.to_s,
      target_level: target_level,
      student_rating: student_rating_numeric,
      advisor_rating: advisor_rating_numeric
    } %>
    <% competency_rating_question_ids << question.id %>
  <% end %>
<% end %>

<% if competency_rows.any? %>
  <% target_values = competency_rows.map { |row| row[:target_level].to_s[/\d+/] }.compact.map(&:to_f) %>
  <% student_values = competency_rows.map { |row| row[:student_rating].to_s[/\d+/] }.compact.map(&:to_f) %>
  <% advisor_values = competency_rows.map { |row| row[:advisor_rating].to_s[/\d+/] }.compact.map(&:to_f) %>
  <% avg_target = target_values.any? ? (target_values.sum / target_values.size) : nil %>
  <% avg_student = student_values.any? ? (student_values.sum / student_values.size) : nil %>
  <% avg_advisor = advisor_values.any? ? (advisor_values.sum / advisor_values.size) : nil %>

  <section class="pdf-section">
    <h2 class="section-title">Competency Summary</h2>
    <table class="competency-table">
      <thead>
        <tr>
          <th>Competency</th>
          <th>Target Level</th>
          <th>Student Rating</th>
          <th>Advisor Rating</th>
        </tr>
      </thead>
      <tbody>
        <% competency_rows.each do |row| %>
          <tr>
            <td><%= row[:competency] %></td>
            <td class="numeric"><%= row[:target_level].present? ? row[:target_level] : "—" %></td>
            <td class="numeric"><%= row[:student_rating].present? ? row[:student_rating] : "—" %></td>
            <td class="numeric"><%= row[:advisor_rating].present? ? row[:advisor_rating] : "—" %></td>
          </tr>
        <% end %>

        <tr>
          <td><strong>Average</strong></td>
          <td class="numeric"><%= avg_target ? format("%.2f", avg_target) : "—" %></td>
          <td class="numeric"><%= avg_student ? format("%.2f", avg_student) : "—" %></td>
          <td class="numeric"><%= avg_advisor ? format("%.2f", avg_advisor) : "—" %></td>
        </tr>
      </tbody>
    </table>
  </section>
<% end %>

<section class="pdf-section">
  <h2 class="section-title">Student Responses</h2>

  <% rendered_section_ids = [] %>
  <% section_question_numbers = Hash.new(0) %>

  <% categories.each do |category| %>
    <% section = category.section %>
    <% if section.present? && !rendered_section_ids.include?(section.id) %>
      <div class="section-card">
        <div class="section-kicker">Section</div>
        <div class="section-name"><%= section.title %></div>
        <% if section.description.present? %>
          <div class="section-description"><%= simple_format(section.description.to_s) %></div>
        <% end %>
      </div>
      <% rendered_section_ids << section.id %>
    <% end %>

    <div class="category-block">
      <div class="category-header">
        <h3 class="category-title"><%= category.name %></h3>
        <% if category.description.present? %>
          <div class="category-description"><%= simple_format(category.description.to_s) %></div>
        <% end %>
      </div>

      <% ordered_questions = category.questions.ordered.to_a %>
      <% feedback_entries = feedbacks_by_category[category.id] || [] %>
      <% feedback_by_question_id = feedback_entries.group_by(&:question_id) %>
      <% show_inline_feedback = category.section&.title.to_s == "MHA Competency Self-Assessment" %>
      <% if ordered_questions.any? %>
        <% number_key = section&.id || category.id %>
        <% question_number = section_question_numbers[number_key] %>
        <% questions_by_id = ordered_questions.index_by(&:id) %>

        <% ordered_questions.each_with_index do |question, index| %>
          <%# Hide conditional subquestions (e.g. Employment follow-ups) unless parent is answered "Yes" %>
          <% if question.sub_question? %>
            <% parent = questions_by_id[question.parent_question_id] %>
            <% parent_raw = parent ? (answers_by_question[parent.id] || answers_by_question[parent.id.to_s]) : nil %>
            <% parent_value = composite_answer_parts(parent_raw)[:value].to_s %>
            <% parent_options = parent ? parent.answer_options_list.map { |opt| opt.to_s.strip.downcase } : [] %>
            <% conditional_yes_no = parent.present? && parent.question_type == "multiple_choice" && parent_options.include?("yes") && parent_options.include?("no") %>
            <% next if conditional_yes_no && !parent_value.casecmp?("Yes") %>
          <% end %>

          <% response_record = responses_by_question[question.id] %>
          <% raw_answer = answers_by_question[question.id] || answers_by_question[question.id.to_s] %>
          <% parts = composite_answer_parts(raw_answer) %>
          <% answer_value = parts[:value] %>
          <% answer_text = composite_display_answer(raw_answer) %>
          <% truncated_answer, answer_truncated = truncate_for_composite_pdf(answer_text) %>

          <% effective_target_level = effective_competency_target_level(question: question, survey: survey, student: student) %>
          <% is_competency_rating_row = show_inline_feedback && competency_rating_question_ids.include?(question.id) && question.question_type == "dropdown" && effective_target_level.present? %>
          <% if is_competency_rating_row %>
            <% next %>
          <% end %>

          <% question_number = (section_question_numbers[number_key] += 1) unless question.sub_question? %>
          <div class="question-block">
            <div class="question-header">
              <% if question.sub_question? %>
                <span class="question-number">↳</span>
              <% else %>
                <span class="question-number">Q<%= question_number %></span>
              <% end %>
              <div class="question-heading">
                <div class="question-body"><%= question.question_text %></div>
                <% if question.question_type == "dropdown" && effective_target_level.present? %>
                  <div class="target-level-wrap">
                    <span class="target-level-badge">Target Level: <%= effective_target_level %>/5</span>
                  </div>
                <% end %>
              </div>
            </div>

            <% if question.description.to_s.strip.present? %>
              <div class="question-description"><%= simple_format(question.description.to_s) %></div>
            <% end %>

            <div class="question-answer">
              <% case question.question_type %>
              <% when "multiple_choice" %>
                <% selected_values = Array(answer_value).map(&:to_s) %>
                <% option_pairs = question.answer_option_pairs.presence || [] %>

                <ul class="choice-list">
                  <% option_pairs.each do |label, value| %>
                    <% chosen = selected_values.any? { |val| val.to_s == value.to_s || val.casecmp?(label.to_s) } %>
                    <li class="choice-item <%= chosen ? 'selected' : '' %>">
                      <span class="choice-marker"><%= chosen ? '●' : '○' %></span>
                      <span><%= label %></span>
                    </li>
                  <% end %>
                </ul>

                <% show_other_text = selected_values.any? { |val| question.answer_option_requires_text?(val) || val.casecmp?("Other") } %>
                <% if show_other_text && parts[:text].present? %>
                  <div class="answer-text" style="margin-top: 6px;">
                    <strong>Other:</strong> <%= parts[:text] %>
                  </div>
                <% end %>
              <% when "scale" %>
                <% scale_display = scale_label_for_value(question, answer_value) %>
                <div class="answer-text">
                  <strong>Rating:</strong>
                  <%= answer_value.present? ? scale_display : "Not answered" %>
                  <% if answer_value.present? && scale_display.to_s != answer_value.to_s %>
                    <span class="muted">(Value <%= answer_value %>)</span>
                  <% end %>
                </div>
              <% when "dropdown" %>
                <% option_pairs = question.answer_option_pairs %>
                <% selected_value = answer_value.to_s.presence %>
                <% selected_option_value = nil %>
                <% if selected_value.present? %>
                  <% selected_option_value = option_pairs.find { |(_label, value)| value.to_s == selected_value }&.last %>
                  <% selected_option_value ||= option_pairs.find { |(label, _value)| label.to_s == selected_value }&.last %>
                  <% selected_option_value ||= selected_value %>
                <% end %>

                <div class="answer-text">
                  <% if selected_value.present? %>
                    <select class="pdf-select" disabled>
                      <option value=""></option>
                      <% option_pairs.each do |label, value| %>
                        <option value="<%= value %>" <%= value.to_s == selected_option_value.to_s ? "selected" : "" %>><%= label %></option>
                      <% end %>
                    </select>
                  <% else %>
                    Not answered
                  <% end %>
                </div>

                <% show_other_text = selected_value.present? && (question.answer_option_requires_text?(selected_value) || question.answer_option_requires_text?(selected_option_value) || selected_value.casecmp?("Other")) %>
                <% if show_other_text && parts[:text].present? %>
                  <div class="answer-text" style="margin-top: 6px;">
                    <strong>Other:</strong> <%= parts[:text] %>
                  </div>
                <% end %>
              <% when "evidence" %>
                <div class="answer-text">
                  <% evidence_link = parts[:link].presence || answer_value.to_s.presence %>
                  <% if evidence_link.present? %>
                    <% link_label = answer_truncated ? "View evidence" : truncated_answer %>
                    <a href="<%= evidence_link %>"><%= link_label %></a>
                    <% if answer_truncated %>
                      <div class="truncation-note">Link truncated for PDF readability.</div>
                    <% end %>
                  <% else %>
                    Not provided
                  <% end %>
                </div>
                <% evidence_history = Array(evidence_history_by_category[category.id]).select { |item| item.question_id == question.id } %>
                <% if evidence_history.size > 1 %>
                  <div class="history-label">Previous submissions:</div>
                  <ul class="history-list">
                    <% evidence_history.each do |entry| %>
                      <% timestamp = entry.updated_at || entry.created_at %>
                      <% history_text, history_truncated = truncate_for_composite_pdf(entry.answer) %>
                      <li>
                        <%= timestamp ? timestamp.strftime("%Y-%m-%d") : "—" %> — <%= history_text %>
                        <% if history_truncated %>
                          <span class="muted">(truncated)</span>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                <% end %>
              <% else %>
                <div class="answer-text">
                  <% if truncated_answer.present? %>
                    <%= simple_format(truncated_answer) %>
                    <% if answer_truncated %>
                      <div class="truncation-note">Full response available in the Health application.</div>
                    <% end %>
                  <% else %>
                    No response provided
                  <% end %>
                </div>
              <% end %>
            </div>

            <div class="question-meta">
              <span class="muted">Last updated: <%= response_record&.updated_at ? response_record.updated_at.strftime("%Y-%m-%d") : "—" %></span>
              <% unless response_record&.answer.present? %>
                <span class="badge badge-warning">Missing</span>
              <% end %>
            </div>

            <% next_question = ordered_questions[index + 1] %>
            <% group_parent_id = question.sub_question? ? question.parent_question_id : question.id %>
            <% end_of_parent_group = next_question.nil? || !next_question.sub_question? || next_question.parent_question_id != group_parent_id %>
            <% feedback_for_parent = (feedback_by_question_id[group_parent_id] || []).first %>
          </div>

          <% if show_inline_feedback && end_of_parent_group && feedback_for_parent.present? %>
            <% timestamp = feedback_for_parent.updated_at || feedback_for_parent.created_at %>
            <% selected_proficiency = normalize_proficiency_value(feedback_for_parent.average_score) %>
            <div class="feedback-block">
              <div class="feedback-header">
                <div><strong>Advisor feedback</strong> <span class="muted">(<%= feedback_for_parent.advisor&.display_name || "—" %>)</span></div>
                <div class="feedback-score">
                  <% if selected_proficiency.present? %>
                    <select class="pdf-select" disabled>
                      <option value=""></option>
                      <% proficiency_option_pairs_for(question).each do |label, value| %>
                        <option value="<%= value %>" <%= value.to_s == selected_proficiency.to_s ? "selected" : "" %>><%= label %></option>
                      <% end %>
                    </select>
                  <% else %>
                    —
                  <% end %>
                </div>
              </div>

              <% comments_text, comments_truncated = truncate_for_composite_pdf(feedback_for_parent.comments) %>
              <div class="feedback-comments">
                <% if comments_text.present? %>
                  <%= simple_format(comments_text) %>
                  <% if comments_truncated %>
                    <div class="truncation-note">Full feedback available in the Health application.</div>
                  <% end %>
                <% else %>
                  <div class="feedback-empty">No feedback provided</div>
                <% end %>
              </div>
              <div class="feedback-meta muted">Updated: <%= timestamp ? timestamp.strftime("%Y-%m-%d") : "—" %></div>
            </div>
          <% end %>
        <% end %>
      <% else %>
        <div class="empty-state">No questions recorded for this category.</div>
      <% end %>
    </div>
  <% end %>
</section>

<% legacy_feedback_by_category = feedbacks_by_category.transform_values { |entries| Array(entries).select { |entry| entry.question_id.blank? } } %>
<% if legacy_feedback_by_category.values.any?(&:any?) %>
  <section class="pdf-section">
    <h2 class="section-title">Advisor Feedback</h2>
    <% categories.each do |category| %>
      <% feedback_entries = legacy_feedback_by_category[category.id] || [] %>
      <% next unless feedback_entries.any? %>

      <div class="feedback-category">
        <div class="category-header">
          <h3 class="category-title"><%= category.name %></h3>
        </div>

        <% feedback_entries.each do |feedback| %>
          <% timestamp = feedback.updated_at || feedback.created_at %>
          <div class="feedback-block">
            <div class="feedback-header">
              <div><strong>Advisor:</strong> <%= feedback.advisor&.display_name || "—" %></div>
              <div class="feedback-score">
                Score: <%= feedback.average_score != nil ? format('%.2f', feedback.average_score.to_f) : "—" %>
              </div>
            </div>
            <% comments_text, comments_truncated = truncate_for_composite_pdf(feedback.comments) %>
            <div class="feedback-comments">
              <% if comments_text.present? %>
                <%= simple_format(comments_text) %>
                <% if comments_truncated %>
                  <div class="truncation-note">Full feedback available in the Health application.</div>
                <% end %>
              <% else %>
                <div class="feedback-empty">No feedback provided</div>
              <% end %>
            </div>
            <div class="feedback-meta muted">Updated: <%= timestamp ? timestamp.strftime("%Y-%m-%d") : "—" %></div>
          </div>
        <% end %>
      </div>
    <% end %>
  </section>
<% end %>

<%# Advisor feedback summary (PDF only). Render only when we have 2+ scored feedback entries with target levels. %>
<%
  questions_by_id_for_summary = categories.flat_map(&:questions).index_by(&:id)
  feedback_rows_for_summary = feedbacks_by_category.values.flatten.select { |entry| entry.question_id.present? && entry.average_score != nil }
  scored_feedback_count = feedback_rows_for_summary.size

  summary_total = 0
  summary_at_or_above = 0
  summary_below = 0

  feedback_rows_for_summary.each do |entry|
    question = questions_by_id_for_summary[entry.question_id]
    target = effective_competency_target_level(question: question, survey: survey, student: student)
    next if target.blank?

    score = entry.average_score.to_f
    summary_total += 1
    if score >= target.to_f
      summary_at_or_above += 1
    else
      summary_below += 1
    end
  end

  summary_at_pct = summary_total.positive? ? ((summary_at_or_above.to_f / summary_total) * 100).round(1) : 0.0
  summary_below_pct = summary_total.positive? ? ((summary_below.to_f / summary_total) * 100).round(1) : 0.0
%>

<% if scored_feedback_count >= 1 %>
  <section class="c-card summary-card" data-advisor-feedback-summary>
    <div class="advisor-summary__header">
      <h3 class="advisor-summary__title">Summary Statistics</h3>
      <p class="advisor-summary__hint">Based on saved advisor scores</p>
    </div>

    <div class="advisor-summary__grid">
      <div class="advisor-summary__card advisor-summary__card--above">
        <div class="advisor-summary__cardRow">
          <div class="advisor-summary__meta">
            <div class="advisor-summary__label">At or Above Target</div>
            <div class="advisor-summary__percent">(<%= summary_at_pct %>%)</div>
          </div>
          <div class="advisor-summary__value">
            <div class="advisor-summary__count advisor-summary__count--above"><%= summary_at_or_above %></div>
          </div>
        </div>
      </div>

      <div class="advisor-summary__card advisor-summary__card--below">
        <div class="advisor-summary__cardRow">
          <div class="advisor-summary__meta">
            <div class="advisor-summary__label">Below End of Program Target</div>
            <div class="advisor-summary__percent">(<%= summary_below_pct %>%)</div>
          </div>
          <div class="advisor-summary__value">
            <div class="advisor-summary__count advisor-summary__count--below"><%= summary_below %></div>
          </div>
        </div>
      </div>
    </div>

    <div class="advisor-summary__footer">
      <p class="advisor-summary__note">
        Based on advisor scores (0–5) compared to each question’s program target level.
      </p>
    </div>
  </section>
<% end %>
