<main class="main-content main-content--dashboard">
  <div class="c-toolbar">
    <div class="c-toolbar__row items-center w-full gap-3">
      <div class="shrink-0">
        <%= link_to "Cancel", admin_dashboard_path, class: "btn btn-secondary", data: { turbo: false } %>
      </div>
    </div>
  </div>

  <section class="c-card dashboard-section">
    <div class="section-header">
      <h1 class="section-title">Target Levels</h1>
      <p class="section-subtitle">Set program target levels per competency, semester, track, and year.</p>
    </div>

    <% if @post_save_warning.present? %>
      <div class="c-card c-card--tight mb-6" role="alert">
        <p class="text-sm text-slate-900">
          <span class="font-semibold">Warning:</span>
          <%= @post_save_warning %>
        </p>
      </div>
    <% end %>

    <%= form_with url: admin_target_levels_path, method: :get, local: true, data: { turbo: false } do %>
      <div class="c-card c-card--tight mb-6">
        <div class="flex flex-wrap items-end gap-4">
          <div class="min-w-[14rem]">
            <label class="block text-sm font-medium text-slate-700">Semester</label>
            <div class="c-select-wrapper mt-1">
              <%= select_tag :program_semester_id,
                options_for_select([["Select a semester", ""]] + @semesters.map { |s| [s.name, s.id] }, @selected_semester_id),
                class: "c-select" %>
            </div>
          </div>

          <div class="min-w-[12rem]">
            <label class="block text-sm font-medium text-slate-700">Track</label>
            <div class="c-select-wrapper mt-1">
              <%= select_tag :track,
                options_for_select([["Select a track", ""]] + @tracks.map { |t| [t, t] }, @selected_track),
                class: "c-select" %>
            </div>
          </div>

          <div class="min-w-[10rem]">
            <label class="block text-sm font-medium text-slate-700">Year</label>
            <div class="c-select-wrapper mt-1">
              <%= select_tag :program_year,
                options_for_select(@program_year_options, @selected_program_year.to_s),
                class: "c-select" %>
            </div>
          </div>

          <div>
            <%= submit_tag "Apply Filters", class: tailwind_button_classes(:secondary) %>
          </div>
        </div>
      </div>
    <% end %>

    <% if @selected_semester_id.present? && @selected_track.present? %>
      <% confirm_message = if @submitted_students_count.to_i.positive?
        "Warning: #{@submitted_students_count} student(s) have already submitted surveys for this cohort. Saving target levels may change how reports are interpreted. Continue?"
      else
        "Save target levels?"
      end %>

      <%= form_with url: admin_target_levels_path,
                    method: :patch,
                    local: true,
                    data: {
                      turbo: false,
                      controller: "confirm-submit",
                      action: "submit->confirm-submit#confirm",
                      "confirm-submit-message-value": confirm_message
                    } do %>
        <%= hidden_field_tag :program_semester_id, @selected_semester_id %>
        <%= hidden_field_tag :track, @selected_track %>
        <%= hidden_field_tag :program_year, @selected_program_year %>

        <div class="c-card c-card--flush c-table-wrapper">
          <table class="c-table">
            <thead>
              <tr>
                <th style="min-width: 28rem;">Competency</th>
                <th style="min-width: 10rem;">Target (1-5)</th>
                <th style="min-width: 12rem;">Changes</th>
              </tr>
            </thead>
            <tbody>
              <% @competencies.each_with_index do |title, idx| %>
                <% original_value = @targets_by_title[title].to_s %>
                <tr>
                  <td>
                    <div class="font-medium text-slate-900"><%= title %></div>
                  </td>
                  <td>
                    <%= hidden_field_tag "targets[#{idx}][competency_title]", title %>
                    <div class="c-select-wrapper">
                      <%= render "shared/proficiency_select",
                                 name: "targets[#{idx}][target_level]",
                                 selected: original_value,
                                 id: "target_level_#{idx}",
                                 class_name: "c-select js-target-level-select",
                                 data: { row_id: idx, original_value: original_value } %>
                    </div>
                  </td>
                  <td>
                    <span class="c-change-indicator" data-row-id="<%= idx %>">No changes</span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <script>
          (function() {
            function initTargetLevelChangeIndicators() {
              const selects = document.querySelectorAll('.js-target-level-select');
              if (!selects.length) return;

              function labelFor(selectEl, value) {
                const option = Array.from(selectEl.options).find(o => o.value === value);
                return option ? option.text.trim() : (value || '');
              }

              selects.forEach(selectEl => {
                const rowId = selectEl.dataset.rowId;
                const originalValue = selectEl.dataset.originalValue || '';
                const indicator = document.querySelector(`.c-change-indicator[data-row-id="${rowId}"]`);
                if (!indicator) return;

                function updateIndicator() {
                  const currentValue = selectEl.value || '';
                  if (currentValue === originalValue) {
                    indicator.textContent = 'No changes';
                    indicator.className = 'c-change-indicator';
                    return;
                  }

                  const fromLabel = labelFor(selectEl, originalValue) || '—';
                  const toLabel = labelFor(selectEl, currentValue) || '—';
                  indicator.textContent = `${fromLabel} → ${toLabel}`;
                  indicator.className = 'c-change-indicator changed';
                }

                selectEl.addEventListener('change', updateIndicator);
                updateIndicator();
              });
            }

            document.addEventListener('turbo:load', initTargetLevelChangeIndicators);
            document.addEventListener('DOMContentLoaded', initTargetLevelChangeIndicators);
          })();
        </script>

        <div class="c-card c-card--tight mt-6 flex flex-wrap items-center justify-end gap-3">
          <%= link_to "Cancel", admin_dashboard_path, class: tailwind_button_classes(:secondary), data: { turbo: false } %>
          <%= submit_tag "Save Target Levels", class: tailwind_button_classes(:primary) %>
        </div>
      <% end %>
    <% else %>
      <div class="c-card c-card--tight">
        <p class="text-sm text-slate-700">Select a semester and track above to view and edit competency target levels.</p>
      </div>

      <div class="c-card c-card--tight mt-6 flex flex-wrap items-center justify-end gap-3">
        <%= link_to "Cancel", admin_dashboard_path, class: tailwind_button_classes(:secondary), data: { turbo: false } %>
      </div>
    <% end %>
  </section>
</main>
