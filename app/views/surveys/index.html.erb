<% welcome_source = @student&.user&.name.presence || current_user&.name.presence || current_user&.email.presence %>
<% welcome_name = welcome_source.to_s.split(/\s+/).first.presence || "Welcome" %>
<main class="px-4 py-8">
  <div class="c-container c-page">
    <section class="c-hero c-hero--maroon">
      <div class="c-page-header">
        <div class="u-stack u-stack--sm">
          <p class="c-eyebrow c-eyebrow--inverse">My Surveys</p>
          <h1 class="c-h2 c-h2--inverse"><%= welcome_name %>, here's what's waiting for you</h1>
          <% if @student&.track.present? %>
            <p class="c-lede c-lede--inverse">You are viewing surveys for the <strong><%= @student.track %></strong> track.</p>
          <% else %>
            <p class="c-lede c-lede--inverse">Select your program track so we can curate the correct surveys for you.</p>
          <% end %>
        </div>

        <dl class="c-kv c-kv--inverse c-kv--compact u-text-right">
          <dt class="c-eyebrow c-eyebrow--inverse">Semester</dt>
          <dd class="c-value c-value--xl c-value--inverse"><%= @current_semester_label %></dd>
        </dl>
      </div>
    </section>

    <% if @student&.track.blank? %>
      <section class="c-card c-card--spacious u-stack">
        <h2 class="c-h2">Finish setting up your profile</h2>
        <p class="c-lede">We need to know your track before we can display the correct surveys. Head over to your profile and select Residential or Executive.</p>
        <%= link_to "Complete Profile", edit_student_profile_path, class: tailwind_button_classes(:primary) %>
      </section>
    <% elsif @surveys.any? %>
      <div class="u-grid" style="--u-grid-min: 280px" role="list">
      <% @surveys.each do |survey| %>
        <% assignment = @assignment_lookup[survey.id] %>
        <% offering = @offerings_by_survey_id[survey.id] %>
        <% status_label, status_variant = if assignment&.completed_at?
            ["Completed", "success"]
          elsif assignment.present?
            ["In Progress", "info"]
          else
            ["Not Started", "muted"]
          end %>
        <% due_note = survey_availability_note(assignment&.available_until) %>
        <article class="c-card c-card--interactive survey-card" role="listitem">
          <header class="survey-card__header">
            <div>
              <p class="survey-card__semester"><%= survey.semester.presence || "Semester TBD" %></p>
              <h2><%= link_to survey.title, survey_path(survey) %></h2>
              <% if (review_note = review_meetings_note(offering)).present? %>
                <p style="margin-top: 0.25rem; font-size: 0.85rem; color: #4b5563;">
                  Review meetings: <%= review_note %>
                </p>
              <% end %>
            </div>
            <div class="survey-card__status">
              <span class="status-badge status-badge--<%= status_variant %>"><%= status_label %></span>
              <span class="status-note"><%= due_note %></span>
            </div>
          </header>

          <ul class="survey-card__stats">
            <li>
              <span>Questions</span>
              <strong><%= survey.questions.count %></strong>
            </li>
            <li>
              <span>Track</span>
              <strong><%= survey.track_list.presence&.join(" â€¢ ") || "Unassigned" %></strong>
            </li>
            <li>
              <span>Last updated</span>
              <strong><%= l survey.updated_at, format: :long %></strong>
            </li>
          </ul>

          <p class="survey-card__description"><%= survey.description.presence || "Complete this survey to capture your latest progress." %></p>

          <footer class="survey-card__footer">
            <% if assignment&.completed_at? %>
              <% survey_response = SurveyResponse.build(student: @student, survey: survey) %>
              <% can_edit = assignment.available_until.blank? || assignment.available_until >= Time.current %>
              <%= link_to "View Submission", survey_response_path(survey_response), class: tailwind_button_classes(:secondary) %>
              <%= link_to "Download PDF", download_survey_response_path(survey_response), class: tailwind_button_classes(:secondary) %>
              <% if can_edit %>
                <%= link_to "Edit", survey_path(survey), class: tailwind_button_classes(:primary) %>
              <% else %>
                  <button type="button" class="<%= tailwind_button_classes(:primary) %> opacity-50 cursor-not-allowed" disabled aria-disabled="true">Edit</button>
              <% end %>
            <% else %>
              <%= link_to "Open Survey", survey_path(survey), class: tailwind_button_classes(:primary) %>
            <% end %>
          </footer>
        </article>
      <% end %>
    </div>
    <% else %>
      <section class="c-card c-card--spacious u-stack">
        <h2 class="c-h2">No surveys assigned (yet)</h2>
        <p class="c-lede">Your advisor hasn't published surveys for the <%= @student.track %> track. We'll notify you as soon as one arrives.</p>
        <%= link_to "Back to dashboard", student_dashboard_path, class: tailwind_button_classes(:secondary) %>
      </section>
    <% end %>
  </div>
</main>


