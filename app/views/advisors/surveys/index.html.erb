<main class="main-content">
  <section class="c-card dashboard-section u-stack u-stack--xl">
    <div class="section-header">
      <h1 class="section-title">Available Surveys</h1>
      <p class="section-subtitle">
        Quickly review the surveys you can assign to advisees. Current semester: <strong><%= ProgramSemester.current_name || "Not set" %></strong>
      </p>
    </div>

    <% if @surveys.present? %>
      <div class="c-stats-grid">
        <div class="c-stat c-stat--muted">
          <div class="c-stat__label">Total surveys</div>
          <div class="c-stat__value c-stat__value--md"><%= @surveys.size %></div>
        </div>

        <div class="c-stat c-stat--muted">
          <div class="c-stat__label">Tracks covered</div>
          <div class="c-stat__value c-stat__value--md"><%= @surveys.flat_map(&:track_list).uniq.sort.presence&.size || 0 %></div>
          <div class="c-stat__subtext"><%= @surveys.flat_map(&:track_list).uniq.sort.presence&.join(", ") || "â€”" %></div>
        </div>

        <div class="c-stat c-stat--muted">
          <div class="c-stat__label">Last updated</div>
          <div class="c-stat__value c-stat__value--md">â€”</div>
          <div class="c-stat__subtext"><%= l(@surveys.max_by(&:updated_at).updated_at, format: :long) rescue "Unknown" %></div>
        </div>
      </div>

      <div class="u-grid" style="--u-grid-min: 280px">
        <% @surveys.each do |survey| %>
          <% track_labels = survey.track_list %>
          <% description = survey.try(:description) || survey.categories.limit(3).map(&:name).join(", ") %>
          <% cleaned_title = survey.title.to_s.sub(/^survey\s*#?:\s*/i, '').gsub('#', '').squish %>
          <% display_title = cleaned_title.presence || survey.title %>
          <article class="c-card c-card--hover u-stack u-stack--md">
            <header class="u-actions u-actions--split" style="align-items: flex-start;">
              <div class="u-stack u-stack--sm">
                <p class="c-eyebrow">Semester <%= survey.semester.presence || "N/A" %></p>
                <h2 class="c-h3" style="margin: 0;"><%= display_title %></h2>
              </div>

              <% if survey.is_active? %>
                <span class="c-pill"><span class="c-pill__dot c-pill__dot--brand" aria-hidden="true"></span>Active</span>
              <% else %>
                <span class="c-pill"><span class="c-pill__dot" aria-hidden="true"></span>Archived</span>
              <% end %>
            </header>

            <% if description.present? %>
              <p class="c-lede" style="margin: 0;"><%= description %></p>
            <% end %>

            <dl class="u-grid" style="--u-grid-min: 160px; gap: var(--spacing-md)">
              <div class="c-kv c-kv--compact">
                <dt class="c-eyebrow">Categories</dt>
                <dd class="c-value c-value--lg"><%= survey.categories.size %></dd>
              </div>
              <div class="c-kv c-kv--compact">
                <dt class="c-eyebrow">Questions</dt>
                <dd class="c-value c-value--lg"><%= survey.questions.size %></dd>
              </div>
              <div class="c-kv c-kv--compact">
                <dt class="c-eyebrow">Updated</dt>
                <dd class="c-value c-value--lg"><%= l(survey.updated_at, format: :short) rescue "â€”" %></dd>
              </div>
            </dl>

            <% if track_labels.present? %>
              <div class="u-actions u-actions--start">
                <% track_labels.each do |track| %>
                  <span class="c-pill"><%= track %></span>
                <% end %>
              </div>
            <% end %>

            <div class="u-actions u-actions--split">
              <div class="c-eyebrow">ID: <%= survey.id %></div>
              <%= link_to "Assign to Students", advisors_survey_path(survey), class: tailwind_button_classes(:secondary), data: { turbo: false } %>
            </div>
          </article>
        <% end %>
      </div>
    <% else %>
      <div class="c-card c-tile" style="max-width: 560px; margin: 0 auto;">
        <div class="c-tile__icon" aria-hidden="true">ðŸ“­</div>
        <div class="c-tile__title">No surveys available</div>
        <div class="c-tile__description">Create a survey first to begin assigning it to students.</div>
      </div>
    <% end %>

    <!-- Back button row -->
    <div class="u-actions u-actions--start mt-xl">
      <%= link_to "â† Back",
                  advisor_dashboard_path,
                  class: tailwind_button_classes(:secondary),
                  data: { turbo: false } %>
    </div>
  </section>
</main>
