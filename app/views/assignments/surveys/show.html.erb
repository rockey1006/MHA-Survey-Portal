<main class="main-content">

    <div class="c-toolbar c-toolbar--spaced">
      <div class="c-toolbar__row">
        <%= link_to "â† Back to Surveys", assignments_surveys_path, class: tailwind_button_classes(:secondary) %>
      </div>
    </div>

  <section class="c-card dashboard-section">
    <div class="section-header">
      <h1 class="section-title">Assign Survey</h1>
      <p class="section-subtitle">Survey #<%= @survey_number %>: <%= @survey.title %></p>
    </div>

    <section class="c-card c-card--flush mb-6">
      <div class="px-4 py-5 sm:px-6">
        <h2 class="text-lg font-semibold text-slate-900">Assign to a group</h2>
        <p class="text-sm text-slate-600">Choose a track, class year, or both to assign this survey in bulk.</p>
      </div>
      <div class="px-4 pb-6 sm:px-6">
        <%= form_with url: assign_all_assignments_survey_path(@survey), method: :post, local: true, class: "grid gap-4 md:grid-cols-3" do %>
          <div class="space-y-2">
            <label for="bulk_track" class="block text-sm font-medium text-slate-700">Track</label>
            <%= select_tag :track,
                           options_for_select([ ["All tracks", ""] ] + Array(@track_options).map { |track| [track, track] }, @default_track_label),
                           id: "bulk_track",
                           class: "w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
          </div>

          <div class="space-y-2">
            <label for="bulk_program_year" class="block text-sm font-medium text-slate-700">Class year</label>
            <%= select_tag :program_year,
                           options_for_select([ ["All years", ""] ] + Array(@year_options).map { |year| ["Class of #{year}", year] }),
                           id: "bulk_program_year",
                           class: "w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
          </div>

          <div class="flex items-end">
            <%= submit_tag "Assign to group",
                           class: tailwind_button_classes(:primary),
                           data: { turbo_confirm: "Assign â€œ#{@survey.title}â€ to the selected group?",
                                   confirm:       "Assign â€œ#{@survey.title}â€ to the selected group?" } %>
          </div>
        <% end %>
      </div>
    </section>

    <% if @students.present? %>
      <div class="c-card c-card--flush">
        <%= render TableComponent.new(
          headers: ["Student", "Email", "Track", "Class Year", "Status", "Closes", "Action"],
          right_align: [6]
        ) do %>
          <% @students.each do |student| %>
            <% assignment = @assignments_by_student_id&.[](student.student_id) %>
            <% assigned = assignment.present? %>
            <% completed = assignment&.completed_at? %>
            <% status_text = completed ? "Completed" : (assigned ? "Assigned" : "Unassigned") %>
            <% due_label = assignment&.available_until.present? ? format_calendar_date(assignment.available_until) : "â€”" %>

            <tr class="transition hover:bg-slate-50">
              <td class="px-4 py-3 text-sm text-slate-700">
                <div class="font-semibold text-slate-900"><%= student.full_name.presence || student.email %></div>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700"><%= student.email %></td>

              <td class="px-4 py-3 text-sm text-slate-700">
                <%= student.track.present? ? student.track.titleize : "â€”" %>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700">
                <%= student.program_year.presence || "â€”" %>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700">
                <span class="<%= survey_status_badge_classes(status_text) %>"><%= status_text %></span>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700"><%= due_label %></td>

              <td class="px-4 py-3 text-sm">
                <% if completed %>
                  <span title="Completed surveys canâ€™t be unassigned.">
                    <button class="<%= tailwind_button_classes(:secondary) %>" disabled>Completed</button>
                  </span>
                <% elsif assigned %>
                  <%= button_to "Unassign",
                                unassign_assignments_survey_path(@survey, student_id: student.student_id),
                                method: :delete,
                                data: { turbo_confirm: "Are you sure you want to unassign â€œ#{@survey.title}â€ from #{student.full_name.presence || student.email}?",
                                        confirm:       "Are you sure you want to unassign â€œ#{@survey.title}â€ from #{student.full_name.presence || student.email}?" },
                                class: tailwind_button_classes(:secondary) %>
                <% else %>
                  <%= button_to "Assign",
                                assign_assignments_survey_path(@survey, student_id: student.student_id),
                                method: :post,
                                class: tailwind_button_classes(:primary),
                                data: { turbo_confirm: "Assign â€œ#{@survey.title}â€ to #{student.full_name.presence || student.email}?",
                                        confirm:       "Assign â€œ#{@survey.title}â€ to #{student.full_name.presence || student.email}?" } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="c-card c-tile" style="max-width: 560px; margin: 0 auto;">
        <div class="c-tile__icon" aria-hidden="true">ðŸ“­</div>
        <div class="c-tile__title">No students available</div>
        <div class="c-tile__description">Students assigned to you will appear here for survey assignment.</div>
      </div>
    <% end %>



  </section>
</main>
