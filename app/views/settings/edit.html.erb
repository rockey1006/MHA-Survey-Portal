<% content_for :title, "Settings" %>

<% lang_code = (@user&.language.presence || 'en') %>
<% lang_labels = {
  'en' => 'English', 'es' => 'Spanish', 'fr' => 'Français', 'de' => 'Deutsch',
  'zh-CN' => '中文 (简体)', 'zh-TW' => '中文 (繁體)', 'ja' => '日本語',
  'ko' => '한국어', 'pt' => 'Português', 'ru' => 'Русский'
} %>
<% current_language_label = lang_labels[lang_code] || lang_code %>
<% text_scale = @user.text_scale_percent || 100 %>
<% back_path = if current_user&.role_admin?
                 admin_dashboard_path
               elsif current_user&.role_advisor?
                 advisor_dashboard_path
               elsif current_user&.role_student?
                 student_dashboard_path
               else
                 root_path
               end %>

<main class="settings-page px-4 py-12">
  <div class="settings-container mx-auto max-w-6xl space-y-10">
    <section class="settings-hero">
      <div>
        <p class="settings-hero__eyebrow">Experience controls</p>
        <h1 class="settings-hero__title">Personalize your workspace</h1>
        <p class="settings-hero__subtitle">Language and text settings sync everywhere you sign in, so dashboards, surveys, and reports stay readable.</p>
        <div class="settings-hero__badges">
          <span class="hero-badge">
            <span class="hero-badge__dot"></span>
            Language · <span id="current-language-display"><%= current_language_label %></span>
          </span>
          <span class="hero-badge">
            Text scale · <%= text_scale %>%
          </span>
        </div>
      </div>
      <div class="settings-hero__card">
        <p class="eyebrow">Need to revert?</p>
        <h2>Changes apply instantly</h2>
        <p>We refresh the app after saving so your accessibility preferences update without hunting for toggles again.</p>
        <p class="card-hint">Prefer the default view? Set text size back to 100%.</p>
      </div>
    </section>

    <div class="settings-grid">
      <section class="settings-card">
        <header>
          <p class="eyebrow">Account-wide</p>
          <h2>Accessibility preferences</h2>
          <p>These settings change typography scales and translation helpers across reports, dashboards, and emails.</p>
        </header>

        <%= form_with model: @user, url: settings_path, method: :patch, local: true, id: "settings-form", class: "settings-form" do |f| %>
          <% if @user.errors.any? %>
            <div class="settings-alert">
              <h3><%= pluralize(@user.errors.count, "error") %> need attention</h3>
              <ul>
                <% @user.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="form-grid">
            <div class="form-field">
              <label>Language</label>
              <div class="language-pill">
                <span id="language-pill-label"><%= current_language_label %></span>
                <span class="pill-hint">Managed automatically via translation bar</span>
              </div>
              <%= f.hidden_field :language, value: lang_code, id: 'settings_language_input' %>
            </div>

            <div class="form-field">
              <label>Text size</label>
              <%= f.select :text_scale_percent,
                    options_for_select([["100% (default)", 100], ["125%", 125], ["150%", 150], ["175%", 175], ["200%", 200]], text_scale),
                    {},
                    class: "settings-select" %>
              <small>Increase up to 200% for larger copy. We scale line-height and key controls automatically.</small>
            </div>
          </div>

          <div class="c-form-actions u-actions">
            <%= link_to "← Back", back_path, class: tailwind_button_classes(:secondary) %>
            <%= f.submit "Save changes", class: tailwind_button_classes(:primary) %>
          </div>
        <% end %>
      </section>

      <aside class="settings-card settings-card--support">
        <header>
          <p class="eyebrow">Helpful context</p>
          <h2>Why these settings live here</h2>
        </header>
        <ul class="support-list">
          <li>Language preference follows your Google Translate selection so dashboards are instantly readable.</li>
          <li>Text scale applies to reports, surveys, and exports — no extra zooming required.</li>
        </ul>
        <p class="support-tip">Future releases will add notification controls based on these preferences.</p>
      </aside>
    </div>
  </div>
</main>
<script>
  // Submit settings via fetch to ensure we can reload the app immediately on success.
  (function() {
    var form = document.getElementById('settings-form');
    if (!form) return;

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var submit = form.querySelector('[type=submit]');
      if (submit) submit.disabled = true;

      var token = document.querySelector('meta[name=csrf-token]') && document.querySelector('meta[name=csrf-token]').getAttribute('content');
      var fd = new FormData(form);

      fetch(form.action, {
        method: 'POST', // form_with uses POST with _method=patch
        body: fd,
        credentials: 'same-origin',
        headers: token ? { 'X-CSRF-Token': token } : {}
      }).then(function(resp) {
        if (resp.redirected) {
          window.location.href = resp.url;
          return;
        }
        if (resp.ok) {
          // Successful update - refresh the page so the new settings (and root font-size) apply app-wide
          window.location.reload();
          return;
        }
        // On error, replace the form container with server response (this will show validation errors)
        return resp.text().then(function(html) {
          try {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var newForm = doc.getElementById('settings-form');
            if (newForm) {
              form.replaceWith(newForm);
            } else {
              // fallback: reload so user can see server-rendered errors
              window.location.reload();
            }
          } catch (err) {
            window.location.reload();
          }
        });
      }).catch(function() {
        // network failure - re-enable submit and show a simple alert
        if (submit) submit.disabled = false;
        alert('Failed to save settings. Please try again.');
      });
    });
  })();
</script>
<script>
  // Update the visible language display from Google Translate cookie if present.
  (function() {
    function readCookie(name) {
      var m = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]+)'));
      return m ? decodeURIComponent(m[2]) : null;
    }

    var display = document.getElementById('current-language-display');
    var hiddenInput = document.getElementById('settings_language_input');
    if (!display || !hiddenInput) return;

    // Map common language codes to labels
    var labels = {
      'en': 'English', 'es': 'Spanish', 'fr': 'Français', 'de': 'Deutsch',
      'zh-CN': '中文 (简体)', 'zh-TW': '中文 (繁體)', 'ja': '日本語', 'ko': '한국어',
      'pt': 'Português', 'ru': 'Русский'
    };

    try {
      var g = readCookie('googtrans');
      if (g && g !== '/auto/en') {
        var code = g.split('/').pop();
        // Google sometimes uses short codes like 'zh-CN' or 'zh_TW' with underscore
        code = code.replace('_', '-');
        display.textContent = labels[code] || code;
        hiddenInput.value = code;
      } else {
        // No active translation cookie; ensure display matches saved user language
        var saved = hiddenInput.value || 'en';
        display.textContent = labels[saved] || saved;
      }
    } catch (e) {
      // ignore
    }
  })();
</script>
