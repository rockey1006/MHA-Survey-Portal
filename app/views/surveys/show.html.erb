<% survey_title = @survey.title.presence || "Survey ##{@survey.id}" %>

<div class="survey-container survey-show mx-auto w-full space-y-8 px-4 sm:px-6 lg:px-4" style="max-width: 90rem;">
  <style>
    .survey-container [id^="survey-section-"],
    .survey-container [id^="survey-category-"],
    .survey-container .question-block {
      scroll-margin-top: 120px;
    }
    .survey-container .indented-description {
      border-left: 2px solid #e2e8f0;
      margin-left: 0.25rem;
      padding-left: 1rem;
    }
  </style>

  <div class="survey-grid grid grid-cols-1 gap-8 lg:grid-cols-2 lg:items-start lg:gap-10">
    <div class="space-y-8 lg:min-w-0">
  <header class="c-card survey-header mb-8">
    <div class="space-y-2">
      <h1 class="text-2xl font-semibold tracking-tight text-slate-900"><%= @survey.title %></h1>
      <p class="text-sm text-slate-600">
        Semester: <%= @survey.semester.presence || "TBD" %> · Tracks: <%= @survey.track_list.presence&.join(", ") || "Unassigned" %> · <%= survey_due_note(@survey_assignment&.due_date) %>
      </p>
      <p class="text-xs text-slate-500">
        Questions marked with an asterisk (*) are required.
      </p>
    </div>
  </header>

  <% flash_alert_present = flash[:alert].present? || flash.now[:alert].present? %>
  <% if @invalid_evidence.present? && !flash_alert_present %>
    <div class="rounded-md border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700">
      <p class="font-medium">Please fix the highlighted items:</p>
      <ul class="mt-1 list-disc pl-5">
        <li>One or more evidence links require Google sharing set to "Anyone with the link can view."</li>
      </ul>
    </div>
  <% end %>

  <%= form_with url: submit_survey_path(@survey), method: :post, local: true, data: { turbo: false }, class: "space-y-8 survey-form" do |form| %>
    <% rendered_section_ids = [] %>
    <% section_question_numbers = Hash.new(0) %>
    <% invalid_evidence_ids = Array(@invalid_evidence).map(&:to_s) %>
    <% @category_groups.each do |category| %>
      <% section = category.section %>
      <% section_anchor_id = section.present? ? "survey-section-#{section.id}" : nil %>
      <div class="survey-block">
        <% if section.present? && !rendered_section_ids.include?(section.id) %>
          <div id="<%= section_anchor_id %>" class="c-card survey-section-card space-y-2 text-left border-amber-200 bg-amber-50/60">
            <p class="text-xs font-semibold uppercase tracking-wide text-amber-700">Section</p>
            <h2 class="survey-section-title text-xl font-bold"><%= section.title %></h2>
            <% if section.description.present? %>
              <p class="text-sm text-slate-700"><%= section.description %></p>
            <% end %>
          </div>
          <% rendered_section_ids << section.id %>
        <% end %>

        <section id="survey-category-<%= category.id %>" class="c-card survey-category-card space-y-6">
        <header class="space-y-2">
          <h2 class="text-xl font-semibold tracking-tight text-slate-900"><%= category.name %></h2>
          <% category_desc = category.description.to_s.strip.presence %>
          <% if category_desc.present? %>
            <p class="indented-description text-sm text-slate-600"><%= category_desc.gsub(/\r?\n/, '<br>').html_safe %></p>
          <% end %>
        </header>

        <div class="space-y-5">
          <% number_key = section&.id || category.id %>
          <% ordered_questions = category.questions.ordered.to_a %>
          <% branch_parent_ids = ordered_questions.select(&:sub_question?).map(&:parent_question_id).compact.uniq %>
          <% ordered_questions.each do |question| %>
            <% is_sub_question = question.sub_question? %>
            <% question_number = section_question_numbers[number_key] %>
            <% question_number = (section_question_numbers[number_key] += 1) unless is_sub_question %>
            <% field_name = "answers[#{question.id}]" %>
            <% current_value = @existing_answers[question.id.to_s] %>
            <% required = @computed_required[question.id] %>
            <% evidence_value = if question.question_type == "evidence"
                                  current_value.is_a?(Hash) ? current_value["link"] : current_value
                                else
                                  nil
                                end %>
            <% missing_required_error = false %>
            <% if request.post? && required %>
              <% if question.question_type == "evidence" %>
                <% missing_required_error = evidence_value.to_s.strip.blank? %>
              <% else %>
                <% missing_required_error = current_value.to_s.strip.blank? %>
              <% end %>
            <% end %>
            <% invalid_evidence_error = question.question_type == "evidence" && invalid_evidence_ids.include?(question.id.to_s) %>
            <% has_error = missing_required_error || invalid_evidence_error %>
            <% article_classes = ["question-block", "rounded-lg", "border", "border-slate-100", "bg-slate-50/40", "p-4", "space-y-4"] %>
            <% article_classes << "ml-6" if question.sub_question? %>
            <% article_classes << "ring-2 ring-rose-300 border-rose-200 bg-rose-50/70" if has_error %>

            <% is_branch_parent = !is_sub_question && question.question_type == "multiple_choice" && branch_parent_ids.include?(question.id) %>
            <% if is_branch_parent %>
              <% option_values = question.answer_options_list.map { |opt| opt.to_s.strip.downcase } %>
              <% is_branch_parent = option_values.include?("yes") && option_values.include?("no") %>
            <% end %>
            <% branch_target_value = is_branch_parent ? "Yes" : nil %>
            <% branch_child_of = is_sub_question ? question.parent_question_id : nil %>

            <article id="question-block-<%= question.id %>"
                     class="<%= article_classes.join(' ') %>"
                     data-question-id="<%= question.id %>"
                     <% if is_branch_parent %>
                       data-branch-parent="true"
                       data-branch-parent-id="<%= question.id %>"
                       data-branch-target-value="<%= branch_target_value %>"
                     <% end %>
                     <% if branch_child_of.present? %>
                       data-branch-child-of="<%= branch_child_of %>"
                     <% end %>>
            <% q_text = question.question_text.to_s.squish %>
            <% desc_text = question.description.to_s.strip.presence %>
            <% tooltip_text = question.tooltip_text.to_s.strip.presence %>
            <% show_mha_tooltip = %w[multiple_choice dropdown].include?(question.question_type) && section&.mha_competency? %>
            <% show_custom_tooltip = tooltip_text.present? && !show_mha_tooltip %>
            <% formatted_desc = desc_text.present? ? desc_text.gsub(/\r?\n/, '<br>').html_safe : nil %>

            <label class="flex w-full items-start justify-between gap-3 text-sm font-medium text-slate-900" for="question-<%= question.id %>">
              <% question_prefix = section&.mha_competency? ? "#" : "Q" %>
              <span class="flex min-w-0 items-start gap-2">
                <% if is_sub_question %>
                  <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-slate-100 text-xs font-semibold text-slate-600" aria-label="Sub-question">↳</span>
                <% else %>
                  <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-slate-200/70 text-xs font-semibold text-slate-700"><%= question_prefix %><%= question_number %></span>
                <% end %>
                <span class="min-w-0 flex flex-col gap-1">
                  <span class="flex min-w-0 flex-wrap items-center gap-2">
                    <span class="leading-snug"><%= q_text %></span>
                    <% if show_mha_tooltip %>
                      <% if tooltip_text.present? %>
                        <span class="inline-flex"><%= render 'shared/question_tooltip', text: tooltip_text, label: "Show proficiency guidance" %></span>
                      <% else %>
                        <span class="inline-flex"><%= render 'shared/proficiency_tooltip' %></span>
                      <% end %>
                    <% elsif show_custom_tooltip %>
                      <span class="inline-flex"><%= render 'shared/question_tooltip', text: tooltip_text %></span>
                    <% end %>
                    <% if required %>
                      <span class="text-red-600" aria-hidden="true">*</span>
                    <% end %>
                  </span>
                  <% if formatted_desc.present? %>
                    <div class="indented-description text-xs leading-relaxed text-slate-600"><%= formatted_desc %></div>
                  <% end %>
                </span>
              </span>

              <% effective_target_level = effective_competency_target_level(question: question, survey: @survey, student: current_student) %>
              <% if question.question_type_dropdown? && effective_target_level.present? %>
                <span class="shrink-0 ml-auto text-right">
                  <span class="target-level-badge">Target Level: <%= effective_target_level %>/5</span>
                </span>
              <% end %>
            </label>

            <% case question.question_type %>
            <% when "short_answer" %>
              <%= text_area_tag field_name, current_value, rows: 3, id: "question-#{question.id}", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              
            <% when "multiple_choice" %>
              <% option_pairs = question.answer_option_pairs.presence || [] %>
              <div class="flex flex-col gap-2" role="radiogroup">
                <% option_pairs.each do |label, value| %>
                  <label class="flex items-center gap-2 text-sm text-slate-800">
                    <%= radio_button_tag field_name,
                                         value,
                                         (current_value.is_a?(Hash) ? current_value["answer"].to_s : current_value.to_s) == value.to_s,
                                         id: "question-#{question.id}-#{label.parameterize}",
                                         class: "h-4 w-4 text-blue-600" %>
                    <span><%= label %></span>
                  </label>

                  <% requires_text = question.answer_option_requires_text?(value) %>
                  <% if requires_text %>
                    <% other_value = (@other_answers || {})[question.id.to_s] %>
                    <% selected_value = (current_value.is_a?(Hash) ? current_value["answer"].to_s : current_value.to_s) %>
                    <% show_other = selected_value.to_s == value.to_s %>
                    <div class="ml-6 <%= show_other ? "" : "hidden" %>" data-other-input-wrapper data-other-for-question-id="<%= question.id %>" data-other-choice-value="<%= value %>" aria-hidden="<%= show_other ? "false" : "true" %>">
                      <%= text_field_tag "other_answers[#{question.id}]",
                                         other_value,
                                         id: "question-#{question.id}-other-#{value.to_s.parameterize}",
                                         placeholder: "Please describe...",
                                         class: "w-full max-w-xl rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500",
                                         disabled: !show_other %>
                    </div>
                  <% end %>
                <% end %>
              </div>

            <% when "dropdown" %>
              <% option_pairs = question.answer_option_pairs %>
              <%= select_tag field_name,
                             options_for_select(option_pairs.map { |label, value| [label, value] }, current_value.to_s),
                             include_blank: true,
                             id: "question-#{question.id}",
                             class: "w-full max-w-sm rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>

              <% option_pairs.each do |_label, value| %>
                <% next unless question.answer_option_requires_text?(value) %>
                <% other_value = (@other_answers || {})[question.id.to_s] %>
                <% selected_value = current_value.to_s %>
                <% show_other = selected_value.to_s == value.to_s %>
                <div class="mt-2 max-w-xl <%= show_other ? "" : "hidden" %>" data-other-input-wrapper data-other-for-question-id="<%= question.id %>" data-other-choice-value="<%= value %>" aria-hidden="<%= show_other ? "false" : "true" %>">
                  <%= text_field_tag "other_answers[#{question.id}]",
                                     other_value,
                                     id: "question-#{question.id}-other-#{value.to_s.parameterize}",
                                     placeholder: "Please describe...",
                                     class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500",
                                     disabled: !show_other %>
                </div>
              <% end %>
              
            <% when "scale" %>
              <% scale_labels = scale_labels_for(question) %>
              <% scale_steps = [scale_labels.size, 1].max %>
              <% slider_value = (current_value.presence || ((scale_steps + 1) / 2.0).ceil).to_i.clamp(1, scale_steps) %>
              <div class="survey-scale-input space-y-1" data-scale-input data-scale-labels="<%= scale_labels.to_json %>">
                <div class="flex items-center gap-3">
                  <span class="text-xs text-slate-500"><%= scale_labels.first || "Low" %></span>
                  <%= range_field_tag field_name,
                                      slider_value,
                                      min: 1,
                                      max: scale_steps,
                                      step: 1,
                                      id: "question-#{question.id}",
                                      class: "w-full",
                                      data: { scale_slider: true } %>
                  <span class="text-xs text-slate-500"><%= scale_labels.last || "High" %></span>
                </div>
                <div class="flex justify-between text-[0.7rem] text-slate-500">
                  <% scale_labels.each do |label| %>
                    <span><%= label %></span>
                  <% end %>
                </div>
                <div class="text-xs text-slate-600">
                  Selected: <span data-scale-value><%= scale_label_for_value(question, slider_value) %></span>
                </div>
              </div>
              
            <% when "evidence" %>
              <%= text_field_tag field_name, evidence_value, id: "question-#{question.id}", placeholder: "https://drive.google.com/...", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              <% if invalid_evidence_error %>
                <div class="text-xs text-red-600 mt-1">Link is invalid or not publicly accessible</div>
              <% elsif missing_required_error %>
                <div class="text-xs text-red-600 mt-1">This question is required</div>
              <% end %>
              
            <% else %>
              <%= text_field_tag field_name, current_value, id: "question-#{question.id}", class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" %>
              
            <% end %>

            <% if missing_required_error && question.question_type != "evidence" %>
              <div class="text-xs text-red-600 mt-1">This question is required</div>
            <% end %>

            </article>
          <% end %>
        </div>
        </section>
      </div>
    <% end %>

    <% cancel_path = @return_to.presence || student_dashboard_path %>

    <% allow_save_progress = !(@survey_assignment&.completed_at?) %>
    <div class="c-toolbar mt-8">
      <div class="c-toolbar__row justify-between w-full">
        <div class="flex items-center gap-2">
          <%= link_to "Cancel", cancel_path, class: tailwind_button_classes(:secondary) %>
          <% if allow_save_progress %>
            <%= button_tag "Save Progress", type: "button", class: tailwind_button_classes(:secondary), onclick: "saveSurveyProgress()" %>
          <% end %>
        </div>
        <%= form.submit "Submit Survey", class: tailwind_button_classes(:primary) %>
      </div>
    </div>
  <% end %>

  <% if request.post? && (@first_error_question_id.present? || @scroll_to_form_top) %>
    <script>
      (function() {
        var scrolled = false;
        function runScroll() {
          if (scrolled) return;
          scrolled = true;
          <% if @scroll_to_form_top %>
            window.scrollTo({ top: 0, behavior: "smooth" });
          <% end %>
          <% if @first_error_question_id.present? %>
            var field = document.getElementById("question-<%= @first_error_question_id %>");
            var block = document.getElementById("question-block-<%= @first_error_question_id %>");
            if (!block) {
              block = document.querySelector('[data-question-id="<%= @first_error_question_id %>"]');
            }
            var sectionTargetId = "<%= j(@first_error_section_dom_id.to_s) %>";
            var sectionBlock = sectionTargetId ? document.getElementById(sectionTargetId) : null;
            var target = block || field || sectionBlock;
            if (target && target.scrollIntoView) {
              var blockOption = (target === sectionBlock) ? "start" : "center";
              var performScroll = function() {
                target.scrollIntoView({ behavior: "smooth", block: blockOption });
              };
              if (window.requestAnimationFrame) {
                window.requestAnimationFrame(performScroll);
              } else {
                setTimeout(performScroll, 0);
              }
            }
            if (field && typeof field.focus === "function") {
              try { field.focus({ preventScroll: true }); } catch (err) {}
            } else if (block && typeof block.focus === "function") {
              if (!block.hasAttribute('tabindex')) { block.setAttribute('tabindex', '-1'); }
              try { block.focus({ preventScroll: true }); } catch (err) {}
            }
          <% end %>
        }
        if (document.readyState === "complete" || document.readyState === "interactive") {
          runScroll();
        } else {
          document.addEventListener("DOMContentLoaded", runScroll, { once: true });
        }
        document.addEventListener("turbo:load", runScroll, { once: true });
      })();
    </script>
  <% end %>

  <script>
    (function() {
      function initScaleInputs(root) {
        var wrappers = (root || document).querySelectorAll('[data-scale-input]');
        if (!wrappers.length) return;

        wrappers.forEach(function(wrapper) {
          if (wrapper.dataset.scaleInitialized) return;
          wrapper.dataset.scaleInitialized = "true";
          var input = wrapper.querySelector('input[type="range"]');
          var valueTarget = wrapper.querySelector('[data-scale-value]');
          if (!input || !valueTarget) return;

          var labels = [];
          try {
            labels = JSON.parse(wrapper.dataset.scaleLabels || "[]");
          } catch (error) {
            labels = [];
          }

          var updateValue = function() {
            var idx = parseInt(input.value || "0", 10) - 1;
            var label = labels[idx];
            valueTarget.textContent = label || input.value || "";
          };

          input.addEventListener('input', updateValue);
          input.addEventListener('change', updateValue);
          updateValue();
        });
      }

      if (window.Turbo) {
        document.addEventListener('turbo:load', function() { initScaleInputs(document); });
      }
      document.addEventListener('DOMContentLoaded', function() { initScaleInputs(document); });
    })();
  </script>

  <script>
    function saveSurveyProgress() {
      const form = document.querySelector('.survey-form');
      const originalAction = form.action;
      
      // Change to save_progress endpoint
      form.action = '<%= save_progress_survey_path(@survey) %>';
      
      // Submit the form
      form.submit();
    }
  </script>

    </div>

    <%= render ::SurveyLegendComponent.new(legend: @survey.legend) %>
  </div>
</div>