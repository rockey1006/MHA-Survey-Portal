<main class="main-content">
    <div class="c-toolbar c-toolbar--spaced">
        <div class="c-toolbar__row">
            <% if current_user&.respond_to?(:role_admin?) && current_user.role_admin? %>
                <%= link_to "â† Back", admin_dashboard_path, class: tailwind_button_classes(:secondary), data: { turbo: false } %>
            <% else %>
                <%= link_to "â† Back", advisor_dashboard_path, class: tailwind_button_classes(:secondary), data: { turbo: false } %>
            <% end %>
        </div>
    </div>


  <section class="c-card dashboard-section u-stack u-stack--xl">
    <div class="section-header">
      <h1 class="section-title">Available Surveys</h1>
      <p class="section-subtitle">
        Quickly review the surveys you can assign to students. Current semester: <strong><%= ProgramSemester.current_name || "Not set" %></strong>
      </p>
    </div>

    <% if @surveys.present? %>
      <div class="c-stats-grid">
        <div class="c-stat c-stat--muted">
          <div class="c-stat__label">Total surveys</div>
          <div class="c-stat__value c-stat__value--md"><%= @surveys.size %></div>
        </div>

        <div class="c-stat c-stat--muted">
          <div class="c-stat__label">Tracks covered</div>
          <div class="c-stat__value c-stat__value--md"><%= @surveys.flat_map(&:track_list).uniq.sort.presence&.size || 0 %></div>
          <div class="c-stat__subtext"><%= @surveys.flat_map(&:track_list).uniq.sort.presence&.join(", ") || "â€”" %></div>
        </div>

        <div class="c-stat c-stat--muted">
          <div class="c-stat__label">Last updated</div>
          <div class="c-stat__value c-stat__value--md">â€”</div>
          <div class="c-stat__subtext"><%= l(@surveys.max_by(&:updated_at).updated_at, format: :long) rescue "Unknown" %></div>
        </div>
      </div>

      <div class="c-card c-card--flush">
        <%= render TableComponent.new(
          headers: ["Survey", "Semester", "Status", "Questions", "Categories", "Tracks", "Updated", ""],
          right_align: [7]
        ) do %>
          <% @surveys.each do |survey| %>
            <% track_labels = survey.track_list %>
            <% cleaned_title = survey.title.to_s.sub(/^survey\s*#?:\s*/i, '').gsub('#', '').squish %>
            <% display_title = cleaned_title.presence || survey.title %>

            <tr class="transition hover:bg-slate-50">
              <td class="px-4 py-3 text-sm text-slate-700">
                <div class="font-semibold text-slate-900"><%= display_title %></div>
                <% if survey.try(:description).present? %>
                  <div class="mt-1 text-xs text-slate-500"><%= survey.description %></div>
                <% end %>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700"><%= survey.semester.presence || "â€”" %></td>

              <td class="px-4 py-3 text-sm text-slate-700">
                <% if survey.is_active? %>
                  <span class="c-pill"><span class="c-pill__dot c-pill__dot--brand" aria-hidden="true"></span>Active</span>
                <% else %>
                  <span class="c-pill"><span class="c-pill__dot" aria-hidden="true"></span>Archived</span>
                <% end %>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700"><%= survey.questions.size %></td>
              <td class="px-4 py-3 text-sm text-slate-700"><%= survey.categories.size %></td>

              <td class="px-4 py-3 text-sm text-slate-700">
                <% if track_labels.present? %>
                  <div class="u-actions u-actions--start">
                    <% track_labels.each do |track| %>
                      <span class="c-pill"><%= track %></span>
                    <% end %>
                  </div>
                <% else %>
                  â€”
                <% end %>
              </td>

              <td class="px-4 py-3 text-sm text-slate-700"><%= l(survey.updated_at, format: :short) rescue "â€”" %></td>

              <td class="px-4 py-3 text-sm">
                <%= link_to "Assign to Students", assignments_survey_path(survey), class: tailwind_button_classes(:secondary), data: { turbo: false } %>
              </td>
            </tr>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="c-card c-tile" style="max-width: 560px; margin: 0 auto;">
        <div class="c-tile__icon" aria-hidden="true">ðŸ“­</div>
        <div class="c-tile__title">No surveys available</div>
        <div class="c-tile__description">Create a survey first to begin assigning it to students.</div>
      </div>
    <% end %>

  </section>
</main>
