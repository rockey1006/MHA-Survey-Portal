<% category = category_fields.object %>
<% section_options = local_assigns[:section_options] || [["No section", ""]] %>
<% selected_section_key = category.section_form_uid.presence %>
<% if selected_section_key.blank? && category.respond_to?(:survey_section_id) && category.survey_section_id.present? %>
  <% selected_section_key = "section-#{category.survey_section_id}" %>
  <% category.section_form_uid = selected_section_key if category.respond_to?(:section_form_uid=) %>
<% end %>
<article class="space-y-5 rounded-xl border border-slate-200 bg-white p-5 shadow-sm"
         data-category-fields-target="item">
  <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
    <div class="flex-1 space-y-2">
      <%= category_fields.hidden_field :id %>
      <%= category_fields.label :name, "Category name", class: "block text-sm font-medium text-slate-700" %>
      <%= category_fields.text_field :name,
                                     required: true,
                                     class: input_classes,
                                     placeholder: "Leadership" %>

      <div class="space-y-2">
        <%= category_fields.label :section_form_uid, "Section assignment", class: "block text-sm font-medium text-slate-700" %>
        <%= category_fields.select :section_form_uid,
                                   options_for_select(section_options, selected_section_key),
                                   { include_blank: false },
                                   class: input_classes,
                                   data: { category_fields_target: "sectionSelect" } %>
        <p class="text-xs text-slate-500">Choose the section this category belongs to or select "No section".</p>
      </div>
    </div>

    <% if category.persisted? %>
      <label class="flex items-center gap-2 text-sm font-medium text-rose-600">
        <%= category_fields.check_box :_destroy, class: checkbox_classes %>
        <span>Remove category</span>
      </label>
    <% else %>
      <button type="button"
              class="text-sm font-medium text-rose-600"
              data-action="category-fields#remove">
        Remove category
      </button>
    <% end %>
  </div>

  <div class="space-y-5">
    <div class="space-y-2">
      <%= category_fields.label :description, "Description", class: "block text-sm font-medium text-slate-700" %>
      <%= category_fields.text_area :description, class: textarea_classes, placeholder: "Optional context shown to advisors and students." %>
    </div>

    <div class="space-y-4" data-controller="question-fields">
      <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-600">Questions</h3>
      <div class="space-y-4" data-question-fields-target="container">
        <%= category_fields.fields_for :questions do |question_fields| %>
          <%= render "admin/surveys/question_fields",
                     question_fields: question_fields,
                     input_classes: input_classes,
                     textarea_classes: textarea_classes,
                     checkbox_classes: checkbox_classes %>
        <% end %>
      </div>

      <% new_question = category.questions.build(question_text: "", question_order: (category.questions.maximum(:question_order) || 0) + 1) %>
      <% template = capture do %>
        <%= category_fields.fields_for(:questions, new_question, child_index: "NEW_QUESTION") do |question_fields| %>
          <%= render "admin/surveys/question_fields",
                     question_fields: question_fields,
                     input_classes: input_classes,
                     textarea_classes: textarea_classes,
                     checkbox_classes: checkbox_classes %>
        <% end %>
      <% end %>
      <% category.questions.target.delete(new_question) %>

      <template data-question-fields-target="template"><%= template %></template>

      <button type="button"
              class="rounded-lg border border-dashed border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:border-slate-400"
              data-action="question-fields#add">
        + Add another question
      </button>
    </div>
  </div>
</article>
