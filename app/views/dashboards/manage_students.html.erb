<!-- Student Advisor Management view -->
<main class="main-content main-content--dashboard">
    <div class="c-toolbar">
        <div class="c-toolbar__row items-center w-full gap-3">
            <div class="shrink-0">
                <%= link_to "â† Back", admin_dashboard_path, class: "btn btn-secondary", data: { turbo: false } %>
            </div>
            <div class="flex-1">
                <form class="flex w-full items-center gap-2" action="<%= manage_students_path %>" accept-charset="UTF-8" method="get">
                    <label class="sr-only" for="q">Search</label>
                    <input type="text" name="q" id="q" value="<%= params[:q].to_s %>" placeholder="Search by name, email, UID, or student ID" class="flex-1 min-w-0 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <button name="button" type="submit" class="btn btn-secondary">Search</button>
                </form>
            </div>
        </div>
    </div>

    <section class="c-card dashboard-section">
        <div class="section-header">
            <div class="flex items-baseline justify-between gap-4">
                <h1 class="section-title">ðŸŽ“ Student Advisor Management</h1>
                <div class="text-sm text-slate-500">
                    <%= pluralize(@students.size, "student") %>
                </div>
            </div>
            <p class="section-subtitle">Review advisees and assign advisors across the program.</p>
        </div>

        <div class="c-stats-grid grid grid-cols-1 sm:grid-cols-3 gap-4 my-6 items-stretch">
            <div class="c-stat c-stat--info bg-gradient-to-br from-blue-100 to-blue-50 rounded-xl shadow p-5 flex flex-col !items-center !justify-center !text-center w-full h-full">
                <div class="c-stat__icon mb-2 text-3xl">ðŸ‘¥</div>
                <div class="c-stat__label text-base font-semibold text-blue-800">Total Students</div>
                <div class="c-stat__value c-stat__value--md text-4xl font-bold text-blue-900 mt-1"><%= @assignment_stats[:total] %></div>
            </div>

            <div class="c-stat c-stat--success bg-gradient-to-br from-green-100 to-green-50 rounded-xl shadow p-5 flex flex-col !items-center !justify-center !text-center w-full h-full">
                <div class="c-stat__icon mb-2 text-3xl">âœ…</div>
                <div class="c-stat__label text-base font-semibold text-green-800">Assigned</div>
                <div class="c-stat__value c-stat__value--md text-4xl font-bold text-green-900 mt-1"><%= @assignment_stats[:assigned] %></div>
            </div>

            <div class="c-stat c-stat--warning bg-gradient-to-br from-yellow-100 to-yellow-50 rounded-xl shadow p-5 flex flex-col !items-center !justify-center !text-center w-full h-full">
                <div class="c-stat__icon mb-2 text-3xl">ðŸ“‹</div>
                <div class="c-stat__label text-base font-semibold text-yellow-800">Unassigned</div>
                <div class="c-stat__value c-stat__value--md text-4xl font-bold text-yellow-900 mt-1"><%= @assignment_stats[:unassigned] %></div>
            </div>
        </div>

            <% if @students.blank? %>
                <div class="flex flex-col items-center justify-center gap-3 rounded-2xl border border-dashed border-slate-300 bg-white p-10 text-center shadow-sm">
                    <span class="text-4xl" aria-hidden="true">ðŸ“­</span>
                    <p class="text-sm text-slate-600">No students were found for your account.</p>
                </div>
        <% elsif @can_manage %>
            <%= form_with url: update_student_advisors_path, method: :patch, local: true, id: "advisor-management-form", data: { turbo: false }, remote: false do |form| %>
                <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                <% track_select_options = [["Select track", ""]] + @track_select_options %>

                <div class="c-card c-card--flush c-table-wrapper">
                    <table class="c-table">
                        <thead>
                            <tr>
                                <th class="table-header-avatar">Avatar</th>
                                <th class="table-header-name" style="min-width: 15rem;">Student</th>
                                                                <th class="table-header-track" style="min-width: 14rem;">
                                                                    Track
                                                                    <div class="text-xs text-slate-500 font-normal">
                                                                        Click a track tag to change.                                                                        
                                                                    </div>
                                                                </th>
                                                                <th class="table-header-track" style="min-width: 14rem;">
                                                                    Assignment Group
                                                                    <div class="text-xs text-slate-500 font-normal">
                                                                        Click a group tag to change.
                                                                    </div>
                                                                </th>
                                                                <th class="table-header-current-role" style="min-width: 16rem;">
                                                                    Advisor
                                                                    <div class="text-xs text-slate-500 font-normal">
                                                                        Click an advisor tag to change.
                                                                    </div>
                                                                </th>
                                <th class="table-header-actions" style="min-width: 12rem;">Changes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% @students.each do |student| %>
                                <% user = student.user %>
                                <% current_advisor = student.advisor %>
                                <% current_advisor_name = current_advisor&.display_name || "Unassigned" %>
                                <% current_advisor_id = student.advisor_id.present? ? student.advisor_id.to_s : "" %>
                                <% track_key = student.track.presence || "" %>
                                <% track_label = track_key.present? ? track_key.titleize : "Unassigned" %>
                                <% assignment_group_value = student.respond_to?(:assignment_group) ? student.assignment_group.to_s.strip : "" %>
                                <% assignment_group_value = assignment_group_value.presence || "" %>
                                <% assignment_group_label = assignment_group_value.present? ? assignment_group_value : "Unassigned" %>

                                <tr class="c-table-row" data-student-row="<%= student.student_id %>">
                                    <td class="user-avatar-cell">
                                        <div class="c-table-avatar"
                                                 <% if user&.avatar_url.present? %>
                                                     style="background-image: url('<%= user.avatar_url %>');"
                                                 <% end %>>
                                            <% unless user&.avatar_url.present? %>ðŸ‘¤<% end %>
                                        </div>
                                    </td>

                                    <td class="user-name-cell" style="min-width: 15rem;">
                                        <div class="c-value"><%= user&.name || "Unknown Student" %></div>
                                        <div class="mt-1 text-xs text-slate-500">
                                            <% if user&.email.present? %>
                                                Email: <%= user.email %>
                                            <% else %>
                                                Email: â€”
                                            <% end %>
                                        </div>
                                    </td>

                                    <td class="user-track-cell" style="min-width: 14rem;">
                                        <div class="role-badge track inline-flex track-badge-clickable" id="track_badge_<%= student.student_id %>" tabindex="0" style="cursor:pointer;"><%= track_label %></div>
                                        <div class="mt-2 c-select-wrapper" id="track_select_wrapper_<%= student.student_id %>" style="display:none;">
                                            <%= select_tag "track_updates[#{student.student_id}]",
                                                    options_for_select(track_select_options, track_key),
                                                    class: "c-select track-select w-full",
                                                    data: {
                                                        student_id: student.student_id,
                                                        original_track: track_key,
                                                        original_track_name: track_label,
                                                        student_name: user&.name || "Student ##{student.student_id}"
                                                    },
                                                    id: "track_select_#{student.student_id}" %>
                                        </div>
                                    </td>

                                    <td class="user-track-cell" style="min-width: 14rem;">
                                        <div class="role-badge track inline-flex assignment-group-badge-clickable" id="assignment_group_badge_<%= student.student_id %>" tabindex="0" style="cursor:pointer;"><%= assignment_group_label %></div>
                                        <div class="mt-2 c-select-wrapper" id="assignment_group_select_wrapper_<%= student.student_id %>" style="display:none;">
                                            <%= select_tag "assignment_group_updates[#{student.student_id}]",
                                                    options_for_select(@assignment_group_select_options, assignment_group_value),
                                                    class: "c-select assignment-group-select w-full",
                                                    data: {
                                                        student_id: student.student_id,
                                                        original_assignment_group: assignment_group_value,
                                                        original_assignment_group_name: assignment_group_label,
                                                        student_name: user&.name || "Student ##{student.student_id}"
                                                    },
                                                    id: "assignment_group_select_#{student.student_id}" %>
                                        </div>
                                    </td>

                                    <td class="user-current-role-cell" style="min-width: 16rem;">
                                        <div class="role-badge advisor inline-flex advisor-badge-clickable" id="advisor_badge_<%= student.student_id %>" tabindex="0" style="cursor:pointer;"><%= current_advisor_name %></div>
                                        <div class="mt-2 c-select-wrapper" id="advisor_select_wrapper_<%= student.student_id %>" style="display:none;">
                                            <%= select_tag "advisor_updates[#{student.student_id}]",
                                                    options_for_select(@advisor_select_options, current_advisor_id),
                                                    class: "c-select advisor-select w-full",
                                                    data: {
                                                        student_id: student.student_id,
                                                        original_advisor: current_advisor_id,
                                                        original_advisor_name: current_advisor_name,
                                                        student_name: user&.name || "Student ##{student.student_id}"
                                                    },
                                                    id: "advisor_select_#{student.student_id}" %>
                                        </div>
                                    </td>

                                    <td class="user-actions-cell" style="min-width: 12rem;">
                                        <span class="c-change-indicator" data-student-id="<%= student.student_id %>">
                                            No changes
                                        </span>
                                    </td>
                                </tr>
                            <% end %>
                        </tbody>
                    </table>
                </div>

                                <div class="c-toolbar mt-6">
                                    <div class="c-toolbar__row items-center w-full gap-3 justify-end">
                                        <div class="flex-1">
                                            <div class="text-sm text-slate-600" id="student-changes-summary" style="display: none;">
                                                <span id="student-changes-count" class="c-change-indicator changed">0 changes pending</span>
                                            </div>
                                        </div>
                                        <div class="flex flex-wrap items-center gap-3">
                                            <%= link_to "Cancel", admin_dashboard_path, class: tailwind_button_classes(:secondary) %>
                                            <%= form.submit "Save Changes", class: tailwind_button_classes(:primary), id: "advisor-save-btn", disabled: true %>
                                        </div>
                                    </div>
                                </div>
            <% end %>
        <% else %>
            <div class="c-card c-card--flush c-table-wrapper">
                <table class="c-table">
                    <thead>
                        <tr>
                            <th class="table-header-avatar">Avatar</th>
                            <th class="table-header-name" style="min-width: 15rem;">Student</th>
                            <th class="table-header-track" style="min-width: 8rem;">Track</th>
                            <th class="table-header-current-role">Advisor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% @students.each do |student| %>
                            <% user = student.user %>
                            <% current_advisor = student.advisor %>
                            <tr class="c-table-row">
                                <td class="user-avatar-cell">
                                    <div class="c-table-avatar"
                                             <% if user&.avatar_url.present? %>
                                                 style="background-image: url('<%= user.avatar_url %>');"
                                             <% end %>>
                                        <% unless user&.avatar_url.present? %>ðŸ‘¤<% end %>
                                    </div>
                                </td>
                                <td class="user-name-cell" style="min-width: 15rem;">
                                    <div class="c-value"><%= user&.name || "Unknown Student" %></div>
                                    <div class="mt-1 text-xs text-slate-500">
                                        <% if user&.email.present? %>
                                            Email: <%= user.email %>
                                        <% else %>
                                            Email: â€”
                                        <% end %>
                                    </div>
                                </td>
                                <td class="user-track-cell" style="min-width: 8rem;">
                                    <span class="role-badge track"><%= student.track.present? ? student.track.titleize : "Unassigned" %></span>
                                </td>
                                <td class="user-current-role-cell" style="min-width: 12rem;">
                                    <span class="role-badge advisor"><%= current_advisor&.display_name || "Unassigned" %></span>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        <% end %>
    </section>
</main>

<script>
    (function() {
        function initAdvisorManagement() {
            const form = document.getElementById('advisor-management-form');
            if (!form || form.dataset.initialized === 'true') {
                return;
            }

            form.dataset.initialized = 'true';

            const saveButton = document.getElementById('advisor-save-btn');
            const changesSummary = document.getElementById('student-changes-summary');
            const changesCount = document.getElementById('student-changes-count');

            if (!saveButton || !changesSummary || !changesCount) {
                return;
            }

            const changeRegistry = new Map();

            function indicatorFor(studentId) {
                return form.querySelector(`.c-change-indicator[data-student-id="${studentId}"]`);
            }

            function rowFor(studentId) {
                return form.querySelector(`.c-table-row[data-student-row="${studentId}"]`);
            }

            function updateIndicator(studentId) {
                const indicator = indicatorFor(studentId);
                if (!indicator) {
                    return;
                }

                const row = rowFor(studentId);
                const entry = changeRegistry.get(studentId);
                const messages = [];

                if (entry && entry.advisor) {
                    messages.push(`Advisor: ${entry.advisor.from} â†’ ${entry.advisor.to}`);
                }

                if (entry && entry.track) {
                    messages.push(`Track: ${entry.track.from} â†’ ${entry.track.to}`);
                }

                if (entry && entry.assignmentGroup) {
                    messages.push(`Group: ${entry.assignmentGroup.from} â†’ ${entry.assignmentGroup.to}`);
                }

                if (messages.length > 0) {
                    indicator.textContent = messages.join(' | ');
                    indicator.className = 'c-change-indicator changed';
                    if (row) {
                        row.classList.add('c-table-row--changed');
                    }
                } else {
                    indicator.textContent = 'No changes';
                    indicator.className = 'c-change-indicator';
                    if (row) {
                        row.classList.remove('c-table-row--changed');
                    }
                }
            }

            function updateUI() {
                const changeCount = changeRegistry.size;

                if (changeCount > 0) {
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.cursor = 'pointer';
                    changesSummary.style.display = 'block';
                    changesCount.textContent = `${changeCount} student${changeCount === 1 ? '' : 's'} pending updates`;
                    saveButton.setAttribute('data-has-changes', 'true');
                } else {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.5';
                    saveButton.style.cursor = 'not-allowed';
                    changesSummary.style.display = 'none';
                    saveButton.removeAttribute('data-has-changes');
                }
            }

            function setChange(studentId, type, payload) {
                const existing = changeRegistry.get(studentId) || { studentName: (payload && payload.studentName) || `Student ${studentId}`, advisor: null, track: null, assignmentGroup: null };

                if (payload) {
                    existing.studentName = payload.studentName || existing.studentName;
                    existing[type] = payload;
                } else {
                    existing[type] = null;
                }

                if (!existing.advisor && !existing.track && !existing.assignmentGroup) {
                    changeRegistry.delete(studentId);
                } else {
                    changeRegistry.set(studentId, existing);
                }

                updateIndicator(studentId);
                updateUI();
            }

            form.querySelectorAll('.advisor-select').forEach(select => {
                const studentId = select.dataset.studentId;
                const originalAdvisor = select.dataset.originalAdvisor || '';
                const originalName = select.dataset.originalAdvisorName || 'Unassigned';
                const studentName = select.dataset.studentName || `Student ${studentId}`;

                const badge = document.getElementById(`advisor_badge_${studentId}`);
                const selectWrapper = document.getElementById(`advisor_select_wrapper_${studentId}`);

                select.value = originalAdvisor;

                if (badge && selectWrapper) {
                    badge.addEventListener('click', function() {
                        badge.style.display = 'none';
                        selectWrapper.style.display = '';
                        select.focus();
                    });

                    badge.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            badge.click();
                            e.preventDefault();
                        }
                    });
                }

                function hideAdvisorSelectAndUpdateBadge() {
                    if (!badge || !selectWrapper) return;
                    const selectedOption = select.options[select.selectedIndex];
                    badge.textContent = selectedOption ? selectedOption.text.trim() : 'Unassigned';
                    badge.style.display = '';
                    selectWrapper.style.display = 'none';
                }

                select.addEventListener('change', function() {
                    const newAdvisor = this.value || '';
                    const selectedOption = this.options[this.selectedIndex];
                    const newAdvisorName = selectedOption ? selectedOption.text.trim() : 'Unassigned';

                    if (newAdvisor !== originalAdvisor) {
                        setChange(studentId, 'advisor', {
                            from: originalName,
                            to: newAdvisorName,
                            value: newAdvisor,
                            studentName: studentName
                        });
                    } else {
                        setChange(studentId, 'advisor', null);
                    }

                    hideAdvisorSelectAndUpdateBadge();
                });

                select.addEventListener('blur', function() {
                    setTimeout(hideAdvisorSelectAndUpdateBadge, 100);
                });
            });

            form.querySelectorAll('.track-select').forEach(select => {
                const studentId = select.dataset.studentId;
                const originalTrack = select.dataset.originalTrack || '';
                const originalTrackName = select.dataset.originalTrackName || 'Unassigned';
                const studentName = select.dataset.studentName || `Student ${studentId}`;

                const badge = document.getElementById(`track_badge_${studentId}`);
                const selectWrapper = document.getElementById(`track_select_wrapper_${studentId}`);

                select.value = originalTrack;

                if (badge && selectWrapper) {
                    badge.addEventListener('click', function() {
                        badge.style.display = 'none';
                        selectWrapper.style.display = '';
                        select.focus();
                    });

                    badge.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            badge.click();
                            e.preventDefault();
                        }
                    });
                }

                function hideTrackSelectAndUpdateBadge() {
                    if (!badge || !selectWrapper) return;
                    const selectedOption = select.options[select.selectedIndex];
                    badge.textContent = selectedOption ? selectedOption.text.trim() : 'Unassigned';
                    badge.style.display = '';
                    selectWrapper.style.display = 'none';
                }

                select.addEventListener('change', function() {
                    const newTrack = this.value || '';
                    const selectedOption = this.options[this.selectedIndex];
                    const newTrackName = selectedOption ? selectedOption.text.trim() : 'Unassigned';

                    if (newTrack !== originalTrack) {
                        setChange(studentId, 'track', {
                            from: originalTrackName,
                            to: newTrackName,
                            value: newTrack,
                            studentName: studentName
                        });
                    } else {
                        setChange(studentId, 'track', null);
                    }

                    hideTrackSelectAndUpdateBadge();
                });

                select.addEventListener('blur', function() {
                    setTimeout(hideTrackSelectAndUpdateBadge, 100);
                });
            });

            form.querySelectorAll('.assignment-group-select').forEach(select => {
                const studentId = select.dataset.studentId;
                const originalGroup = select.dataset.originalAssignmentGroup || '';
                const originalGroupName = select.dataset.originalAssignmentGroupName || 'Unassigned';
                const studentName = select.dataset.studentName || `Student ${studentId}`;

                const badge = document.getElementById(`assignment_group_badge_${studentId}`);
                const selectWrapper = document.getElementById(`assignment_group_select_wrapper_${studentId}`);

                select.value = originalGroup;

                if (badge && selectWrapper) {
                    badge.addEventListener('click', function() {
                        badge.style.display = 'none';
                        selectWrapper.style.display = '';
                        select.focus();
                    });

                    badge.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            badge.click();
                            e.preventDefault();
                        }
                    });
                }

                function hideGroupSelectAndUpdateBadge() {
                    if (!badge || !selectWrapper) return;
                    const selectedOption = select.options[select.selectedIndex];
                    badge.textContent = selectedOption ? selectedOption.text.trim() : 'Unassigned';
                    badge.style.display = '';
                    selectWrapper.style.display = 'none';
                }

                select.addEventListener('change', function() {
                    const newGroup = this.value || '';
                    const selectedOption = this.options[this.selectedIndex];
                    const newGroupName = selectedOption ? selectedOption.text.trim() : 'Unassigned';

                    if (newGroup !== originalGroup) {
                        setChange(studentId, 'assignmentGroup', {
                            from: originalGroupName,
                            to: newGroupName,
                            value: newGroup,
                            studentName: studentName
                        });
                    } else {
                        setChange(studentId, 'assignmentGroup', null);
                    }

                    hideGroupSelectAndUpdateBadge();
                });

                select.addEventListener('blur', function() {
                    setTimeout(hideGroupSelectAndUpdateBadge, 100);
                });
            });

            saveButton.addEventListener('click', function(e) {
                if (this.disabled) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('No changes to save. Please make student updates first.');
                }
            });

            form.addEventListener('submit', function(e) {
                if (changeRegistry.size === 0) {
                    alert('No changes to save.');
                    e.preventDefault();
                    return false;
                }

                const changeLines = [];
                let fieldChangeCount = 0;

                changeRegistry.forEach(entry => {
                    if (entry.advisor) {
                        changeLines.push(`â€¢ ${entry.studentName}: Advisor ${entry.advisor.from} â†’ ${entry.advisor.to}`);
                        fieldChangeCount += 1;
                    }
                    if (entry.track) {
                        changeLines.push(`â€¢ ${entry.studentName}: Track ${entry.track.from} â†’ ${entry.track.to}`);
                        fieldChangeCount += 1;
                    }
                    if (entry.assignmentGroup) {
                        changeLines.push(`â€¢ ${entry.studentName}: Group ${entry.assignmentGroup.from} â†’ ${entry.assignmentGroup.to}`);
                        fieldChangeCount += 1;
                    }
                });

                if (fieldChangeCount === 0) {
                    alert('No changes to save.');
                    e.preventDefault();
                    return false;
                }

                const confirmMessage = `You are about to apply ${fieldChangeCount} change${fieldChangeCount === 1 ? '' : 's'} across ${changeRegistry.size} student${changeRegistry.size === 1 ? '' : 's'}:\n\n${changeLines.join('\n')}\n\nProceed?`;

                if (!confirm(confirmMessage)) {
                    e.preventDefault();
                    return false;
                }

                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';
                return true;
            });

            updateUI();
        }

        document.addEventListener('turbo:load', initAdvisorManagement);
        document.addEventListener('DOMContentLoaded', initAdvisorManagement);
    })();
</script>
